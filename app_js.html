<script>
  /* ================================================================
     App Financeiro do Motorista  Client-side JS
     ================================================================ */

  //  State 
  var APP = {
    categories: [],
    config: {},
    month: new Date().getMonth() + 1,
    year: new Date().getFullYear(),
    email: '',
    theme: 'dark',
    route: 'dashboard',
    routeToken: 0,
    txOptimistic: {},
    txPage: 1,
    txPageSize: 20, // Aumentado de 15 para 20
    warmupDone: {},
    bgPreloadToken: 0,
    accountsLastHtml: '',
    accountHiddenIds: {},
    dashboardLastData: null,
    viewSnapshots: {},

    // Performance Cache
    cache: {
      transactions: { data: null, timestamp: 0, ttl: 60000 },    // 1 min
      categories: { data: null, timestamp: 0, ttl: 300000 },     // 5 min
      config: { data: null, timestamp: 0, ttl: 300000 },         // 5 min
      dashboard: { data: null, timestamp: 0, ttl: 30000 },       // 30 seg
      installmentsDash: { data: null, timestamp: 0, ttl: 45000 }, // 45 seg
      accounts: { data: null, timestamp: 0, ttl: 120000 },       // 2 min
      reports: { data: null, timestamp: 0, ttl: 120000 },        // 2 min
      cartoes: { data: null, timestamp: 0, ttl: 30000 }          // 30 seg
    }
  };

  //  Cache Helpers 
  var CACHE_STORAGE_KEY = 'app.cache.v11';
  var CACHE_STORAGE_VERSION = '2026-02-10';
  var CACHE_PERSIST_DEBOUNCE_MS = 120;
  var VIEW_SNAPSHOT_STORAGE_KEY = 'app.view.snapshots.v1';
  var VIEW_SNAPSHOT_MAX_ENTRIES = 14;
  var VIEW_SNAPSHOT_MAX_HTML = 180000;
  var cachePersistTimer = null;
  var viewSnapshotPersistTimer = null;
  var RPC_INFLIGHT = {};

  var RPC_READ_ONLY = {
    getDashboard: true,
    listTransactions: true,
    listCategories: true,
    listAccounts: true,
    getConfig: true,
    getReport12Months: true,
    getInstallmentDetails: true,
    listBankLogosFiles: true,
    getBankLogosBase64: true,
    bootstrap: true,
    syncCartoes: true,
    listCartoes: true
  };

  var RPC_CACHE_CONFIG = {
    getDashboard: {
      base: 'dashboard',
      ttl: 30000,
      keyFn: function (args) {
        var month = args && args.month ? args.month : APP.month;
        var year = args && args.year ? args.year : APP.year;
        return year + '-' + String(month).padStart(2, '0');
      },
      staleWhileRevalidate: true
    },
    listTransactions: {
      base: 'transactions',
      ttl: 45000,
      keyFn: function (args) {
        args = args || {};
        var resolvedPageSize = args.pageSize || args.limit || APP.txPageSize;
        return JSON.stringify({
          year: args.year || APP.year,
          month: args.month || APP.month,
          page: args.page || 1,
          pageSize: resolvedPageSize,
          limit: args.limit || '',
          type: args.type || '',
          categoryId: args.categoryId || '',
          search: String(args.search || '').trim().toLowerCase()
        });
      },
      staleWhileRevalidate: true
    },
    listCategories: {
      base: 'categories',
      ttl: 300000,
      keyFn: function (args) { return args && args.includeInactive ? 'all' : 'active'; },
      staleWhileRevalidate: true
    },
    listAccounts: {
      base: 'accounts',
      ttl: 120000,
      keyFn: function (args) { return args && args.includeInactive ? 'list' : 'active'; },
      staleWhileRevalidate: true
    },
    getConfig: {
      base: 'config',
      ttl: 300000,
      keyFn: function () { return 'global'; },
      staleWhileRevalidate: true
    },
    getReport12Months: {
      base: 'reports',
      ttl: 180000,
      keyFn: function () { return '12m'; },
      staleWhileRevalidate: true
    },
    getInstallmentDetails: {
      base: 'installmentsDash',
      ttl: 60000,
      keyFn: function (args) { return 'detail:' + (args && args.grupoId ? args.grupoId : ''); },
      staleWhileRevalidate: false
    },
    bootstrap: {
      base: 'cartoes',
      ttl: 30000,
      keyFn: function () { return 'bootstrap'; },
      staleWhileRevalidate: true
    },
    syncCartoes: {
      base: 'cartoes',
      ttl: 20000,
      keyFn: function (args) { return 'sync:' + (args || ''); },
      staleWhileRevalidate: true
    },
    listCartoes: {
      base: 'cartoes',
      ttl: 25000,
      keyFn: function (args) { return 'list:' + (args || ''); },
      staleWhileRevalidate: true
    }
  };

  var RPC_INVALIDATE_MAP = {
    createTransaction: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    updateTransaction: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    deleteTransaction: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    markInstallmentAsPaid: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    markMultipleAsPaid: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    cancelInstallment: ['transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts', 'cartoes'],
    createCategory: ['categories', 'transactions', 'dashboard', 'reports'],
    updateCategory: ['categories', 'transactions', 'dashboard', 'reports'],
    deleteCategory: ['categories', 'transactions', 'dashboard', 'reports'],
    reorderCategories: ['categories'],
    createAccount: ['accounts', 'transactions', 'dashboard', 'reports'],
    updateAccount: ['accounts', 'transactions', 'dashboard', 'reports'],
    deactivateAccount: ['accounts', 'transactions', 'dashboard', 'reports'],
    saveConfig: ['config', 'dashboard'],
    setTheme: ['config'],
    clearAllServerCache: ['transactions', 'categories', 'config', 'dashboard', 'installmentsDash', 'accounts', 'reports', 'cartoes'],
    saveCartao:     ['cartoes'],
    archiveCartao:  ['cartoes'],
    deleteCartaoCascade: ['cartoes', 'transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts'],
    deletePaidFaturasHistory: ['cartoes'],
    deleteFaturaById: ['cartoes'],
    gerarFaturaMes: ['cartoes'],
    pagarFatura:    ['cartoes', 'transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts'],
    pagarFaturaAtualSaldo: ['cartoes', 'transactions', 'dashboard', 'installmentsDash', 'reports', 'accounts']
  };

  function deepClone_(value) {
    if (value === null || value === undefined) return value;
    try {
      return JSON.parse(JSON.stringify(value));
    } catch (e) {
      return value;
    }
  }

  function ensureCacheBucket_(base) {
    if (!APP.cache[base]) APP.cache[base] = { data: {}, ttl: 60000 };
    if (!APP.cache[base].data || typeof APP.cache[base].data !== 'object') APP.cache[base].data = {};
    if (!APP.cache[base].ttl || APP.cache[base].ttl < 0) APP.cache[base].ttl = 60000;
    return APP.cache[base];
  }

  function normalizeCacheKey_(key) {
    if (!key) return null;
    if (typeof key === 'string') return { base: key, key: '*' };
    return { base: key.base, key: key.key || '*' };
  }

  function persistCacheSoon_() {
    clearTimeout(cachePersistTimer);
    cachePersistTimer = setTimeout(function () {
      try {
        var payload = { version: CACHE_STORAGE_VERSION, cache: APP.cache };
        sessionStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(payload));
      } catch (e) {}
    }, CACHE_PERSIST_DEBOUNCE_MS);
  }

  function hydrateCache_() {
    try {
      var raw = sessionStorage.getItem(CACHE_STORAGE_KEY);
      if (!raw) return;
      var parsed = JSON.parse(raw);
      if (!parsed || parsed.version !== CACHE_STORAGE_VERSION || !parsed.cache) return;
      Object.keys(parsed.cache).forEach(function (base) {
        var incoming = parsed.cache[base];
        if (!incoming || typeof incoming !== 'object') return;
        APP.cache[base] = {
          ttl: incoming.ttl || (APP.cache[base] && APP.cache[base].ttl) || 60000,
          data: incoming.data && typeof incoming.data === 'object' ? incoming.data : {}
        };
      });
    } catch (e) {}
  }

  function getCached(key, options) {
    var normalized = normalizeCacheKey_(key);
    if (!normalized || !normalized.base) return null;
    var cache = ensureCacheBucket_(normalized.base);
    var entry = cache.data[normalized.key];
    if (!entry) return null;
    var allowStale = !!(options && options.allowStale);
    var ts = entry.ts || 0;
    if (allowStale || (Date.now() - ts) < cache.ttl) {
      return deepClone_(entry.value);
    }
    return null;
  }

  function setCached(key, data) {
    var normalized = normalizeCacheKey_(key);
    if (!normalized || !normalized.base) return;
    var cache = ensureCacheBucket_(normalized.base);
    cache.data[normalized.key] = { ts: Date.now(), value: deepClone_(data) };
    persistCacheSoon_();
  }

  function clearCached(key) {
    if (!key) {
      Object.keys(APP.cache).forEach(function (base) {
        ensureCacheBucket_(base).data = {};
      });
      persistCacheSoon_();
      return;
    }

    var normalized = normalizeCacheKey_(key);
    if (!normalized || !normalized.base) return;
    var cache = ensureCacheBucket_(normalized.base);
    if (normalized.key === '*') cache.data = {};
    else delete cache.data[normalized.key];
    persistCacheSoon_();
  }

  function cacheKey(base) {
    return { base: base, key: APP.year + '-' + String(APP.month).padStart(2, '0') };
  }

  function invalidateCachesForRpc_(fn) {
    var domains = RPC_INVALIDATE_MAP[fn] || [];
    domains.forEach(function (domain) { clearCached(domain); });
    if (domains.indexOf('cartoes') !== -1) {
      // Mantém dados atuais para evitar flicker e atualiza em background.
      if (typeof rpc === 'function') {
        rpc('listCartoes', 'ativos', function (res) {
          var cards = extractCardsList_(res);
          APP.cartoesBootData = APP.cartoesBootData || {};
          APP.cartoesBootData.cartoes = cards;
        }, null, true);
      }
    }
  }

  function getRpcCachePlan_(fn, args) {
    var plan = RPC_CACHE_CONFIG[fn];
    if (!plan) return null;
    ensureCacheBucket_(plan.base).ttl = plan.ttl;
    return {
      base: plan.base,
      key: plan.keyFn ? plan.keyFn(args || {}) : '*',
      staleWhileRevalidate: !!plan.staleWhileRevalidate
    };
  }

  function buildInFlightKey_(fn, arg1, arg2, token) {
    return fn + '|' + JSON.stringify(arg1 || null) + '|' + JSON.stringify(arg2 || null) + '|' + (token || '');
  }

  hydrateCache_();

  function hydrateViewSnapshots_() {
    try {
      var raw = sessionStorage.getItem(VIEW_SNAPSHOT_STORAGE_KEY);
      if (!raw) return;
      var parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') return;
      APP.viewSnapshots = parsed;
    } catch (e) {
      APP.viewSnapshots = {};
    }
  }

  function persistViewSnapshotsSoon_() {
    clearTimeout(viewSnapshotPersistTimer);
    viewSnapshotPersistTimer = setTimeout(function () {
      try {
        var keys = Object.keys(APP.viewSnapshots || {});
        if (keys.length > VIEW_SNAPSHOT_MAX_ENTRIES) {
          keys.sort(function (a, b) {
            var ta = (APP.viewSnapshots[a] && APP.viewSnapshots[a].ts) || 0;
            var tb = (APP.viewSnapshots[b] && APP.viewSnapshots[b].ts) || 0;
            return tb - ta;
          });
          keys.slice(VIEW_SNAPSHOT_MAX_ENTRIES).forEach(function (k) {
            delete APP.viewSnapshots[k];
          });
        }
        sessionStorage.setItem(VIEW_SNAPSHOT_STORAGE_KEY, JSON.stringify(APP.viewSnapshots || {}));
      } catch (e) {}
    }, CACHE_PERSIST_DEBOUNCE_MS);
  }

  function isMonthScopedRoute_(route) {
    return route === 'dashboard' || route === 'transactions' || route === 'installments' || route === 'maintenance';
  }

  function getRouteSnapshotKey_(route) {
    route = String(route || '').trim();
    if (!route) return '';
    if (!isMonthScopedRoute_(route)) return route;
    return route + ':' + APP.year + '-' + String(APP.month).padStart(2, '0');
  }

  function setRouteSnapshot_(route, html) {
    if (!route || !html) return;
    html = String(html);
    if (!html.trim()) return;
    if (html.length > VIEW_SNAPSHOT_MAX_HTML) return;
    if (!APP.viewSnapshots || typeof APP.viewSnapshots !== 'object') APP.viewSnapshots = {};
    APP.viewSnapshots[getRouteSnapshotKey_(route)] = { html: html, ts: Date.now() };
    persistViewSnapshotsSoon_();
  }

  function getRouteSnapshot_(route) {
    if (!APP.viewSnapshots || typeof APP.viewSnapshots !== 'object') return '';
    var entry = APP.viewSnapshots[getRouteSnapshotKey_(route)];
    if (!entry || !entry.html) return '';
    return String(entry.html);
  }

  function applyRouteSnapshot_(route, targetEl) {
    if (!targetEl) return false;
    var html = getRouteSnapshot_(route);
    if (!html) return false;
    targetEl.innerHTML = html;
    return true;
  }

  hydrateViewSnapshots_();

  var MONTH_NAMES = [
    '', 'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
    'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
  ];

  //  Loading indicator 
  var loadingCount = 0;
  var LOADING_DELAY_MS = 120;
  var bootRetryHandler_ = null;
  function setBootLoadingState_(visible, msg, showRetry, onRetry) {
    var overlay = document.getElementById('app-loading');
    if (!overlay) return;
    if (visible) overlay.classList.remove('hidden');
    else overlay.classList.add('hidden');

    var textEl = document.getElementById('app-loading-text');
    if (textEl) textEl.textContent = msg || 'Carregando...';

    var retryBtn = document.getElementById('app-loading-retry');
    if (retryBtn) {
      retryBtn.style.display = showRetry ? 'inline-flex' : 'none';
      if (bootRetryHandler_) retryBtn.removeEventListener('click', bootRetryHandler_);
      bootRetryHandler_ = null;
      if (showRetry && typeof onRetry === 'function') {
        bootRetryHandler_ = onRetry;
        retryBtn.addEventListener('click', bootRetryHandler_);
      }
    }
  }

  function showLoading(msg) {
    // Loading visual desabilitado por UX (sem overlay).
    // Mantido para compatibilidade com chamadas existentes.
    return;
  }

  function hideLoading() {
    loadingCount = 0;
    setBootLoadingState_(false, '', false);
  }

  function rpcPrefetch_(fn, args, timeoutMs) {
    return new Promise(function (resolve, reject) {
      var done = false;
      var timer = setTimeout(function () {
        if (done) return;
        done = true;
        reject('Timeout em ' + fn);
      }, timeoutMs || 25000);

      rpc(fn, args, function (data) {
        if (done) return;
        done = true;
        clearTimeout(timer);
        resolve(data);
      }, function (err) {
        if (done) return;
        done = true;
        clearTimeout(timer);
        reject(err || ('Erro em ' + fn));
      }, true);
    });
  }

  function isRetryablePreloadError_(errMsg) {
    var msg = String(errMsg || '').toLowerCase();
    return msg.indexOf('timeout') !== -1 ||
      msg.indexOf('comunicacao') !== -1 ||
      msg.indexOf('autenticacao') !== -1 ||
      msg.indexOf('temporar') !== -1;
  }

  function rpcPrefetchWithRetry_(task, maxAttempts) {
    maxAttempts = maxAttempts || 2;
    var attempt = 0;

    function runAttempt() {
      attempt += 1;
      return rpcPrefetch_(task.fn, task.args, 30000).catch(function (err) {
        if (attempt >= maxAttempts || !isRetryablePreloadError_(err)) throw err;
        return new Promise(function (resolve) {
          setTimeout(resolve, 250 * attempt);
        }).then(runAttempt);
      });
    }

    return runAttempt();
  }

  function getMonthYearByOffset_(baseMonth, baseYear, offset) {
    var m = baseMonth + offset;
    var y = baseYear;
    while (m < 1) {
      m += 12;
      y -= 1;
    }
    while (m > 12) {
      m -= 12;
      y += 1;
    }
    return { month: m, year: y };
  }

  function periodKeyFrom_(month, year) {
    return year + '-' + String(month).padStart(2, '0');
  }

  function preloadInitialCache_(options) {
    options = options || {};
    var rangeRadius = typeof options.rangeRadius === 'number' ? options.rangeRadius : 0;
    var concurrency = typeof options.concurrency === 'number' ? options.concurrency : 4;
    var baseMonth = options.baseMonth || APP.month;
    var baseYear = options.baseYear || APP.year;
    var showProgress = !!options.showProgress;
    var progressPrefix = options.progressPrefix || 'Carregando dados do sistema';
    var includeShared = options.includeShared !== false;
    var txCommon = { type: '', categoryId: '', search: '', page: 1 };
    var periods = [];
    for (var offset = -rangeRadius; offset <= rangeRadius; offset++) {
      periods.push(getMonthYearByOffset_(baseMonth, baseYear, offset));
    }

    var tasks = [];
    periods.forEach(function (period) {
      var periodKey = periodKeyFrom_(period.month, period.year);
      var commonMonthYear = { month: period.month, year: period.year };
      var isCurrentPeriod = (period.month === APP.month && period.year === APP.year);
      tasks.push({ id: 'dashboard:' + periodKey, label: 'Dashboard ' + periodKey, fn: 'getDashboard', args: commonMonthYear, periodKey: periodKey, critical: isCurrentPeriod });
      tasks.push({ id: 'transactionsPage:' + periodKey, label: 'Lançamentos página ' + periodKey, fn: 'listTransactions', args: Object.assign({}, commonMonthYear, txCommon, { pageSize: APP.txPageSize }), periodKey: periodKey, critical: isCurrentPeriod });
      tasks.push({ id: 'transactions100:' + periodKey, label: 'Lançamentos 100 ' + periodKey, fn: 'listTransactions', args: Object.assign({}, commonMonthYear, txCommon, { pageSize: 100 }), periodKey: periodKey, critical: false });
      tasks.push({ id: 'transactions1000:' + periodKey, label: 'Lançamentos 1000 ' + periodKey, fn: 'listTransactions', args: Object.assign({}, commonMonthYear, txCommon, { pageSize: 1000 }), periodKey: periodKey, critical: isCurrentPeriod });
    });

    if (includeShared) {
      tasks = tasks.concat([
        { id: 'categories', label: 'Categorias', fn: 'listCategories', args: { includeInactive: true }, critical: true },
        { id: 'accounts', label: 'Contas', fn: 'listAccounts', args: { includeInactive: true }, critical: true },
        { id: 'config', label: 'Configurações', fn: 'getConfig', args: null, critical: true },
        { id: 'reports', label: 'Relatórios', fn: 'getReport12Months', args: null, critical: false },
        { id: 'logos', label: 'Logos', fn: 'listBankLogosFiles', args: null, critical: false },
        { id: 'cartoes_boot', label: 'Cartões', fn: 'bootstrap', args: null, critical: false }
      ]);
    }

    var completed = 0;
    var total = tasks.length;
    var results = {};

    if (showProgress) setBootLoadingState_(true, progressPrefix + ' (0/' + total + ')...', false);

    return new Promise(function (resolve, reject) {
      var pending = total;
      var running = 0;
      var cursor = 0;
      var failed = [];
      var failedCritical = [];

      function finalizeOne(task, err, data) {
        if (!err) {
          results[task.id] = data;
        } else {
          var item = { task: task.label, err: err, critical: !!task.critical };
          failed.push(item);
          if (task.critical) failedCritical.push(item);
        }
        completed += 1;
        if (showProgress) setBootLoadingState_(true, progressPrefix + ' (' + completed + '/' + total + ')...', false);
        pending -= 1;
        running -= 1;

        if (pending === 0) {
          // Não bloqueia o boot por falha de preload: a tela carrega e busca sob demanda.
          // Isso evita travar a entrada do app por instabilidade pontual de uma RPC.
          resolve({ results: results, failed: failed, failedCritical: failedCritical });
          return;
        }
        pump();
      }

      function pump() {
        while (running < concurrency && cursor < tasks.length) {
          (function (task) {
            running += 1;
            rpcPrefetchWithRetry_(task, 2).then(function (data) {
              finalizeOne(task, null, data);
            }).catch(function (err) {
              finalizeOne(task, err, null);
            });
          })(tasks[cursor]);
          cursor += 1;
        }
      }

      pump();
    }).then(function (payload) {
      var localResults = payload && payload.results ? payload.results : {};
      var failed = payload && payload.failed ? payload.failed : [];
      var failedCritical = payload && payload.failedCritical ? payload.failedCritical : [];
      if (localResults.categories) APP.categories = localResults.categories.filter(function (c) { return c.active; });
      if (localResults.accounts) APP.accounts = localResults.accounts || [];
      if (localResults.config) APP.config = localResults.config || {};
      // Armazena snapshot de cartões para render instantâneo ao navegar
      if (localResults.cartoes_boot && localResults.cartoes_boot.cartoes) {
        APP.cartoesBootData = localResults.cartoes_boot;
      }
      var currentPeriodKey = periodKeyFrom_(APP.month, APP.year);
      var previewKey = 'transactions1000:' + currentPeriodKey;
      if (localResults[previewKey] && localResults[previewKey].items) {
        APP.txPreviewSource = localResults[previewKey].items;
      } else {
        var cachedPreview = getCached({
          base: 'transactions',
          key: JSON.stringify({
            year: APP.year,
            month: APP.month,
            page: 1,
            pageSize: 1000,
            limit: '',
            type: '',
            categoryId: '',
            search: ''
          })
        });
        if (cachedPreview && cachedPreview.items) APP.txPreviewSource = cachedPreview.items;
      }
      if (!APP.warmupDone) APP.warmupDone = {};
      periods.forEach(function (period) {
        var key = periodKeyFrom_(period.month, period.year);
        var hasDash = !!localResults['dashboard:' + key];
        var hasTx = !!localResults['transactionsPage:' + key];
        if (hasDash && hasTx) APP.warmupDone[key] = true;
      });
      if (failed.length) {
        console.warn('Preload parcial concluído. Falhas não críticas:', failed);
      }
      if (failedCritical.length) {
        console.warn('Preload com falhas críticas (modo tolerante):', failedCritical);
      }
    });
  }

  function buildOffsetWave_(radius) {
    var offsets = [];
    for (var i = 1; i <= radius; i++) {
      offsets.push(-i);
      offsets.push(i);
    }
    return offsets;
  }

  function startBackgroundPreloadWindow_(radius) {
    radius = Math.max(0, parseInt(radius || 0, 10));
    if (!radius) return;
    APP.bgPreloadToken = (APP.bgPreloadToken || 0) + 1;
    var token = APP.bgPreloadToken;
    var baseMonth = APP.month;
    var baseYear = APP.year;
    var offsets = buildOffsetWave_(radius);
    var idx = 0;

    function next() {
      if (token !== APP.bgPreloadToken) return;
      if (idx >= offsets.length) return;
      var period = getMonthYearByOffset_(baseMonth, baseYear, offsets[idx]);
      idx += 1;
      var periodKey = periodKeyFrom_(period.month, period.year);
      if (APP.warmupDone && APP.warmupDone[periodKey]) {
        next();
        return;
      }
      preloadInitialCache_({
        baseMonth: period.month,
        baseYear: period.year,
        rangeRadius: 0,
        includeShared: false,
        showProgress: false,
        concurrency: 2
      }).finally(function () {
        setTimeout(next, 10);
      });
    }

    setTimeout(next, 10);
  }

  //  RPC Wrapper 
  function normalizeRpcResult_(result) {
    var parsed = result;
    if (typeof parsed === 'string') {
      var txt = parsed.trim();
      var looksJson = (txt.charAt(0) === '{' && txt.charAt(txt.length - 1) === '}') ||
        (txt.charAt(0) === '[' && txt.charAt(txt.length - 1) === ']');
      if (looksJson) {
        try { parsed = JSON.parse(txt); } catch (e) {}
      }
    }
    if (parsed && typeof parsed === 'object' && parsed.ok === false) {
      return {
        isError: true,
        code: (parsed.code || (parsed.error && parsed.error.code) || ''),
        message: (parsed.error && parsed.error.message) || parsed.message || 'Erro desconhecido'
      };
    }
    var data;
    if (parsed && typeof parsed === 'object' && Object.prototype.hasOwnProperty.call(parsed, 'data')) {
      data = parsed.data;
    } else {
      data = parsed;
    }
    return { isError: false, data: data };
  }

  function rpc(fn, args, onSuccess, onError, skipLoading) {
    var sessionToken = getAuthSessionToken();
    var plan = RPC_READ_ONLY[fn] ? getRpcCachePlan_(fn, args) : null;
    var hadCachedResponse = false;

    if (plan) {
      var cached = getCached({ base: plan.base, key: plan.key });
      if (cached !== null) {
        hadCachedResponse = true;
        if (onSuccess) onSuccess(cached);
        if (!plan.staleWhileRevalidate) return;
        skipLoading = true;
      }
    }

    var inFlightKey = null;
    if (RPC_READ_ONLY[fn]) {
      inFlightKey = buildInFlightKey_(fn, args, null, sessionToken);
      var pending = RPC_INFLIGHT[inFlightKey];
      if (pending) {
        pending.push({ onSuccess: onSuccess, onError: onError });
        return;
      }
      RPC_INFLIGHT[inFlightKey] = [];
    }

    var loadingShown = false;
    var loadingTimer = null;
    if (!skipLoading) {
      loadingTimer = setTimeout(function () {
        loadingShown = true;
        showLoading();
      }, LOADING_DELAY_MS);
    }

    var runner = google.script.run
      .withSuccessHandler(function (result) {
        if (!skipLoading && loadingTimer) clearTimeout(loadingTimer);
        if (!skipLoading && loadingShown) hideLoading();
        var normalized = normalizeRpcResult_(result);
        if (normalized.isError) {
          var msg = normalized.message;
          if (normalized.code === 'AUTH_REQUIRED') {
            forceBackToLogin();
            return;
          }
          if (inFlightKey && RPC_INFLIGHT[inFlightKey]) {
            RPC_INFLIGHT[inFlightKey].forEach(function (waiter) {
              if (waiter.onError) waiter.onError(msg);
            });
            delete RPC_INFLIGHT[inFlightKey];
          }
          if (onError) onError(msg);
          else toast(msg, 'error');
        } else {
          var data = normalized.data;
          if (plan) setCached({ base: plan.base, key: plan.key }, data);
          if (RPC_INVALIDATE_MAP[fn]) invalidateCachesForRpc_(fn);

          if (inFlightKey && RPC_INFLIGHT[inFlightKey]) {
            RPC_INFLIGHT[inFlightKey].forEach(function (waiter) {
              if (waiter.onSuccess) waiter.onSuccess(data);
            });
            delete RPC_INFLIGHT[inFlightKey];
          }

          if (onSuccess) {
            if (!hadCachedResponse || plan) onSuccess(data);
          }
        }
      })
      .withFailureHandler(function (err) {
        if (!skipLoading && loadingTimer) clearTimeout(loadingTimer);
        if (!skipLoading && loadingShown) hideLoading();
        var msg = err && err.message ? err.message : 'Erro de comunicacao';
        if (inFlightKey && RPC_INFLIGHT[inFlightKey]) {
          RPC_INFLIGHT[inFlightKey].forEach(function (waiter) {
            if (waiter.onError) waiter.onError(msg);
          });
          delete RPC_INFLIGHT[inFlightKey];
        }
        if (onError) onError(msg);
        else toast(msg, 'error');
      });

    runner.authRpc(fn, args, null, sessionToken);
  }
  // Wrapper for functions that need 2 args (updateTransaction)
  function rpc2(fn, arg1, arg2, onSuccess, onError, skipLoading) {
    var sessionToken = getAuthSessionToken();
    var loadingShown = false;
    var loadingTimer = null;
    if (!skipLoading) {
      loadingTimer = setTimeout(function () {
        loadingShown = true;
        showLoading();
      }, LOADING_DELAY_MS);
    }

    google.script.run
      .withSuccessHandler(function (result) {
        if (!skipLoading && loadingTimer) clearTimeout(loadingTimer);
        if (!skipLoading && loadingShown) hideLoading();
        var normalized = normalizeRpcResult_(result);
        if (normalized.isError) {
          var msg = normalized.message;
          if (normalized.code === 'AUTH_REQUIRED') {
            forceBackToLogin();
            return;
          }
          if (onError) onError(msg);
          else toast(msg, 'error');
        } else {
          if (RPC_INVALIDATE_MAP[fn]) invalidateCachesForRpc_(fn);
          if (onSuccess) onSuccess(normalized.data);
        }
      })
      .withFailureHandler(function (err) {
        if (!skipLoading && loadingTimer) clearTimeout(loadingTimer);
        if (!skipLoading && loadingShown) hideLoading();
        var msg = err && err.message ? err.message : 'Erro de comunicacao';
        if (onError) onError(msg);
        else toast(msg, 'error');
      }).authRpc(fn, arg1, arg2, sessionToken);
  }

  function getAuthSessionToken() {
    var raw = sessionStorage.getItem('auth.sessionToken') || localStorage.getItem('auth.sessionToken');
    if (!raw) return '';
    try {
      var parsed = JSON.parse(raw);
      if (!parsed.token || !parsed.expiresAt || parsed.expiresAt < Date.now()) return '';
      return parsed.token;
    } catch (e) {
      return '';
    }
  }

  function forceBackToLogin() {
    try {
      sessionStorage.removeItem('auth.sessionToken');
      localStorage.removeItem('auth.sessionToken');
      localStorage.removeItem('auth.refreshToken');
      localStorage.removeItem('auth.profile');
    } catch (e) {}
    var base = window.APP_BASE_URL || window.location.href;
    window.location.replace(base);
  }
  // Toast 
  function toast(msg, type) {
    type = type || 'info';
    var container = document.getElementById('toast-container');
    var el = document.createElement('div');
    el.className = 'toast toast-' + type;
    el.textContent = msg;
    container.appendChild(el);
    setTimeout(function () { el.remove(); }, 3500);
  }

  //  Format helpers 
  function fmtCurrency(v) {
    var n = parseFloat(v) || 0;
    return 'R$ ' + n.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  function fmtMonthLabel(m, y) {
    return MONTH_NAMES[m] + ' ' + y;
  }

  function escapeHtml_(value) {
    return String(value || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function normalizeMojibakeText_(value) { return String(value || ''); }
  function fixMojibakeTextNodes_() {}
  function startMojibakeGuard_() {}

  function renderSidebarUser_(profile, fallbackEmail) {
    var emailEl = document.getElementById('user-email');
    if (!emailEl) return;
    var name = (profile && (profile.name || profile.username)) || 'Usuario';
    var userRef = (profile && (profile.username || profile.email)) || fallbackEmail || 'Sessao ativa';
    emailEl.innerHTML =
      '<div class="profile-line">' +
      '<span class="profile-avatar" aria-hidden="true">&#128100;</span>' +
      '<span class="profile-name" title="' + escapeHtml_(name) + '">' + escapeHtml_(name) + '</span>' +
      '</div>' +
      '<div class="profile-sub" title="' + escapeHtml_(userRef) + '">' + escapeHtml_(userRef) + '</div>';
  }

  //  Init 
  document.addEventListener('DOMContentLoaded', function () {
    function runBootPreload_() {
      setBootLoadingState_(true, 'Preparando cache inicial...', false);
      preloadInitialCache_({
        rangeRadius: 0,
        showProgress: true,
        progressPrefix: 'Preparando dados iniciais',
        concurrency: 4
      }).then(function () {
        updateMonthDisplay();
        var initialRoute = getRouteFromHash_();
        navigate(initialRoute || APP.route, { replaceHistory: true });
        hideLoading();
        startBackgroundPreloadWindow_(12);
      }).catch(function (preloadErr) {
        console.error(preloadErr);
        setBootLoadingState_(
          true,
          'Falha ao preparar dados iniciais. Toque em "Tentar novamente".',
          true,
          runBootPreload_
        );
      });
    }

    setBootLoadingState_(true, 'Inicializando sessão...', false);
    rpc('getInitData', null, function (data) {
      APP.categories = data.categories || [];
      APP.config = data.config || {};
      APP.month = data.month;
      APP.year = data.year;
      APP.email = data.email;
      APP.theme = data.theme || 'dark';

      applyTheme(APP.theme);
      if (window.AUTH_PROFILE) {
        renderSidebarUser_(window.AUTH_PROFILE, APP.email || 'Usuario autenticado');
      } else {
        renderSidebarUser_(null, APP.email || 'Usuario autenticado');
      }
      runBootPreload_();
    }, function (err) {
      setBootLoadingState_(true, 'Erro ao iniciar: ' + err, true, function () { location.reload(); });
    }, true);

    bindGlobalEvents();
    bindUrlRouteSync_();
  });

  //  Theme 
  function applyTheme(theme) {
    document.body.className = 'theme-' + theme;
    APP.theme = theme;
  }

  function toggleTheme() {
    var newTheme = APP.theme === 'dark' ? 'light' : 'dark';
    applyTheme(newTheme);
    rpc('setTheme', newTheme);
  }

  //  Month navigation 
  function updateMonthDisplay() {
    document.getElementById('month-display').textContent = fmtMonthLabel(APP.month, APP.year);
  }

  function runMonthChangePreload_(delta) {
    APP.bgPreloadToken = (APP.bgPreloadToken || 0) + 1; // cancela preload de janela anterior
    APP.month += delta;
    if (APP.month < 1) { APP.month = 12; APP.year--; }
    if (APP.month > 12) { APP.month = 1; APP.year++; }
    updateMonthDisplay();

    setBootLoadingState_(true, 'Carregando dados de ' + fmtMonthLabel(APP.month, APP.year) + '...', false);
    preloadInitialCache_({
      rangeRadius: 0,
      showProgress: true,
      progressPrefix: 'Carregando dados de ' + fmtMonthLabel(APP.month, APP.year),
      concurrency: 4
    }).then(function () {
      navigate(APP.route);
      hideLoading();
      startBackgroundPreloadWindow_(12);
    }).catch(function (err) {
      console.error(err);
      setBootLoadingState_(
        true,
        'Falha ao carregar o novo mês. Toque em "Tentar novamente".',
        true,
        function () { runMonthChangePreload_(0); }
      );
    });
  }

  function prevMonth() {
    runMonthChangePreload_(-1);
  }

  function nextMonth() {
    runMonthChangePreload_(1);
  }

  //  Sidebar & Navigation 
  function bindGlobalEvents() {
    // Menu toggle
    document.getElementById('menu-btn').addEventListener('click', function () {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebar-overlay').classList.add('active');
    });
    document.getElementById('sidebar-close').addEventListener('click', closeSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', closeSidebar);

    // Nav items
    document.querySelectorAll('.nav-item').forEach(function (item) {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        var route = this.getAttribute('data-route');
        navigate(route);
        closeSidebar();
      });
    });

    // Month nav
    document.getElementById('prev-month').addEventListener('click', prevMonth);
    document.getElementById('next-month').addEventListener('click', nextMonth);

    // Theme
    document.getElementById('btn-theme').addEventListener('click', toggleTheme);

    // Add transaction
    document.getElementById('btn-add-tx').addEventListener('click', function () {
      openTransactionModal();
    });

    // Modal close
    document.getElementById('modal-close').addEventListener('click', closeModal);
    document.getElementById('modal-overlay').addEventListener('click', function (e) {
      if (e.target === this) closeModal();
    });
  }

  function closeSidebar() {
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.remove('active');
  }

  function setRealtimeSyncState_(active, text) {
    var id = 'rt-sync-chip';
    var el = document.getElementById(id);
    if (!active) {
      if (el) el.remove();
      return;
    }
    if (!el) {
      el = document.createElement('div');
      el.id = id;
      el.style.position = 'fixed';
      el.style.right = '16px';
      el.style.bottom = '16px';
      el.style.zIndex = '220';
      el.style.padding = '10px 12px';
      el.style.borderRadius = '10px';
      el.style.border = '1px solid rgba(91,95,239,.45)';
      el.style.background = 'rgba(10,12,28,.92)';
      el.style.color = '#e8eaf0';
      el.style.fontSize = '12px';
      el.style.fontWeight = '600';
      el.style.display = 'flex';
      el.style.alignItems = 'center';
      el.style.gap = '8px';
      el.innerHTML = '<span style="width:12px;height:12px;border:2px solid rgba(91,95,239,.35);border-top-color:#6C63FF;border-radius:50%;display:inline-block;animation:spin .8s linear infinite"></span><span class="txt"></span>';
      document.body.appendChild(el);
    }
    var t = el.querySelector('.txt');
    if (t) t.textContent = text || 'Sincronizando...';
  }

  var ROUTE_TO_HASH_SLUG = {
    dashboard: 'dashboard',
    transactions: 'lancamentos',
    installments: 'parcelas',
    maintenance: 'reserva',
    categories: 'categorias',
    accounts: 'contas',
    cartoes: 'cartoes',
    reports: 'relatorios',
    settings: 'configuracoes'
  };

  var HASH_SLUG_TO_ROUTE = {
    dashboard: 'dashboard',
    lancamentos: 'transactions',
    lancamento: 'transactions',
    transactions: 'transactions',
    parcelas: 'installments',
    installments: 'installments',
    reserva: 'maintenance',
    maintenance: 'maintenance',
    categorias: 'categories',
    categories: 'categories',
    contas: 'accounts',
    accounts: 'accounts',
    cartoes: 'cartoes',
    cartao: 'cartoes',
    cards: 'cartoes',
    relatorios: 'reports',
    relatorio: 'reports',
    reports: 'reports',
    configuracoes: 'settings',
    configuracao: 'settings',
    settings: 'settings'
  };

  function normalizeRoute_(route) {
    var r = String(route || '').trim().toLowerCase();
    if (!r) return 'dashboard';
    if (HASH_SLUG_TO_ROUTE[r]) return HASH_SLUG_TO_ROUTE[r];
    return ROUTE_TO_HASH_SLUG[r] ? r : 'dashboard';
  }

  function getRouteFromHash_() {
    var raw = String(window.location.hash || '');
    if (!raw) return 'dashboard';
    var clean = raw.replace(/^#\/?/, '').split('?')[0].split('&')[0].trim().toLowerCase();
    if (!clean) return 'dashboard';
    return normalizeRoute_(clean);
  }

  function getHashForRoute_(route) {
    var normalized = normalizeRoute_(route);
    var slug = ROUTE_TO_HASH_SLUG[normalized] || 'dashboard';
    return '#/' + slug;
  }

  function syncRouteHash_(route, replaceHistory) {
    var targetHash = getHashForRoute_(route);
    if (window.location.hash === targetHash) return;
    if (replaceHistory) history.replaceState({ route: route }, '', targetHash);
    else history.pushState({ route: route }, '', targetHash);
  }

  function bindUrlRouteSync_() {
    if (APP._urlRouteBound) return;
    APP._urlRouteBound = true;
    window.addEventListener('hashchange', function () {
      var route = getRouteFromHash_();
      if (route === APP.route) return;
      navigate(route, { skipUrlSync: true });
    });
    window.addEventListener('popstate', function () {
      var route = getRouteFromHash_();
      if (route === APP.route) return;
      navigate(route, { skipUrlSync: true });
    });
  }

  function getActiveRouteToken_() {
    return APP.routeToken || 0;
  }

  function isRouteTokenValid_(token) {
    return token === getActiveRouteToken_();
  }

  function navigate(route, options) {
    options = options || {};
    route = normalizeRoute_(route);
    // Restaura topbar se estava na tela de cartões
    if (APP.route === 'cartoes' && route !== 'cartoes') {
      _cartoesRestoreTopbar();
      _cartoesModuleReady = false; // força rebuild completo na próxima entrada
    }

    APP.route = route;
    APP.routeToken = (APP.routeToken || 0) + 1;
    var routeToken = APP.routeToken;
    // Update active nav
    document.querySelectorAll('.nav-item').forEach(function (item) {
      item.classList.toggle('active', item.getAttribute('data-route') === route);
    });
    if (!options.skipUrlSync) {
      syncRouteHash_(route, !!options.replaceHistory);
    }

    switch (route) {
      case 'dashboard': renderDashboard(routeToken); break;
      case 'transactions': renderTransactions(routeToken); break;
      case 'installments': renderInstallmentsDashboard(routeToken); break;
      case 'maintenance': renderMaintenanceReserve(routeToken); break;
      case 'categories': renderCategories(routeToken); break;
      case 'accounts': renderAccounts(routeToken); break; // NOVO
      case 'cartoes':  renderCartoes(routeToken);  break;
      case 'reports': renderReports(routeToken); break;
      case 'settings': renderSettings(routeToken); break;
      default: renderDashboard(routeToken);
    }
    setTimeout(function () { warmupAppData_(false); }, 0);
  }

  function getPeriodCacheKey_() {
    return APP.year + '-' + String(APP.month).padStart(2, '0');
  }

  function warmupAppData_(force) {
    var periodKey = getPeriodCacheKey_();
    if (!force && APP.warmupDone && APP.warmupDone[periodKey]) return;
    if (!APP.warmupDone) APP.warmupDone = {};
    APP.warmupDone[periodKey] = true;

    rpc('getDashboard', { month: APP.month, year: APP.year }, function () {}, null, true);

    rpc('listTransactions', {
      month: APP.month,
      year: APP.year,
      type: '',
      categoryId: '',
      search: '',
      page: 1,
      pageSize: APP.txPageSize
    }, function () {}, null, true);

    // Consultas mais amplas usadas em outras telas (Reserva / Parcelas).
    rpc('listTransactions', {
      month: APP.month,
      year: APP.year,
      type: '',
      categoryId: '',
      search: '',
      page: 1,
      pageSize: 100
    }, function () {}, null, true);

    rpc('listTransactions', {
      month: APP.month,
      year: APP.year,
      type: '',
      categoryId: '',
      search: '',
      page: 1,
      pageSize: 1000
    }, function () {}, null, true);

    rpc('listCategories', { includeInactive: true }, function (cats) {
      if (!cats) return;
      APP.categories = cats.filter(function (c) { return c.active; });
      setCached({ base: 'categories', key: 'all' }, cats);
    }, null, true);

    rpc('listAccounts', { includeInactive: true }, function (accounts) {
      APP.accounts = accounts || [];
      setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    }, null, true);

    rpc('getConfig', null, function (config) {
      APP.config = config || {};
      setCached({ base: 'config', key: 'global' }, APP.config);
    }, null, true);

    rpc('getReport12Months', null, function (report) {
      setCached({ base: 'reports', key: '12m' }, report || []);
    }, null, true);

    // Warmup de lista de logos para evitar espera ao abrir Configuracoes
    rpc('listBankLogosFiles', null, function () {}, null, true);

    // Warmup de cartões para render instantâneo ao navegar para a tela
    rpc('bootstrap', null, function(data) {
      if (data && data.cartoes) APP.cartoesBootData = data;
    }, null, true);
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // DASHBOARD
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderDashboard(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var area = document.getElementById('content');

    // a Usar cache se disponível (navegação instantânea)
    var cached = getCached(cacheKey('dashboard'));
    if (cached) {
      renderDashboardContent(cached, routeToken);
      // Atualizar em background
      fetchDashboardData(true, routeToken);
      return;
    }

    // Primeira vez sem cache: reaproveita snapshot se existir.
    if (!applyRouteSnapshot_('dashboard', area)) {
      area.innerHTML = '<div class="empty-state"><div class="empty-text">Carregando dashboard...</div></div>';
    }
    fetchDashboardData(false, routeToken);
  }

  function fetchDashboardData(silent, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    // Buscar Dashboard e Contas em paralelo para ter saldos atualizados
    var p1 = new Promise(function (resolve, reject) {
      rpc('getDashboard', { month: APP.month, year: APP.year }, resolve, reject);
    });
    var p2 = new Promise(function (resolve, reject) {
      rpc('listAccounts', { includeInactive: true }, resolve, reject);
    });

    Promise.all([p1, p2]).then(function (results) {
      if (!isRouteTokenValid_(routeToken)) return;
      var dashData = results[0];
      var accountsData = results[1];

      APP.accounts = accountsData || []; // Atualizar contas globais
      dashData.accounts = APP.accounts; // Passar para o render

      setCached(cacheKey('dashboard'), dashData);
      setCached({ base: 'accounts', key: 'list' }, accountsData);

      renderDashboardContent(dashData, routeToken);
    }).catch(function (err) {
      if (!isRouteTokenValid_(routeToken)) return;
      console.error(err);
      if (!silent) toast('Erro ao carregar dashboard', 'error');
    });
  }

  function renderDashboardContent(d, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    d = d || {};
    d.cardKpis = d.cardKpis || {};
    if (!d.accounts || !d.accounts.length) {
      if (APP.accounts && APP.accounts.length) {
        d.accounts = APP.accounts.slice();
      } else {
        var cachedAccounts = getCached({ base: 'accounts', key: 'list' });
        if (cachedAccounts && cachedAccounts.length) d.accounts = cachedAccounts;
      }
    }
    APP.dashboardLastData = deepClone_(d);
    var html = '<div class="kpi-grid">';
    html += kpiCard('+', fmtCurrency(d.totalReceita || 0), 'Receita', 'positive');
    html += kpiCard('-', fmtCurrency(d.totalDespesa || 0), 'Despesa', 'negative');
    // html += kpiCard('x', fmtCurrency(d.transferenciasParaReserva || 0), 'Reserva Financeira', 'accent');
    // Trocar KPI de Reserva por Lucro Líquido Real (Receita - Despesa)
    // O Lucro d.lucro já desconta reserva. Vou mostrar o Disponível.
    var lucro = parseFloat(d.lucro) || 0;
    html += kpiCard(lucro >= 0 ? 'UP' : 'DOWN', fmtCurrency(lucro), 'Disponível', lucro >= 0 ? 'positive' : 'negative');

    html += kpiCard('COMB', fmtCurrency(d.gastoCombustivel || 0), 'Combustível', 'warning');
    html += kpiCard('ALIM', fmtCurrency(d.gastoAlimentacao || 0), 'Alimentação', 'info');
    html += kpiCard('MAN', fmtCurrency(d.gastoManutencao || 0), 'Manutenção', 'negative');
    html += kpiCard('FIX', fmtCurrency(d.custosFixos || 0), 'Custos Fixos', 'info');
    if (d.cardKpis) {
      html += kpiCard('CARD', fmtCurrency(d.cardKpis.totalUsado || 0), 'Cartões (Usado)', 'warning');
      html += kpiCard('FAT', fmtCurrency(d.cardKpis.faturasAbertas || 0), 'Faturas em Aberto', 'negative');
      html += kpiCard('LIM', fmtCurrency(d.cardKpis.totalDisponivel || 0), 'Limite Disponível', 'positive');
    }
    html += '</div>';

    // Saldos das Contas
    if (d.accounts && d.accounts.length > 0) {
      html += '<div class="section-card" style="margin-top:16px">';
      html += '<div class="section-title" style="display:flex;justify-content:space-between;align-items:center"><span>Saldos das Contas</span><button class="btn-sm btn-secondary" onclick="navigate(\'accounts\')">Gerenciar</button></div>';
      html += '<div style="display:flex;flex-direction:column;gap:0px">';

      // Ordenar e filtrar
      var sorted = d.accounts.filter(function (a) { return a.ativo; }).sort(function (a, b) { return (a.ordem || 99) - (b.ordem || 99); });

      sorted.forEach(function (acc) {
        var bankInfo = getBankInfo(acc.instituicao, acc.nome);
        var logoHtml = '';

        if (bankInfo.type === 'img') {
          logoHtml = '<img src="' + bankInfo.logo + '" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'inline\'" style="width:24px;height:24px;border-radius:50%;object-fit:cover;vertical-align:middle" />' +
            '<span style="display:none;font-size:18px">' + (bankInfo.fallback || '*') + '</span>';
        } else {
          logoHtml = '<span style="font-size:18px">' + bankInfo.logo + '</span>';
        }

        html += '<div data-account-id="' + String(acc.id || '') + '" style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">' +
          '<div style="display:flex;align-items:center;gap:8px;font-weight:500;color:var(--text-primary)">' + logoHtml + ' ' + acc.nome + '</div>' +
          '<div class="account-balance-value" style="font-weight:600;color:' + (acc.saldoAtual >= 0 ? 'var(--success)' : 'var(--danger)') + '">' + fmtCurrency(acc.saldoAtual) + '</div>' +
          '</div>';
      });
      html += '</div></div>';
    }

    var dashCards = (APP.cartoesBootData && APP.cartoesBootData.cartoes ? APP.cartoesBootData.cartoes : [])
      .filter(function (c) { return !!c.ativo; });
    html += '<div class="section-card" style="margin-top:16px">';
    html += '<div class="section-title" style="display:flex;justify-content:space-between;align-items:center"><span>Resumo dos Cartões</span><button class="btn-sm btn-secondary" onclick="navigate(\'cartoes\')">Gerenciar</button></div>';
    if (dashCards.length) {
      dashCards.sort(function (a, b) { return (parseFloat(b.limite_usado) || 0) - (parseFloat(a.limite_usado) || 0); });
      html += '<div style="display:flex;flex-direction:column;gap:0px">';
      dashCards.forEach(function (card) {
        var usado = parseFloat(card.limite_usado) || 0;
        var disponivel = parseFloat(card.limite_disponivel) || 0;
        var pct = parseFloat(card.pct_uso) || 0;
        var pctColor = pct >= 80 ? 'var(--danger)' : (pct >= 50 ? 'var(--warning)' : 'var(--success)');
        html += '<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border)">' +
          '<div style="display:flex;align-items:center;gap:10px;min-width:220px">' +
          getCardBrandLogoHtml_(card.bandeira) +
          '<div>' +
          '<div style="font-weight:600;color:var(--text-primary);line-height:1.2">' + String(card.nome || 'Cartão') + '</div>' +
          '<div style="font-size:11px;color:var(--text-secondary)">' + String(card.emissor || '') + '</div>' +
          '</div>' +
          '</div>' +
          '<div style="display:flex;align-items:center;gap:14px">' +
          '<div style="text-align:right">' +
          '<div style="font-size:11px;color:var(--text-secondary)">Usado</div>' +
          '<div style="font-weight:700;color:var(--danger)">' + fmtCurrency(usado) + '</div>' +
          '</div>' +
          '<div style="text-align:right">' +
          '<div style="font-size:11px;color:var(--text-secondary)">Disponível</div>' +
          '<div style="font-weight:700;color:var(--success)">' + fmtCurrency(disponivel) + '</div>' +
          '</div>' +
          '<div style="min-width:54px;text-align:right;font-size:12px;font-weight:700;color:' + pctColor + '">' + Math.round(pct) + '%</div>' +
          '</div>' +
          '</div>';
      });
      html += '</div>';
    } else {
      html += '<div style="padding:14px 0;color:var(--text-secondary);font-size:13px">' +
        ((d.cardKpis && (parseInt(d.cardKpis.cartoesAtivos) || 0) > 0)
          ? 'Atualizando cartões...'
          : 'Sem cartões ativos para exibir no resumo.') +
        '</div>';
      if (d.cardKpis && (parseInt(d.cardKpis.cartoesAtivos) || 0) > 0) {
        refreshCardsBootCache_(function () {
          if (APP.route === 'dashboard') fetchDashboardData(true, getActiveRouteToken_());
        });
      }
    }
    html += '</div>';

    // Despesas por categoria
    if (d.despesasPorCategoria.length > 0) {
      html += '<div class="section-card" style="margin-top:16px">';
      html += '<div class="section-title">Despesas por Categoria</div>';
      var maxVal = d.despesasPorCategoria[0].total || 1;
      d.despesasPorCategoria.forEach(function (c) {
        var pct = Math.round((c.total / maxVal) * 100);
        html += '<div class="cat-bar-row">' +
          '<div class="cat-bar-label">' + c.emoji + ' ' + c.name + '</div>' +
          '<div class="cat-bar-track">' +
          '<div class="cat-bar-fill" style="width:' + pct + '%;background:' + c.colorHex + '">' +
          (pct > 15 ? Math.round((c.total / d.totalDespesa) * 100) + '%' : '') +
          '</div></div>' +
          '<div class="cat-bar-value">' + fmtCurrency(c.total) + '</div>' +
          '</div>';
      });
      html += '</div>';
    }

    if (!isRouteTokenValid_(routeToken)) return;
    document.getElementById('content').innerHTML = html;
    setRouteSnapshot_('dashboard', html);
  }

  function kpiCard(icon, value, label, cls) {
    return '<div class="kpi-card ' + (cls || '') + '">' +
      '<div class="kpi-icon">' + icon + '</div>' +
      '<div class="kpi-value">' + value + '</div>' +
      '<div class="kpi-label">' + label + '</div></div>';
  }

  function parseCurrencyPtBr_(valueText) {
    var raw = String(valueText || '').trim();
    if (!raw) return 0;
    var neg = raw.indexOf('-') !== -1;
    var normalized = raw.replace(/[^\d,.-]/g, '');
    normalized = normalized.replace(/\./g, '').replace(',', '.');
    var num = parseFloat(normalized);
    if (!isFinite(num)) return 0;
    return neg ? -Math.abs(num) : num;
  }

  function findDashboardKpiCardByLabel_(label) {
    if (APP.route !== 'dashboard') return null;
    var cards = document.querySelectorAll('.kpi-card');
    for (var i = 0; i < cards.length; i++) {
      var lbl = cards[i].querySelector('.kpi-label');
      if (!lbl) continue;
      if (String(lbl.textContent || '').trim() === String(label || '').trim()) {
        return cards[i];
      }
    }
    return null;
  }

  function bumpDashboardKpiValue_(label, delta) {
    var card = findDashboardKpiCardByLabel_(label);
    if (!card) return false;
    var valueEl = card.querySelector('.kpi-value');
    if (!valueEl) return false;
    var curr = parseCurrencyPtBr_(valueEl.textContent);
    var next = curr + (parseFloat(delta) || 0);
    if (label === 'Despesa' || label === 'Combustível' || label === 'Alimentação' || label === 'Manutenção' || label === 'Custos Fixos' || label === 'Cartões (Usado)') {
      next = Math.max(0, next);
    }
    valueEl.textContent = fmtCurrency(next);
    return true;
  }

  function applyDashboardDomExpenseDelta_(txLike, direction) {
    if (!txLike || String(txLike.type || '') !== 'DESPESA') return false;
    if (!isCurrentDashboardMonthTx_(txLike)) return false;
    if (APP.route !== 'dashboard') return false;

    var amount = parseFloat(txLike.amount) || 0;
    if (amount <= 0) return false;
    var delta = amount * (direction > 0 ? 1 : -1);
    var touched = false;

    touched = bumpDashboardKpiValue_('Despesa', delta) || touched;
    touched = bumpDashboardKpiValue_('Disponível', -delta) || touched;

    var category = resolveCategoryForDashboard_(txLike);
    var catName = (category && category.name ? String(category.name) : '').toLowerCase();
    if (catName.indexOf('combust') !== -1) touched = bumpDashboardKpiValue_('Combustível', delta) || touched;
    if (catName.indexOf('aliment') !== -1) touched = bumpDashboardKpiValue_('Alimentação', delta) || touched;
    if (catName.indexOf('manuten') !== -1) touched = bumpDashboardKpiValue_('Manutenção', delta) || touched;
    if (catName === 'despesa fixa' || catName === 'despesas fixas') touched = bumpDashboardKpiValue_('Custos Fixos', delta) || touched;

    var cardId = txLike.cardId || extractCardIdFromNotes_(txLike.notas || '');
    if (cardId && !isCardBillPaymentNotes_(txLike.notas || '')) {
      touched = bumpDashboardKpiValue_('Cartões (Usado)', delta) || touched;
      touched = bumpDashboardKpiValue_('Limite Disponível', -delta) || touched;
    }
    return touched;
  }

  function isTxPaidForBalance_(txLike) {
    if (!txLike) return false;
    var type = String(txLike.type || '').toUpperCase();
    if (type === 'TRANSFER' || type === 'TRANSFERENCIA') return true;
    if (txLike.isPaid === true) return true;
    var status = String(txLike.statusParcela || '').toUpperCase();
    return status === 'PAGA' || status === 'COMPENSADO';
  }

  function getTxAccountDeltas_(txLike, direction) {
    if (!txLike) return [];
    var type = String(txLike.type || '').toUpperCase();
    var amount = parseFloat(txLike.amount) || 0;
    if (amount <= 0) return [];
    var signal = direction > 0 ? 1 : -1;
    var deltas = [];

    function pushDelta_(accountId, delta) {
      if (!accountId) return;
      deltas.push({ id: String(accountId), delta: delta });
    }

    if (type === 'RECEITA') {
      if (!isTxPaidForBalance_(txLike)) return [];
      pushDelta_(txLike.toWalletId, amount * signal);
      return deltas;
    }

    if (type === 'DESPESA') {
      if (!isTxPaidForBalance_(txLike)) return [];
      pushDelta_(txLike.fromWalletId, -amount * signal);
      return deltas;
    }

    if (type === 'TRANSFER' || type === 'TRANSFERENCIA') {
      pushDelta_(txLike.fromWalletId, -amount * signal);
      pushDelta_(txLike.toWalletId, amount * signal);
      return deltas;
    }

    return [];
  }

  function applyAccountDeltasToList_(list, deltas) {
    if (!list || !list.length || !deltas || !deltas.length) return;
    var byId = {};
    deltas.forEach(function (d) {
      var id = String(d.id || '');
      if (!id) return;
      byId[id] = (byId[id] || 0) + (parseFloat(d.delta) || 0);
    });
    list.forEach(function (acc) {
      var id = String(acc.id || '');
      if (!id || !byId[id]) return;
      acc.saldoAtual = (parseFloat(acc.saldoAtual) || 0) + byId[id];
    });
  }

  function applyDashboardDomAccountDeltas_(deltas) {
    if (APP.route !== 'dashboard' || !deltas || !deltas.length) return false;
    var byId = {};
    deltas.forEach(function (d) {
      var id = String(d.id || '');
      if (!id) return;
      byId[id] = (byId[id] || 0) + (parseFloat(d.delta) || 0);
    });
    var changed = false;
    var nodes = document.querySelectorAll('[data-account-id] .account-balance-value');
    nodes.forEach(function (node) {
      var row = node.closest('[data-account-id]');
      if (!row) return;
      var id = String(row.getAttribute('data-account-id') || '');
      if (!id || !byId[id]) return;
      var curr = parseCurrencyPtBr_(node.textContent);
      var next = curr + byId[id];
      node.textContent = fmtCurrency(next);
      node.style.color = next >= 0 ? 'var(--success)' : 'var(--danger)';
      changed = true;
    });
    return changed;
  }

  function getCardBrandLogoHtml_(brand) {
    var b = String(brand || '').toLowerCase();
    if (b === 'master' || b === 'mastercard') {
      return '<span style="position:relative;display:inline-block;width:28px;height:18px">' +
        '<span style="position:absolute;left:3px;top:1px;width:14px;height:14px;border-radius:50%;background:#eb001b;opacity:.9"></span>' +
        '<span style="position:absolute;left:11px;top:1px;width:14px;height:14px;border-radius:50%;background:#f79e1b;opacity:.9"></span>' +
        '</span>';
    }
    if (b === 'visa') {
      return '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:18px;padding:0 6px;border-radius:8px;background:rgba(29,78,216,.2);color:#93c5fd;font-size:10px;font-weight:800;letter-spacing:.05em">VISA</span>';
    }
    if (b === 'amex') {
      return '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:34px;height:18px;padding:0 6px;border-radius:8px;background:rgba(34,211,238,.18);color:#67e8f9;font-size:10px;font-weight:800;letter-spacing:.05em">AMEX</span>';
    }
    if (b === 'elo') {
      return '<span style="display:inline-flex;align-items:center;justify-content:center;min-width:30px;height:18px;padding:0 6px;border-radius:8px;background:rgba(251,191,36,.16);color:#fcd34d;font-size:10px;font-weight:800;letter-spacing:.05em">ELO</span>';
    }
    return '<span style="display:inline-flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:50%;background:rgba(108,99,255,.18);color:#a5b4fc;font-size:12px">x</span>';
  }

  function extractCardIdFromNotes_(notes) {
    var txt = String(notes || '');
    var m = txt.match(/\[CARTAO_ID:([^\]]+)\]/i) || txt.match(/CARTAO_ID:([A-Za-z0-9\-_]+)/i);
    return m ? String(m[1]).trim() : '';
  }

  function isCardBillPaymentNotes_(notes) {
    return /\[PAGAMENTO_FATURA:[^\]]+\]/i.test(String(notes || ''));
  }

  function isCardPurchaseTx_(tx) {
    if (!tx || tx.type !== 'DESPESA') return false;
    if (!tx.cardId) return false;
    if (isCardBillPaymentNotes_(tx.notas || '')) return false;
    return true;
  }

  function stripCardMarkersFromNotes_(notes) {
    return String(notes || '').replace(/\s*\[CARTAO_ID:[^\]]+\]\s*/ig, ' ').trim();
  }

  function renderCardOptions(selectedId) {
    var cards = (APP.cartoesBootData && APP.cartoesBootData.cartoes) ? APP.cartoesBootData.cartoes : [];
    var ativos = cards.filter(function (c) { return !!c.ativo; });
    var html = '<option value="">Selecione um cartão</option>';
    ativos.forEach(function (c) {
      var id = String(c.id || '');
      if (!id) return;
      var selected = String(selectedId || '') === id ? ' selected' : '';
      html += '<option value="' + id + '"' + selected + '>' + String(c.nome || 'Cartão') + '</option>';
    });
    return html;
  }

  function extractCardsList_(res) {
    if (!res || typeof res !== 'object') return [];
    if (Array.isArray(res.cartoes)) return res.cartoes;
    if (Array.isArray(res.items)) return res.items;
    return [];
  }

  function refreshCardsBootCache_(onDone) {
    rpc('listCartoes', 'ativos', function (res) {
      var cards = extractCardsList_(res);
      APP.cartoesBootData = APP.cartoesBootData || {};
      APP.cartoesBootData.cartoes = cards;
      if (onDone) onDone();
    }, function () {
      if (onDone) onDone();
    }, true);
  }

  function snapshotDashboardOptimisticState_() {
    return {
      dashboard: getCached(cacheKey('dashboard')) || deepClone_(APP.dashboardLastData),
      cards: deepClone_(APP.cartoesBootData && APP.cartoesBootData.cartoes ? APP.cartoesBootData.cartoes : null),
      accounts: deepClone_(APP.accounts || []),
      accountsCache: deepClone_(getCached({ base: 'accounts', key: 'list' }) || [])
    };
  }

  function restoreDashboardOptimisticState_(snapshot) {
    if (!snapshot) return;
    if (snapshot.cards && APP.cartoesBootData) {
      APP.cartoesBootData.cartoes = deepClone_(snapshot.cards);
    }
    if (snapshot.accounts) {
      APP.accounts = deepClone_(snapshot.accounts);
      setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    } else if (snapshot.accountsCache) {
      APP.accounts = deepClone_(snapshot.accountsCache);
      setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    }
    if (snapshot.dashboard) {
      setCached(cacheKey('dashboard'), snapshot.dashboard);
      APP.dashboardLastData = deepClone_(snapshot.dashboard);
      if (APP.route === 'dashboard') {
        renderDashboardContent(snapshot.dashboard, getActiveRouteToken_());
      }
    }
  }

  function getTxIsoDate_(txLike) {
    if (!txLike) return '';
    var raw = String(txLike.dateRaw || txLike.date || '').trim();
    if (!raw) return '';
    raw = raw.split('T')[0];
    if (/^\d{4}-\d{2}-\d{2}$/.test(raw)) return raw;
    var m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (m) return m[3] + '-' + m[2] + '-' + m[1];
    return '';
  }

  function isCurrentDashboardMonthTx_(txLike) {
    var iso = getTxIsoDate_(txLike);
    if (!iso) return false;
    var parts = iso.split('-');
    if (parts.length !== 3) return false;
    var y = parseInt(parts[0], 10);
    var m = parseInt(parts[1], 10);
    return y === APP.year && m === APP.month;
  }

  function resolveCategoryForDashboard_(txLike) {
    if (!txLike) return null;
    if (txLike.categoryName || txLike.categoryEmoji || txLike.categoryColor) {
      return {
        id: txLike.categoryId || '',
        name: txLike.categoryName || '',
        emoji: txLike.categoryEmoji || '',
        colorHex: txLike.categoryColor || '#6b7280'
      };
    }
    if (!txLike.categoryId) return null;
    var cat = (APP.categories || []).find(function (c) { return String(c.id) === String(txLike.categoryId); });
    if (!cat) return null;
    return {
      id: cat.id || '',
      name: cat.name || '',
      emoji: cat.emoji || '',
      colorHex: cat.colorHex || '#6b7280'
    };
  }

  function applyCardUsageDeltaToBoot_(cardId, deltaAmount) {
    if (!cardId || !APP.cartoesBootData || !APP.cartoesBootData.cartoes) return;
    var card = APP.cartoesBootData.cartoes.find(function (c) { return String(c.id) === String(cardId); });
    if (!card) return;
    var total = parseFloat(card.limite_total) || 0;
    var used = (parseFloat(card.limite_usado) || 0) + (parseFloat(deltaAmount) || 0);
    used = Math.max(0, total > 0 ? Math.min(used, total) : used);
    card.limite_usado = used;
    card.limite_disponivel = Math.max(0, total - used);
    card.pct_uso = total > 0 ? (used / total) * 100 : 0;
  }

  function recalcDashboardCardKpisFromBoot_(dash) {
    dash.cardKpis = dash.cardKpis || {};
    var cards = (APP.cartoesBootData && APP.cartoesBootData.cartoes ? APP.cartoesBootData.cartoes : []).filter(function (c) { return !!c.ativo; });
    var totalUsado = 0;
    var totalDisponivel = 0;
    cards.forEach(function (c) {
      totalUsado += parseFloat(c.limite_usado) || 0;
      totalDisponivel += parseFloat(c.limite_disponivel) || 0;
    });
    dash.cardKpis.totalUsado = totalUsado;
    dash.cardKpis.totalDisponivel = totalDisponivel;
    dash.cardKpis.cartoesAtivos = cards.length;
  }

  function applyDashboardTxOptimisticDelta_(txLike, direction) {
    if (!txLike) return false;
    var txType = String(txLike.type || '').toUpperCase();
    if (txType !== 'DESPESA' && txType !== 'RECEITA' && txType !== 'TRANSFER' && txType !== 'TRANSFERENCIA') return false;
    if (!isCurrentDashboardMonthTx_(txLike)) return false;

    var accountDeltas = getTxAccountDeltas_(txLike, direction);
    if (accountDeltas.length) {
      applyAccountDeltasToList_(APP.accounts, accountDeltas);
      var cachedAccList = getCached({ base: 'accounts', key: 'list' }) || [];
      applyAccountDeltasToList_(cachedAccList, accountDeltas);
      setCached({ base: 'accounts', key: 'list' }, cachedAccList);
      if (!APP.accounts || !APP.accounts.length) APP.accounts = deepClone_(cachedAccList);
    }

    var dash = getCached(cacheKey('dashboard')) || deepClone_(APP.dashboardLastData);
    if (!dash) {
      if (APP.route === 'dashboard') {
        if (txType === 'RECEITA') {
          var amountOnly = parseFloat(txLike.amount) || 0;
          var deltaOnly = amountOnly * (direction > 0 ? 1 : -1);
          var touchedIncome = false;
          touchedIncome = bumpDashboardKpiValue_('Receita', deltaOnly) || touchedIncome;
          touchedIncome = bumpDashboardKpiValue_('Disponível', deltaOnly) || touchedIncome;
          touchedIncome = applyDashboardDomAccountDeltas_(accountDeltas) || touchedIncome;
          return touchedIncome;
        }
        if (txType === 'DESPESA') {
          var touchedExpense = applyDashboardDomExpenseDelta_(txLike, direction);
          touchedExpense = applyDashboardDomAccountDeltas_(accountDeltas) || touchedExpense;
          return touchedExpense;
        }
        return applyDashboardDomAccountDeltas_(accountDeltas);
      }
      return accountDeltas.length > 0;
    }

    dash.cardKpis = dash.cardKpis || {};
    dash.despesasPorCategoria = dash.despesasPorCategoria || [];
    if (!dash.accounts || !dash.accounts.length) {
      if (APP.accounts && APP.accounts.length) dash.accounts = APP.accounts.slice();
      else {
        var cachedAccounts = getCached({ base: 'accounts', key: 'list' });
        if (cachedAccounts && cachedAccounts.length) dash.accounts = cachedAccounts;
      }
    }
    if (accountDeltas.length) applyAccountDeltasToList_(dash.accounts, accountDeltas);

    var amount = parseFloat(txLike.amount) || 0;
    if (amount <= 0) {
      setCached(cacheKey('dashboard'), dash);
      APP.dashboardLastData = deepClone_(dash);
      if (APP.route === 'dashboard') renderDashboardContent(dash, getActiveRouteToken_());
      else applyDashboardDomAccountDeltas_(accountDeltas);
      return accountDeltas.length > 0;
    }
    var delta = amount * (direction > 0 ? 1 : -1);

    if (txType === 'RECEITA') {
      dash.totalReceita = Math.max(0, (parseFloat(dash.totalReceita) || 0) + delta);
      dash.lucro = (parseFloat(dash.lucro) || 0) + delta;
    } else if (txType === 'DESPESA') {
      dash.totalDespesa = Math.max(0, (parseFloat(dash.totalDespesa) || 0) + delta);
      dash.lucro = (parseFloat(dash.lucro) || 0) - delta;
    }

    var category = null;
    var catName = '';
    if (txType === 'DESPESA') {
      category = resolveCategoryForDashboard_(txLike);
      catName = (category && category.name ? String(category.name) : '').toLowerCase();
      if (catName.indexOf('combust') !== -1) dash.gastoCombustivel = Math.max(0, (parseFloat(dash.gastoCombustivel) || 0) + delta);
      if (catName.indexOf('aliment') !== -1) dash.gastoAlimentacao = Math.max(0, (parseFloat(dash.gastoAlimentacao) || 0) + delta);
      if (catName.indexOf('manuten') !== -1) dash.gastoManutencao = Math.max(0, (parseFloat(dash.gastoManutencao) || 0) + delta);
      if (catName === 'despesa fixa' || catName === 'despesas fixas') dash.custosFixos = Math.max(0, (parseFloat(dash.custosFixos) || 0) + delta);
    }

    if (txType === 'DESPESA' && category) {
      var existing = dash.despesasPorCategoria.find(function (it) {
        if (category.id) return String(it.id || '') === String(category.id);
        return String(it.name || '').toLowerCase() === String(category.name || '').toLowerCase();
      });
      if (!existing && delta > 0) {
        existing = {
          id: category.id || '',
          name: category.name || 'Categoria',
          emoji: category.emoji || '',
          colorHex: category.colorHex || '#6b7280',
          total: 0
        };
        dash.despesasPorCategoria.push(existing);
      }
      if (existing) {
        existing.total = Math.max(0, (parseFloat(existing.total) || 0) + delta);
        if (existing.total <= 0.0001) {
          dash.despesasPorCategoria = dash.despesasPorCategoria.filter(function (it) { return it !== existing; });
        }
      }
      dash.despesasPorCategoria.sort(function (a, b) { return (parseFloat(b.total) || 0) - (parseFloat(a.total) || 0); });
    }

    var cardId = txLike.cardId || extractCardIdFromNotes_(txLike.notas || '');
    if (txType === 'DESPESA' && cardId && !isCardBillPaymentNotes_(txLike.notas || '')) {
      applyCardUsageDeltaToBoot_(cardId, delta);
      recalcDashboardCardKpisFromBoot_(dash);
    }

    setCached(cacheKey('dashboard'), dash);
    APP.dashboardLastData = deepClone_(dash);
    if (APP.route === 'dashboard') {
      renderDashboardContent(dash, getActiveRouteToken_());
    } else {
      if (txType === 'DESPESA') {
        applyDashboardDomExpenseDelta_(txLike, direction);
      } else if (txType === 'RECEITA') {
        bumpDashboardKpiValue_('Receita', delta);
        bumpDashboardKpiValue_('Disponível', delta);
      }
      applyDashboardDomAccountDeltas_(accountDeltas);
    }
    return true;
  }
  function reconcileDashboardAfterTxMutation_() {
    clearCached(cacheKey('dashboard'));
    clearCached('reports');
    clearCached('installmentsDash');
    refreshCardsBootCache_(function () {
      fetchDashboardData(true, getActiveRouteToken_());
    });
  }

  function ensureCardOptionsLoaded_(selectedId) {
    var select = document.getElementById('tx-card-id');
    if (!select) return;
    var hasOptions = select.options && select.options.length > 1;
    if (hasOptions) return;
    rpc('listCartoes', 'ativos', function (res) {
      var cards = extractCardsList_(res);
      APP.cartoesBootData = APP.cartoesBootData || {};
      APP.cartoesBootData.cartoes = cards;
      select.innerHTML = renderCardOptions(selectedId || select.value || '');
    }, function () { }, true);
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // TRANSACTIONS
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderTransactions(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var content = document.getElementById('content');
    content.innerHTML = '<div class="filters-bar">' +
      '<input type="text" class="filter-input" id="tx-search" placeholder="Buscar descrição...">' +
      '<select class="filter-select" id="tx-filter-type"><option value="">Todos os tipos</option>' +
      '<option value="RECEITA">Receita</option><option value="DESPESA">Despesa</option><option value="TRANSFER">Transferência</option></select>' +
      '<select class="filter-select" id="tx-filter-cat"><option value="">Todas categorias</option></select>' +
      '<div class="btn-group" style="margin-left:auto">' +
      '<button class="btn-primary btn-sm" onclick="openTransactionModal(\'RECEITA\')">+ Receita</button>' +
      '<button class="btn-danger btn-sm" onclick="openTransactionModal(\'DESPESA\')">+ Despesa</button>' +
      '<button class="btn-secondary btn-sm" onclick="openTransactionModal(\'TRANSFER\')" style="background:var(--accent);color:#fff;border-color:var(--accent)">Transferir</button></div>' +
      '</div>' +
      '<div id="tx-table-area"></div>';

    // Populate category filter
    var catSel = document.getElementById('tx-filter-cat');
    APP.categories.forEach(function (c) {
      var opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = c.emoji + ' ' + c.name;
      catSel.appendChild(opt);
    });

    // Events
    var debounce;
    document.getElementById('tx-search').addEventListener('input', function () {
      APP.txPage = 1;
      applyLocalTransactionsPreview_(routeToken);
      clearTimeout(debounce);
      debounce = setTimeout(function () { loadTransactions(routeToken); }, 120);
    });
    document.getElementById('tx-filter-type').addEventListener('change', function () {
      APP.txPage = 1;
      applyLocalTransactionsPreview_(routeToken);
      loadTransactions(routeToken);
    });
    document.getElementById('tx-filter-cat').addEventListener('change', function () {
      APP.txPage = 1;
      applyLocalTransactionsPreview_(routeToken);
      loadTransactions(routeToken);
    });

    APP.txPage = 1;
    warmupTransactionsPreviewSource_(routeToken);
    loadTransactions(routeToken);
  }

  function buildTxParams_() {
    return {
      month: APP.month,
      year: APP.year,
      type: (document.getElementById('tx-filter-type') || {}).value || '',
      categoryId: (document.getElementById('tx-filter-cat') || {}).value || '',
      search: (document.getElementById('tx-search') || {}).value || '',
      page: APP.txPage,
      pageSize: APP.txPageSize
    };
  }

  function txHasActiveFilters_(params) {
    params = params || buildTxParams_();
    return !!(params.type || params.categoryId || String(params.search || '').trim());
  }

  function txMatchesFilters_(tx, params) {
    if (!tx) return false;
    params = params || buildTxParams_();
    if (params.type && tx.type !== params.type) return false;
    if (params.categoryId && String(tx.categoryId || '') !== String(params.categoryId)) return false;
    var search = String(params.search || '').trim().toLowerCase();
    if (search) {
      var haystack = [
        tx.description || '',
        tx.categoryName || '',
        tx.paymentMethod || '',
        tx.type || '',
        tx.cardName || ''
      ].join(' ').toLowerCase();
      if (haystack.indexOf(search) === -1) return false;
    }
    return true;
  }

  function txEmptyStateMessage_() {
    var params = buildTxParams_();
    if (txHasActiveFilters_(params)) return 'Nenhum lançamento encontrado para os filtros atuais.';
    return 'Nenhum lançamento neste mês.';
  }

  function txParamsKey_(params) {
    return JSON.stringify({
      month: params.month,
      year: params.year,
      type: params.type,
      categoryId: params.categoryId,
      search: String(params.search || '').trim().toLowerCase(),
      page: params.page,
      pageSize: params.pageSize
    });
  }

  function txResultSignature_(data) {
    if (!data || !data.items) return 'none';
    var ids = data.items.map(function (t) {
      return [t.id, t.statusParcela || '', t.isPaid ? 1 : 0, t.amount].join(':');
    }).join('|');
    return [data.page || 1, data.totalPages || 1, data.total || 0, ids].join('::');
  }

  function warmupTransactionsPreviewSource_(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (APP.txPreviewSourceLoading) return;
    APP.txPreviewSourceLoading = true;
    rpc('listTransactions', {
      month: APP.month,
      year: APP.year,
      type: '',
      categoryId: '',
      search: '',
      page: 1,
      pageSize: 1000
    }, function (data) {
      APP.txPreviewSourceLoading = false;
      if (!isRouteTokenValid_(routeToken)) return;
      APP.txPreviewSource = (data && data.items) ? data.items : [];
    }, function () {
      APP.txPreviewSourceLoading = false;
    }, true);
  }

  function renderTransactionsPendingState_(area, paramsKey, msg) {
    if (!area) return;
    area.innerHTML = '<div class="empty-state"><div class="empty-icon">⏳</div>' +
      '<div class="empty-text">' + (msg || 'Buscando resultados...') + '</div></div>';
    area.setAttribute('data-tx-params-key', String(paramsKey || ''));
    area.setAttribute('data-tx-signature', 'pending');
  }

  function applyLocalTransactionsPreview_(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    var params = buildTxParams_();
    var paramsKey = txParamsKey_(params);
    var area = document.getElementById('tx-table-area');
    if (!area) return;
    var source = APP.txPreviewSource || (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) || [];
    if (!source || !source.length) {
      // Sem base local: mantém o estado atual até chegar o remoto para evitar flicker.
      return;
    }

    var search = String(params.search || '').trim().toLowerCase();

    var filtered = source.filter(function (tx) {
      if (params.type && tx.type !== params.type) return false;
      if (params.categoryId && String(tx.categoryId || '') !== String(params.categoryId)) return false;
      if (!search) return true;
      var haystack = [
        tx.description || '',
        tx.categoryName || '',
        tx.paymentMethod || '',
        tx.type || ''
      ].join(' ').toLowerCase();
      return haystack.indexOf(search) !== -1;
    });

    var total = filtered.length;
    var totalPages = Math.max(1, Math.ceil(total / APP.txPageSize));
    if (APP.txPage > totalPages) APP.txPage = totalPages;
    var page = APP.txPage;
    var start = (page - 1) * APP.txPageSize;
    var end = start + APP.txPageSize;
    var items = filtered.slice(start, end);

    var previewData = {
      items: items,
      page: page,
      totalPages: totalPages,
      total: total
    };

    if (!previewData.items.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-icon">x}</div>' +
        '<div class="empty-text">' + txEmptyStateMessage_() + '</div></div>';
      area.setAttribute('data-tx-params-key', String(paramsKey));
      area.setAttribute('data-tx-signature', 'preview-empty');
      return;
    }

    renderTransactionsTable_(previewData, area, routeToken, paramsKey + ':local');
  }

  function setTxOptimisticState_(ids, targetPaidState) {
    if (!APP.txOptimistic) APP.txOptimistic = {};
    var until = Date.now() + 30000; // protege contra respostas atrasadas do backend
    ids.forEach(function (id) {
      APP.txOptimistic[id] = {
        isPaid: !!targetPaidState,
        statusParcela: targetPaidState ? 'PAGA' : 'PENDENTE',
        holdUntil: until
      };
    });
  }

  function clearTxOptimisticState_(ids) {
    if (!APP.txOptimistic) return;
    ids.forEach(function (id) { delete APP.txOptimistic[id]; });
  }

  function applyTxOptimisticOverlay_(data) {
    if (!data || !data.items || !APP.txOptimistic) return;
    var now = Date.now();
    Object.keys(APP.txOptimistic).forEach(function (id) {
      if (!APP.txOptimistic[id] || APP.txOptimistic[id].holdUntil <= now) delete APP.txOptimistic[id];
    });
    data.items.forEach(function (tx) {
      var pending = APP.txOptimistic[tx.id];
      if (!pending) return;
      tx.isPaid = !!pending.isPaid;
      tx.statusParcela = pending.statusParcela;
      tx.debitoAutomatico = pending.isPaid ? false : !!tx.debitoAutomatico;
    });
  }

  function prefetchTransactionsPage_(currentParams, currentData) {
    if (!currentData || !currentData.totalPages) return;
    if (currentData.page >= currentData.totalPages) return;
    var nextParams = Object.assign({}, currentParams, { page: currentData.page + 1 });
    // silent + read-through cache
    rpc('listTransactions', nextParams, function () {}, null, true);
  }

  function loadTransactions(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var area = document.getElementById('tx-table-area');
    if (!area) return;
    var params = buildTxParams_();
    var paramsKey = txParamsKey_(params);

    if (!APP.txViewState) APP.txViewState = {};
    APP.txViewState.requestId = (APP.txViewState.requestId || 0) + 1;
    var requestId = APP.txViewState.requestId;
    APP.txViewState.waitingRemote = true;
    APP.txViewState.waitingParamsKey = paramsKey;

    var plan = getRpcCachePlan_('listTransactions', params);
    var cached = plan ? getCached({ base: plan.base, key: plan.key }) : null;
    if (cached && cached.items) {
      renderTransactionsTable_(cached, area, routeToken, paramsKey);
    } else if (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) {
      // Fallback imediato: reaproveita ultimo render conhecido para evitar area vazia.
      renderTransactionsTable_(
        APP.txViewState.lastData,
        area,
        routeToken,
        APP.txViewState.lastParamsKey || paramsKey
      );
    } else {
      renderTransactionsPendingState_(area, paramsKey, 'Buscando resultados...');
    }

    rpc('listTransactions', params, function (data) {
      if (!isRouteTokenValid_(routeToken)) return;
      if (!APP.txViewState || requestId !== APP.txViewState.requestId) return;
      APP.txViewState.waitingRemote = false;
      APP.txViewState.waitingParamsKey = null;
      renderTransactionsTable_(data, area, routeToken, paramsKey);
      prefetchTransactionsPage_(params, data);
    }, function (err) {
      if (!isRouteTokenValid_(routeToken)) return;
      if (!APP.txViewState || requestId !== APP.txViewState.requestId) return;
      APP.txViewState.waitingRemote = false;
      APP.txViewState.waitingParamsKey = null;
      if (APP.txViewState.lastData && APP.txViewState.lastData.items) {
        renderTransactionsTable_(APP.txViewState.lastData, area, routeToken, APP.txViewState.lastParamsKey || paramsKey);
      } else {
        area.innerHTML = '<div class="empty-state"><div class="empty-icon">a️</div>' +
          '<div class="empty-text">Erro ao buscar lançamentos: ' + String(err || 'erro desconhecido') + '</div></div>';
      }
    }, true);
  }

  function renderTransactionsTable_(data, area, routeToken, paramsKey) {
    if (!isRouteTokenValid_(routeToken)) return;
    if (!data || !data.items) return;
    applyTxOptimisticOverlay_(data);

    if (!APP.txViewState) APP.txViewState = {};
    var signature = txResultSignature_(data);
    var alreadyRendered =
      area &&
      area.getAttribute('data-tx-params-key') === String(paramsKey) &&
      area.getAttribute('data-tx-signature') === String(signature) &&
      String(area.innerHTML || '').trim() !== '';

    if (alreadyRendered) {
      return;
    }

    APP.currentTransactions = data.items; // Store for scope operations
    if (!data.items.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-icon">x</div>' +
        '<div class="empty-text">' + txEmptyStateMessage_() + '</div></div>';
      APP.txViewState.lastParamsKey = paramsKey;
      APP.txViewState.lastSignature = signature;
      var txContentEmpty = document.getElementById('content');
      if (txContentEmpty) setRouteSnapshot_('transactions', txContentEmpty.innerHTML);
      return;
    }

    var html = '<div class="table-wrapper"><table class="data-table">' +
      '<thead><tr><th style="width:40px;text-align:center">St</th><th>Data</th><th>Tipo</th><th>Conta</th><th>Categoria</th><th>Descrição</th>' +
      '<th style="text-align:right">Valor</th><th>Mp</th><th></th></tr></thead><tbody>';

    data.items.forEach(function (tx) {
      var typeBadge = '';
      if (tx.type === 'RECEITA') {
        typeBadge = '<span class="badge badge-receita">Receita</span>';
      } else if (tx.type === 'DESPESA') {
        typeBadge = '<span class="badge badge-despesa">Despesa</span>';
      } else if (tx.type === 'TRANSFER' || tx.type === 'TRANSFERENCIA') {
        typeBadge = '<span class="badge" style="background:rgba(108,99,255,0.15);color:var(--accent)">Transf.</span>';
      }

      // Resolver Nome da Conta com Logo
      var accountName = '-';
      if (tx.type === 'RECEITA') {
        accountName = getAccountNameWithLogo(tx.toWalletId) || '-';
      } else if (tx.type === 'DESPESA') {
        if (!tx.fromWalletId && tx.cardId) {
          accountName = 'Cartão: ' + (tx.cardName || 'Cartão');
        } else {
          accountName = getAccountNameWithLogo(tx.fromWalletId) || '-';
        }
      } else {
        // Transferencia
        var from = getAccountNameWithLogo(tx.fromWalletId);
        var to = getAccountNameWithLogo(tx.toWalletId);
        accountName = from + ' ~ ' + to;
      }

      var catChip = '';
      if (tx.type !== 'TRANSFER' && tx.type !== 'TRANSFERENCIA' && tx.categoryName) {
        catChip = '<span class="chip" style="background:' + tx.categoryColor + '22;color:' + tx.categoryColor + '">' +
          tx.categoryEmoji + ' ' + tx.categoryName + '</span>';
      } else if (tx.type === 'TRANSFER' || tx.type === 'TRANSFERENCIA') {
        catChip = '<span class="chip" style="background:rgba(108,99,255,0.1);color:var(--accent)">Transferência</span>';
      } else {
        catChip = '<span style="color:var(--text-muted)">-</span>';
      }

      // Status Column Logic
      var statusBadge = '';
      var today = new Date().toISOString().substring(0, 10);

      // Terminology based on type
      var labelPaid = (tx.type === 'RECEITA') ? 'Recebido' : 'Efetuado';
      var labelPending = (tx.type === 'RECEITA') ? 'A Receber' : 'Pendente';
      var labelOverdue = (tx.type === 'RECEITA') ? 'Atrasado' : 'Vencido';
      var labelAuto = (tx.type === 'RECEITA') ? 'Automático' : 'Débito Auto';

      var isCardExpenseTx = isCardPurchaseTx_(tx);
      if (isCardExpenseTx) {
        statusBadge = '<span class="status-pill locked" title="Lançamento de cartão não pode ser compensado aqui. Use pagar fatura.">Fatura</span>';
      } else if (tx.isPaid) {
        statusBadge = '<span class="status-pill paid" onclick="confirmCompensateTx(\'' + tx.id + '\', false)" title="Clique para reabrir">' + labelPaid + '</span>';
      } else {
        // Se não pago
        if (tx.debitoAutomatico) {
          statusBadge = '<span class="status-pill auto" onclick="confirmCompensateTx(\'' + tx.id + '\', true)" title="Processamento Automático">' + labelAuto + '</span>';
        } else if (tx.statusParcela === 'ATRASADA' || (tx.dateRaw < today && !tx.isPaid)) {
          // Atrasado se data < hoje e não pago
          statusBadge = '<span class="status-pill overdue" onclick="confirmCompensateTx(\'' + tx.id + '\', true)" title="Atrasado! Confirmar agora">' + labelOverdue + '</span>';
        } else {
          statusBadge = '<span class="status-pill pending" onclick="confirmCompensateTx(\'' + tx.id + '\', true)" title="Pendente. Clique para confirmar">' + labelPending + '</span>';
        }
      }

      var descHtml = (tx.description || '-');
      if (tx.cardId) {
        descHtml += '<div class="tx-meta-line"><span class="tx-card-tag">Cartão: ' + (tx.cardName || 'Cartão') + '</span></div>';
      }

      var actionsHtml = '<button onclick="openEditTxModal(\'' + tx.id + '\')" class="action-btn" title="Editar">&#9998;</button>';
      actionsHtml += '<button onclick="confirmDeleteTx(\'' + tx.id + '\')" class="action-btn" style="color:var(--danger)" title="Excluir">&#128465;</button>';

      var valueColor = tx.type === 'RECEITA' ? 'var(--success)' : tx.type === 'DESPESA' ? 'var(--danger)' : 'var(--accent)';

      var rowClass = tx.cardId ? ' class="tx-row-card"' : '';
      html += '<tr' + rowClass + '>' +
        '<td style="text-align:center;width:120px">' + statusBadge + '</td>' +
        '<td>' + tx.date + '</td>' +
        '<td>' + typeBadge + '</td>' +
        '<td><span class="' + (tx.cardId ? 'tx-account-card' : '') + '" style="font-size:11px;color:var(--text-secondary)">' + accountName + '</span></td>' +
        '<td>' + catChip + '</td>' +
        '<td>' + descHtml + '</td>' +
        '<td style="text-align:right;font-weight:600;color:' + valueColor + '">' + fmtCurrency(tx.amount) + '</td>' +
        '<td><span style="font-size:11px">' + (tx.paymentMethod || '-') + '</span></td>' +
        '<td style="white-space:nowrap">' + actionsHtml + '</td>' +
        '</tr>';
    });

    html += '</tbody></table></div>';

    // Pagination
    if (data.totalPages > 1) {
      html += '<div class="pagination">';
      html += '<button ' + (data.page <= 1 ? 'disabled' : '') + ' onclick="APP.txPage--;loadTransactions()"> Anterior</button>';
      html += '<span>Página ' + data.page + ' de ' + data.totalPages + ' (' + data.total + ' itens)</span>';
      html += '<button ' + (data.page >= data.totalPages ? 'disabled' : '') + ' onclick="APP.txPage++;loadTransactions()">Próxima </button>';
      html += '</div>';
    }

    if (!isRouteTokenValid_(routeToken)) return;
    area.innerHTML = html;
    area.setAttribute('data-tx-params-key', String(paramsKey));
    area.setAttribute('data-tx-signature', String(signature));
    APP.txViewState.lastParamsKey = paramsKey;
    APP.txViewState.lastSignature = signature;
    APP.txViewState.lastData = deepClone_(data);
    var txContent = document.getElementById('content');
    if (txContent) setRouteSnapshot_('transactions', txContent.innerHTML);
  }

  function computeStatusParcela_(tx, targetPaidState) {
    if (targetPaidState) return 'PAGA';
    var today = new Date().toISOString().substring(0, 10);
    if (tx && tx.dateRaw && tx.dateRaw < today) return 'ATRASADA';
    return 'PENDENTE';
  }

  function getAffectedTxIdsForScope_(tx, scope) {
    if (!tx || !tx.id) return [];
    if (!scope || scope === 'THIS' || !tx.grupoId) return [tx.id];
    var baseDate = tx.dateRaw || '';
    return (APP.currentTransactions || [])
      .filter(function (item) {
        if (!item || item.grupoId !== tx.grupoId) return false;
        if (scope === 'ALL') return true;
        if (scope === 'FOLLOWING') return (item.dateRaw || '') >= baseDate;
        return false;
      })
      .map(function (item) { return item.id; });
  }

  function snapshotTxStateByIds_(ids) {
    var map = {};
    (APP.currentTransactions || []).forEach(function (tx) {
      if (ids.indexOf(tx.id) === -1) return;
      map[tx.id] = {
        isPaid: !!tx.isPaid,
        statusParcela: tx.statusParcela,
        debitoAutomatico: !!tx.debitoAutomatico
      };
    });
    return map;
  }

  function applyTxStateToCollections_(ids, targetPaidState) {
    var set = {};
    ids.forEach(function (id) { set[id] = true; });

    function applyToList(list) {
      if (!list || !list.length) return;
      list.forEach(function (tx) {
        if (!set[tx.id]) return;
        tx.isPaid = !!targetPaidState;
        tx.debitoAutomatico = targetPaidState ? false : !!tx.debitoAutomatico;
        tx.statusParcela = computeStatusParcela_(tx, targetPaidState);
      });
    }

    applyToList(APP.currentTransactions || []);
    if (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) {
      applyToList(APP.txViewState.lastData.items);
    }
  }

  function applyTxStateToCache_(ids, targetPaidState) {
    if (!APP.cache || !APP.cache.transactions || !APP.cache.transactions.data) return;
    var set = {};
    ids.forEach(function (id) { set[id] = true; });

    Object.keys(APP.cache.transactions.data).forEach(function (cacheKeyName) {
      var entry = APP.cache.transactions.data[cacheKeyName];
      if (!entry || !entry.value || !entry.value.items) return;
      entry.value.items.forEach(function (tx) {
        if (!set[tx.id]) return;
        tx.isPaid = !!targetPaidState;
        tx.debitoAutomatico = targetPaidState ? false : !!tx.debitoAutomatico;
        tx.statusParcela = computeStatusParcela_(tx, targetPaidState);
      });
      entry.ts = Date.now();
    });
    persistCacheSoon_();
  }

  function restoreTxStateFromSnapshot_(snapshotMap) {
    if (!snapshotMap) return;
    var ids = Object.keys(snapshotMap);
    if (!ids.length) return;

    function restoreList(list) {
      if (!list || !list.length) return;
      list.forEach(function (tx) {
        var snap = snapshotMap[tx.id];
        if (!snap) return;
        tx.isPaid = snap.isPaid;
        tx.statusParcela = snap.statusParcela;
        tx.debitoAutomatico = snap.debitoAutomatico;
      });
    }

    restoreList(APP.currentTransactions || []);
    if (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) {
      restoreList(APP.txViewState.lastData.items);
    }
  }

  function rerenderTransactionsFromViewState_() {
    if (APP.route !== 'transactions') return;
    var area = document.getElementById('tx-table-area');
    if (!area || !APP.txViewState || !APP.txViewState.lastData) return;
    renderTransactionsTable_(
      deepClone_(APP.txViewState.lastData),
      area,
      getActiveRouteToken_(),
      APP.txViewState.lastParamsKey || txParamsKey_(buildTxParams_())
    );
  }

  function confirmCompensateTx(txId, targetPaidState) {
    if (targetPaidState === undefined) targetPaidState = true; // Default to pay

    // If trying to unpay (targetPaidState = false), ask confirmation
    // If trying to pay (targetPaidState = true), maybe quick action or confirmation? User likes "Professional", maybe just do it or Toast?
    // Let's try direct action with Toast UNDO logic? No, too complex.
    // Simple confirm is safer.

    var tx = (APP.currentTransactions || []).find(function (t) { return t.id === txId; });
    if (!tx) {
      toast('Transação não encontrada na lista atual.', 'error');
      return;
    }
    if (isCardPurchaseTx_(tx)) {
      toast('Lançamentos de cartão são pagos na fatura. Use o botão "Pagar fatura".', 'warn');
      return;
    }

    var verb = targetPaidState ? 'compensar (marcar como PAGO)' : 'reabrir (marcar como PENDENTE)';
    if (!confirm('Deseja ' + verb + ' esta transação?')) return;

    function applyOptimisticAndSync(scope) {
      var affectedIds = getAffectedTxIdsForScope_(tx, scope);
      var snapshot = snapshotTxStateByIds_(affectedIds);

      // Atualiza imediatamente a UI (optimistic update)
      setTxOptimisticState_(affectedIds, targetPaidState);
      applyTxStateToCollections_(affectedIds, targetPaidState);
      applyTxStateToCache_(affectedIds, targetPaidState);
      rerenderTransactionsFromViewState_();

      var payload = { paid: targetPaidState };
      if (scope && tx.grupoId) payload.scope = scope;

      rpc2('updateTransaction', txId, payload, function () {
        toast('Status atualizado!', 'success');
        // Nao forcar recarga aqui para evitar rollback visual por latencia/consistencia do backend.
        // Invalida outras visoes para recarregar naturalmente ao navegar.
        clearCached('dashboard');
        clearCached('reports');
        clearCached('installmentsDash');
      }, function (err) {
        // Rollback se backend falhar
        clearTxOptimisticState_(affectedIds);
        restoreTxStateFromSnapshot_(snapshot);
        rerenderTransactionsFromViewState_();
        toast(err || 'Erro ao atualizar status.', 'error');
      });
    }

    if (tx && tx.grupoId) {
      openScopeModal('Atualizar Recorrência', 'Confirmar', function (scope) {
        applyOptimisticAndSync(scope);
      });
    } else {
      applyOptimisticAndSync('THIS');
    }
  }

  function getAccountName(id) {
    if (!id) return '';
    var acc = APP.accounts.find(function (a) { return a.id === id; });
    return acc ? acc.nome : id; // fallback pro ID ou texto antigo
  }

  function getAccountNameWithLogo(id) {
    if (!id) return '-';
    var acc = APP.accounts.find(function (a) { return a.id === id; });
    if (!acc) return id;

    var bankInfo = getBankInfo(acc.instituicao, acc.nome);
    var logoHtml = '';

    if (bankInfo.type === 'img') {
      logoHtml = '<img src="' + bankInfo.logo + '" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'inline\'" style="width:16px;height:16px;border-radius:50%;object-fit:cover;vertical-align:middle;margin-right:4px" />' +
        '<span style="display:none">' + (bankInfo.fallback || 'x') + '</span>';
    } else {
      logoHtml = '<span style="font-size:14px;margin-right:4px">' + bankInfo.logo + '</span>';
    }

    return logoHtml + acc.nome;
  }

  function tryCalculate(el) {
    var val = el.value.replace(/,/g, '.'); // Allow comma as decimal separator
    try {
      // Allow only safe chars
      if (/[^0-9+\-*/.()\s]/.test(val)) return;

      // Check if it's an expression
      if (/[\+\-\*\/]/.test(val)) {
        var res = new Function('return ' + val)();
        if (isFinite(res)) {
          el.value = res.toFixed(2);
          // Trigger change event if needed, but we are inside onchange already
        }
      }
    } catch (e) {
      console.error('Calc error', e);
    }
  }

  function parseAmountInput_(rawValue) {
    var raw = String(rawValue || '').trim();
    if (!raw) return NaN;

    // Evita interpretar expressão não resolvida como número.
    if (/[+\-*/()]/.test(raw.replace(/^\s*-/, ''))) return NaN;

    var normalized = raw.replace(/\s/g, '').replace(/R\$/gi, '');
    normalized = normalized.replace(/[^0-9,.\-]/g, '');

    if (normalized.indexOf(',') !== -1) {
      // pt-BR: 1.234,56 -> 1234.56
      normalized = normalized.replace(/\./g, '').replace(',', '.');
    } else {
      // Caso tenha mais de um ponto, assume pontos de milhar e mantém apenas o último decimal.
      var dots = (normalized.match(/\./g) || []).length;
      if (dots > 1) {
        var lastDot = normalized.lastIndexOf('.');
        normalized = normalized.slice(0, lastDot).replace(/\./g, '') + normalized.slice(lastDot);
      }
    }

    var n = parseFloat(normalized);
    return isFinite(n) ? n : NaN;
  }

  //  Transaction Modal 
  function openTransactionModal(presetType, editData) {
    var isEdit = !!editData;
    var title = isEdit ? 'Editar Lançamento' : 'Novo Lançamento';
    var type = presetType || (editData ? editData.type : 'DESPESA'); // Default DESPESA
    var initialCardId = editData ? extractCardIdFromNotes_(editData.notas) : '';
    var initialNotes = editData ? stripCardMarkersFromNotes_(editData.notas || '') : '';
    var isCardExpense = (type === 'DESPESA' && !!initialCardId);

    document.getElementById('modal-title').textContent = title;

    var cats = APP.categories;
    var body = '<div class="type-selector">' +
      '<div class="type-chip' + (type === 'RECEITA' ? ' selected-receita' : '') + '" data-type="RECEITA" onclick="selectTxType(this)">Receita</div>' +
      '<div class="type-chip' + (type === 'DESPESA' ? ' selected-despesa' : '') + '" data-type="DESPESA" onclick="selectTxType(this)">Despesa</div>' +
      '<div class="type-chip' + (type === 'TRANSFER' ? ' selected-transfer' : '') + '" data-type="TRANSFER" onclick="selectTxType(this)">Transferência</div>' +
      '</div>';

    body += '<div class="form-row">' +
      '<div class="form-group"><label class="form-label">Data</label>' +
      '<input type="date" class="form-input" id="tx-date" value="' + (editData ? editData.dateRaw : new Date().toISOString().substring(0, 10)) + '"></div>' +
      '<div class="form-group"><label class="form-label">Valor (R$)</label>' +
      '<input type="text" inputmode="decimal" class="form-input" id="tx-amount" placeholder="0,00 ou ex: 10+20" value="' + (editData ? editData.amount : '') + '" onchange="tryCalculate(this)"></div>' +
      '</div>';

    // Checkbox Pago / Auto Debit
    var isPaid = editData ? editData.isPaid : true; // Default true
    var defaultDate = (editData ? editData.dateRaw : new Date().toISOString().substring(0, 10));

    if (!isEdit && !editData) {
      // Se novo, default true se hoje ou passado
      if (defaultDate > new Date().toISOString().substring(0, 10)) isPaid = false;
    }

    body += '<div class="form-row" style="margin-bottom:16px; align-items:center">' +
      '<label class="checkbox-label" style="display:flex;align-items:center;gap:8px;cursor:pointer">' +
      '<input type="checkbox" id="tx-paid" ' + (isPaid ? 'checked' : '') + '> ' +
      '<span id="lbl-tx-paid">Efetuado / Recebido</span>' +
      '</label>' +

      '<label class="checkbox-label" id="grp-auto-debit" style="display:flex;align-items:center;gap:8px;cursor:pointer;' + (isPaid ? 'display:none' : '') + '">' +
      '<input type="checkbox" id="tx-auto-debit" ' + (editData && editData.debitoAutomatico ? 'checked' : '') + '> ' +
      '<span id="lbl-tx-auto">Automático</span>' +
      '</label>' +
      '</div>';

    // SERVIÇOS DE CONTA (SELECTION)
    body += '<div class="form-row">';

    // Conta Origem (Visível para DESPESA e TRANSFER)
    body += '<div class="form-group" id="grp-from-wallet" style="display:none">' +
      '<label class="form-label">Pagar Com / De</label>' +
      '<select class="form-select" id="tx-from-wallet">' + renderAccountOptions(editData ? editData.fromWalletId : null) + '</select>' +
      '</div>';

    // Conta Destino (Visível para RECEITA e TRANSFER)
    body += '<div class="form-group" id="grp-to-wallet" style="display:none">' +
      '<label class="form-label">Receber Em / Para</label>' +
      '<select class="form-select" id="tx-to-wallet">' + renderAccountOptions(editData ? editData.toWalletId : null) + '</select>' +
      '</div>';

    body += '</div>';

    body += '<div id="tx-card-expense-wrap" style="display:none;margin-bottom:12px">' +
      '<label class="checkbox-label" style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:8px">' +
      '<input type="checkbox" id="tx-card-expense" ' + (isCardExpense ? 'checked' : '') + '> ' +
      '<span>Despesa no Cartão</span>' +
      '</label>' +
      '<div class="form-group" id="grp-card-select" style="display:none">' +
      '<label class="form-label">Cartão</label>' +
      '<select class="form-select" id="tx-card-id">' + renderCardOptions(initialCardId) + '</select>' +
      '<div class="form-hint">Essa despesa entra na fatura do cartão e não movimenta saldo de conta agora.</div>' +
      '</div>' +
      '</div>';

    // Parcelamento (apenas novo e não transf)
    if (!isEdit) {
      body += '<div id="tx-parcela-container" style="display:none">' +
        '<div class="form-group" style="margin-top:8px">' +
        '<label class="checkbox-label" style="display:flex;align-items:center;gap:8px;cursor:pointer">' +
        '<input type="checkbox" id="tx-parcela-enabled" style="cursor:pointer"> ' +
        '<span>Repetir (Parcelado ou Fixo)</span>' +
        '</label></div>';

      body += '<div id="tx-parcela-fields" style="display:none;margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:8px">' +

        // Checkbox Fixo
        '<div class="form-group" style="margin-bottom:12px">' +
        '<label class="checkbox-label" style="display:flex;align-items:center;gap:8px;cursor:pointer">' +
        '<input type="checkbox" id="tx-parcela-fixed" style="cursor:pointer"> ' +
        '<span>"️ Recorrência Infinita (Fixo Mensal)</span>' +
        '</label></div>' +

        '<div class="form-row">' +
        '<div class="form-group" id="grp-parcela-num"><label class="form-label">Número de Meses</label>' +
        '<input type="number" class="form-input" id="tx-parcela-num" min="2" max="120" value="6" placeholder="6">' +
        '<div class="form-hint">Digite quantos meses repetir</div>' +
        '</div>' +
        '<div class="form-group"><label class="form-label">Valor por Mês</label>' +
        '<input type="text" class="form-input" id="tx-parcela-valor" readonly style="background:var(--bg-tertiary)"></div>' +
        '</div>' +
        '</div></div>';
    }

    body += '<div id="tx-category-container" style="display:none">' +
      '<div class="form-group"><label class="form-label">Categoria</label>' +
      '<div class="cat-chips" id="tx-cat-chips"></div></div>' +
      '</div>';

    body += '<div class="form-group"><label class="form-label">Descrição</label>' +
      '<input type="text" class="form-input" id="tx-desc" placeholder="Ex: Uber, 99, gasolina..." value="' + (editData ? (editData.description || '') : '') + '"></div>';

    body += '<div id="tx-payment-km-container" style="display:none">' +
      '<div class="form-row">' +
      '<div class="form-group"><label class="form-label">Forma de Pagamento</label>' +
      '<select class="form-select" id="tx-payment">' +
      '<option value="-">-</option>' +
      '<option value="PIX"' + (editData && editData.paymentMethod === 'PIX' ? ' selected' : '') + '>PIX</option>' +
      '<option value="Dinheiro"' + (editData && editData.paymentMethod === 'Dinheiro' ? ' selected' : '') + '>Dinheiro</option>' +
      '<option value="Débito"' + (editData && editData.paymentMethod === 'Débito' ? ' selected' : '') + '>Débito</option>' +
      '<option value="Crédito"' + (editData && editData.paymentMethod === 'Crédito' ? ' selected' : '') + '>Crédito</option>' +
      '</select></div>' +
      '<div class="form-group"><label class="form-label">KM (opcional)</label>' +
      '<input type="number" class="form-input" id="tx-km" placeholder="0" value="' + (editData ? (editData.km || '') : '') + '"></div>' +
      '</div>' +
      '</div>';

    body += '<div class="form-group">' +
      '<label class="form-label">Notas (opcional)</label>' +
      '<textarea class="form-textarea" id="tx-notas" rows="2" placeholder="Ex: Pedir reembolso, Jantar com cliente...">' +
      initialNotes + '</textarea>' +
      '</div>';

    document.getElementById('modal-body').innerHTML = body;

    // Funções de UI
    renderTxCatChips(type, editData ? editData.categoryId : '');
    updateFieldsVisibility(type); // Configurar visibilidade inicial
    ensureCardOptionsLoaded_(initialCardId);

    // Se for novo e tipo receita/despesa, selecionar conta padrão se não edit
    if (!isEdit && !editData) {
      // Padrão pode ser 'Carteira' ou 'Banco'
      var defaultAcc = APP.accounts.length > 0 ? APP.accounts[0].id : '';
      // Tentar achar conta 'Carteira'
      var c = APP.accounts.find(function (a) { return a.nome === 'Carteira'; });
      if (c) defaultAcc = c.id;

      if (document.getElementById('tx-from-wallet')) document.getElementById('tx-from-wallet').value = defaultAcc;
      if (document.getElementById('tx-to-wallet')) document.getElementById('tx-to-wallet').value = defaultAcc;
    }

    var fromWalletSelect = document.getElementById('tx-from-wallet');
    var toWalletSelect = document.getElementById('tx-to-wallet');
    if (fromWalletSelect) {
      applyWalletSelectLogo('tx-from-wallet');
      fromWalletSelect.addEventListener('change', function () {
        applyWalletSelectLogo('tx-from-wallet');
      });
    }
    if (toWalletSelect) {
      applyWalletSelectLogo('tx-to-wallet');
      toWalletSelect.addEventListener('change', function () {
        applyWalletSelectLogo('tx-to-wallet');
      });
    }

    // Event handlers
    document.getElementById('tx-paid').addEventListener('change', function () {
      var autoDebitGrp = document.getElementById('grp-auto-debit');
      if (this.checked) {
        autoDebitGrp.style.display = 'none';
        document.getElementById('tx-auto-debit').checked = false;
      } else {
        autoDebitGrp.style.display = 'flex';
      }
    });

    document.getElementById('tx-date').addEventListener('change', function () {
      if (isEdit) return; // Não mudar status automaticamente na edição
      if ((document.getElementById('tx-card-expense') || {}).checked) return;
      var d = this.value;
      var today = new Date().toISOString().substring(0, 10);
      var paidChk = document.getElementById('tx-paid');

      // Se data <= hoje, sugere pago. Se futuro, sugere pendente
      if (d <= today) {
        paidChk.checked = true;
        paidChk.dispatchEvent(new Event('change'));
      } else {
        paidChk.checked = false;
        paidChk.dispatchEvent(new Event('change'));
      }
    });

    var cardExpenseChk = document.getElementById('tx-card-expense');
    if (cardExpenseChk) {
      cardExpenseChk.addEventListener('change', function () {
        updateCardExpenseUi_(getSelectedType());
      });
    }

    if (!isEdit) {
      var parcelaCheckbox = document.getElementById('tx-parcela-enabled');
      var parcelaFields = document.getElementById('tx-parcela-fields');
      var fixedCheckbox = document.getElementById('tx-parcela-fixed');
      var numField = document.getElementById('grp-parcela-num');

      parcelaCheckbox.addEventListener('change', function () {
        parcelaFields.style.display = this.checked ? 'block' : 'none';
        if (this.checked) updateParcelaValue();
      });

      fixedCheckbox.addEventListener('change', function () {
        if (this.checked) {
          numField.style.display = 'none';
        } else {
          numField.style.display = 'block';
        }
        updateParcelaValue();
      });

      document.getElementById('tx-amount').addEventListener('input', function () {
        if (parcelaCheckbox.checked) updateParcelaValue();
      });

      document.getElementById('tx-parcela-num').addEventListener('change', updateParcelaValue);
    }

    var footer = '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="tx-save-btn">' + (isEdit ? 'Salvar' : 'Criar') + '</button>';
    document.getElementById('modal-footer').innerHTML = footer;

    document.getElementById('tx-save-btn').addEventListener('click', function () {
      saveTx(isEdit, editData ? editData.id : null);
    });

    openModal();
  }

  function renderAccountOptions(selectedId) {
    var html = '';
    // Ordenar contas
    var sorted = APP.accounts.slice().sort(function (a, b) { return (a.ordem || 99) - (b.ordem || 99); });

    sorted.forEach(function (acc) {
      if (!acc.ativo) return;
      var sel = (selectedId === acc.id) ? 'selected' : '';
      html += '<option value="' + acc.id + '" ' + sel + '>' + acc.nome + '</option>';
    });
    return html;
  }

  function applyWalletSelectLogo(selectId) {
    var selectEl = document.getElementById(selectId);
    if (!selectEl) return;

    var selectedId = selectEl.value;
    var acc = APP.accounts.find(function (a) { return a.id === selectedId; });
    if (!acc) {
      selectEl.style.backgroundImage = '';
      selectEl.style.paddingLeft = '';
      return;
    }

    var bankInfo = getBankInfo(acc.instituicao, acc.nome);
    if (bankInfo.type === 'img' && bankInfo.logo) {
      selectEl.style.backgroundImage = 'url("' + bankInfo.logo + '")';
      selectEl.style.backgroundRepeat = 'no-repeat';
      selectEl.style.backgroundPosition = '12px center';
      selectEl.style.backgroundSize = '20px 20px';
      selectEl.style.paddingLeft = '40px';
    } else {
      selectEl.style.backgroundImage = '';
      selectEl.style.paddingLeft = '';
    }
  }

  function updateFieldsVisibility(type) {
    var fFrom = document.getElementById('grp-from-wallet');
    var fTo = document.getElementById('grp-to-wallet');
    var cat = document.getElementById('tx-category-container');
    var parc = document.getElementById('tx-parcela-container');
    var pay = document.getElementById('tx-payment-km-container');
    var cardWrap = document.getElementById('tx-card-expense-wrap');

    // Labels dinâmicos
    var lblPaid = document.getElementById('lbl-tx-paid');
    var lblAuto = document.getElementById('lbl-tx-auto');

    if (type === 'RECEITA') {
      fFrom.style.display = 'none';
      fTo.style.display = 'block';
      cat.style.display = 'block';
      if (parc) parc.style.display = 'block';
      pay.style.display = 'block';
      if (cardWrap) cardWrap.style.display = 'none';

      if (lblPaid) lblPaid.textContent = 'Recebido / Efetuado';
      if (lblAuto) lblAuto.textContent = 'Automático';

    } else if (type === 'DESPESA') {
      fFrom.style.display = 'block';
      fTo.style.display = 'none';
      cat.style.display = 'block';
      if (parc) parc.style.display = 'block';
      pay.style.display = 'block';
      if (cardWrap) cardWrap.style.display = 'block';

      if (lblPaid) lblPaid.textContent = 'Pago / Efetuado';
      if (lblAuto) lblAuto.textContent = 'Débito Automático';

    } else if (type === 'TRANSFER') {
      fFrom.style.display = 'block';
      fTo.style.display = 'block';
      cat.style.display = 'none';
      if (parc) parc.style.display = 'none';
      pay.style.display = 'none';
      if (cardWrap) cardWrap.style.display = 'none';

      if (lblPaid) lblPaid.textContent = 'Efetuado';
      if (lblAuto) lblAuto.textContent = 'Automático';
    }
    updateCardExpenseUi_(type);
  }

  function updateCardExpenseUi_(type) {
    var chk = document.getElementById('tx-card-expense');
    var grpCard = document.getElementById('grp-card-select');
    var fFrom = document.getElementById('grp-from-wallet');
    var paid = document.getElementById('tx-paid');
    var auto = document.getElementById('tx-auto-debit');
    var autoGrp = document.getElementById('grp-auto-debit');
    var paySel = document.getElementById('tx-payment');
    var kmInp = document.getElementById('tx-km');
    var parcelaFixed = document.getElementById('tx-parcela-fixed');
    var grpParcelaNum = document.getElementById('grp-parcela-num');
    var isCardExpense = (type === 'DESPESA' && chk && chk.checked);

    if (grpCard) grpCard.style.display = isCardExpense ? 'block' : 'none';

    if (!isCardExpense) {
      if (paid) paid.disabled = false;
      if (auto) auto.disabled = false;
      if (paySel) paySel.disabled = false;
      if (kmInp) kmInp.disabled = false;
      if (type === 'DESPESA' && fFrom) fFrom.style.display = 'block';
      if (type === 'DESPESA' && autoGrp && paid) autoGrp.style.display = paid.checked ? 'none' : 'flex';
      if (parcelaFixed) parcelaFixed.disabled = false;
      if (grpParcelaNum && document.getElementById('tx-parcela-enabled') && document.getElementById('tx-parcela-enabled').checked) {
        grpParcelaNum.style.display = (parcelaFixed && parcelaFixed.checked) ? 'none' : 'block';
      }
      return;
    }

    if (fFrom) fFrom.style.display = 'none';
    if (paid) {
      paid.checked = false;
      paid.disabled = true;
    }
    if (auto) {
      auto.checked = false;
      auto.disabled = true;
    }
    if (autoGrp) autoGrp.style.display = 'none';
    if (paySel) {
      paySel.value = 'Crédito';
      paySel.disabled = true;
    }
    if (kmInp) {
      kmInp.value = '';
      kmInp.disabled = true;
    }
    if (parcelaFixed) {
      parcelaFixed.checked = false;
      parcelaFixed.disabled = true;
    }
    if (grpParcelaNum) grpParcelaNum.style.display = 'block';
  }

  function updateParcelaValue() {
    var amount = parseAmountInput_(document.getElementById('tx-amount').value);
    if (!isFinite(amount)) amount = 0;
    var isFixed = document.getElementById('tx-parcela-fixed') && document.getElementById('tx-parcela-fixed').checked;

    var numParcelas = 1;
    if (!isFixed) {
      numParcelas = parseInt(document.getElementById('tx-parcela-num').value) || 1;
    }

    var valorParcela = amount / numParcelas;
    document.getElementById('tx-parcela-valor').value = fmtCurrency(valorParcela);
  }

  function selectTxType(el) {
    document.querySelectorAll('.type-chip').forEach(function (c) {
      c.classList.remove('selected-receita', 'selected-despesa', 'selected-transfer');
    });
    var type = el.getAttribute('data-type');
    el.classList.add('selected-' + type.toLowerCase());

    // Atualizar visibilidade
    updateFieldsVisibility(type);

    // Re-render categories if not transfer
    if (type !== 'TRANSFER') {
      renderTxCatChips(type, '');
    }
  }

  function renderTxCatChips(type, selectedId) {
    var container = document.getElementById('tx-cat-chips');
    if (!container) return;
    var cats = APP.categories.filter(function (c) {
      if (!type) return true;
      return c.applicableType === type || c.applicableType === 'AMBOS';
    });

    container.innerHTML = '';
    cats.forEach(function (c) {
      var chip = document.createElement('span');
      chip.className = 'cat-chip' + (c.id === selectedId ? ' selected' : '');
      chip.style.color = c.colorHex;
      chip.style.borderColor = c.id === selectedId ? c.colorHex : '';
      chip.setAttribute('data-id', c.id);
      chip.innerHTML = c.emoji + ' ' + c.name;
      chip.addEventListener('click', function () {
        container.querySelectorAll('.cat-chip').forEach(function (ch) {
          ch.classList.remove('selected');
          ch.style.borderColor = '';
        });
        this.classList.add('selected');
        this.style.borderColor = c.colorHex;
      });
      container.appendChild(chip);
    });
  }

  function getSelectedType() {
    var sel = document.querySelector('.type-chip.selected-receita,.type-chip.selected-despesa,.type-chip.selected-transfer');
    return sel ? sel.getAttribute('data-type') : '';
  }

  function getSelectedCatId() {
    var sel = document.querySelector('#tx-cat-chips .cat-chip.selected');
    return sel ? sel.getAttribute('data-id') : '';
  }

  function buildOptimisticTxFromPayload_(payload, txId) {
    var cat = null;
    if (payload && payload.categoryId) {
      cat = (APP.categories || []).find(function (c) { return String(c.id) === String(payload.categoryId); }) || null;
    }
    var dateRaw = String(payload.date || '');
    var statusParcela = payload.paid ? 'PAGA' : (dateRaw && dateRaw < new Date().toISOString().substring(0, 10) ? 'ATRASADA' : 'PENDENTE');
    var cardId = extractCardIdFromNotes_(payload.notas || '');
    var cardName = '';
    if (cardId && APP.cartoesBootData && APP.cartoesBootData.cartoes) {
      var card = APP.cartoesBootData.cartoes.find(function (c) { return String(c.id) === String(cardId); });
      cardName = card ? String(card.nome || '') : '';
    }
    return {
      id: txId || ('tmp_' + Date.now()),
      date: dateRaw ? dateRaw.split('-').reverse().join('/') : '',
      dateRaw: dateRaw,
      type: payload.type || '',
      categoryId: payload.categoryId || '',
      categoryName: cat ? cat.name : '',
      categoryEmoji: cat ? cat.emoji : '',
      categoryColor: cat ? cat.colorHex : '#999999',
      description: payload.description || '',
      amount: parseFloat(payload.amount) || 0,
      paymentMethod: payload.paymentMethod || '-',
      km: payload.km || '',
      statusParcela: statusParcela,
      grupoId: '',
      numero: '',
      total: '',
      notas: payload.notas || '',
      cardId: cardId,
      cardName: cardName,
      fromWalletId: payload.fromWalletId || '',
      toWalletId: payload.toWalletId || '',
      debitoAutomatico: !!payload.autoDebit,
      isPaid: !!payload.paid
    };
  }

  function applyTxOptimisticCreate_(txItem) {
    if (!txItem) return;
    var params = buildTxParams_();
    if (!txMatchesFilters_(txItem, params)) return;
    if (params.page && parseInt(params.page, 10) !== 1) return;
    if (APP.currentTransactions && APP.currentTransactions.some(function (t) { return String(t.id) === String(txItem.id); })) return;
    APP.currentTransactions = APP.currentTransactions || [];
    APP.currentTransactions.unshift(txItem);
    if (APP.currentTransactions.length > APP.txPageSize) APP.currentTransactions = APP.currentTransactions.slice(0, APP.txPageSize);
    if (!APP.txViewState) APP.txViewState = {};
    APP.txViewState.lastData = APP.txViewState.lastData || { items: [], page: 1, totalPages: 1, total: 0 };
    APP.txViewState.lastData.items = APP.currentTransactions.slice();
    APP.txViewState.lastData.page = 1;
    APP.txViewState.lastData.total = Math.max(parseInt(APP.txViewState.lastData.total || 0, 10), APP.currentTransactions.length);
    APP.txViewState.lastData.totalPages = Math.max(1, Math.ceil(APP.txViewState.lastData.total / APP.txPageSize));
    APP.txViewState.lastParamsKey = txParamsKey_(params);
    rerenderTransactionsFromViewState_();
  }

  function applyTxOptimisticUpdate_(txId, payload) {
    if (!txId || !payload) return;
    var today = new Date().toISOString().substring(0, 10);
    function applyToList(list) {
      if (!list || !list.length) return;
      list.forEach(function (tx) {
        if (String(tx.id) !== String(txId)) return;
        if (payload.date) {
          tx.dateRaw = payload.date;
          tx.date = String(payload.date).split('-').reverse().join('/');
        }
        if (payload.type) tx.type = payload.type;
        if (payload.description !== undefined) tx.description = payload.description;
        if (payload.amount !== undefined) tx.amount = parseFloat(payload.amount) || 0;
        if (payload.paymentMethod !== undefined) tx.paymentMethod = payload.paymentMethod || '-';
        if (payload.km !== undefined) tx.km = payload.km;
        if (payload.categoryId !== undefined) {
          tx.categoryId = payload.categoryId || '';
          var cat = (APP.categories || []).find(function (c) { return String(c.id) === String(tx.categoryId); });
          tx.categoryName = cat ? cat.name : tx.categoryName;
          tx.categoryEmoji = cat ? cat.emoji : tx.categoryEmoji;
          tx.categoryColor = cat ? cat.colorHex : tx.categoryColor;
        }
        if (payload.fromWalletId !== undefined) tx.fromWalletId = payload.fromWalletId || '';
        if (payload.toWalletId !== undefined) tx.toWalletId = payload.toWalletId || '';
        if (payload.notas !== undefined) {
          tx.notas = payload.notas || '';
          tx.cardId = extractCardIdFromNotes_(tx.notas);
          if (tx.cardId && APP.cartoesBootData && APP.cartoesBootData.cartoes) {
            var card = APP.cartoesBootData.cartoes.find(function (c) { return String(c.id) === String(tx.cardId); });
            tx.cardName = card ? String(card.nome || '') : '';
          } else {
            tx.cardName = '';
          }
        }
        if (payload.paid !== undefined) tx.isPaid = !!payload.paid;
        if (payload.autoDebit !== undefined) tx.debitoAutomatico = !!payload.autoDebit;
        if (!tx.isPaid) tx.statusParcela = tx.dateRaw && tx.dateRaw < today ? 'ATRASADA' : 'PENDENTE';
        if (tx.isPaid) tx.statusParcela = 'PAGA';
      });
    }
    applyToList(APP.currentTransactions || []);
    if (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) {
      applyToList(APP.txViewState.lastData.items);
    }
    rerenderTransactionsFromViewState_();
  }

  function applyTxOptimisticDelete_(ids) {
    ids = (ids || []).map(function (id) { return String(id); });
    if (!ids.length) return null;
    var set = {};
    ids.forEach(function (id) { set[id] = true; });
    var snapshot = {
      currentTransactions: deepClone_(APP.currentTransactions || []),
      txViewData: deepClone_(APP.txViewState && APP.txViewState.lastData ? APP.txViewState.lastData : null)
    };
    APP.currentTransactions = (APP.currentTransactions || []).filter(function (tx) { return !set[String(tx.id)]; });
    if (APP.txViewState && APP.txViewState.lastData && APP.txViewState.lastData.items) {
      APP.txViewState.lastData.items = APP.txViewState.lastData.items.filter(function (tx) { return !set[String(tx.id)]; });
      APP.txViewState.lastData.total = Math.max(0, (parseInt(APP.txViewState.lastData.total || 0, 10) - ids.length));
      APP.txViewState.lastData.totalPages = Math.max(1, Math.ceil((APP.txViewState.lastData.total || 0) / APP.txPageSize));
    }
    rerenderTransactionsFromViewState_();
    return snapshot;
  }

  function restoreTxOptimisticDelete_(snapshot) {
    if (!snapshot) return;
    if (snapshot.currentTransactions) APP.currentTransactions = deepClone_(snapshot.currentTransactions);
    if (APP.txViewState && snapshot.txViewData) APP.txViewState.lastData = deepClone_(snapshot.txViewData);
    rerenderTransactionsFromViewState_();
  }

  function saveTx(isEdit, editId) {
    var type = getSelectedType();
    var date = document.getElementById('tx-date').value;
    var amount = document.getElementById('tx-amount').value;
    var desc = document.getElementById('tx-desc').value;
    var payment = document.getElementById('tx-payment').value;
    var km = document.getElementById('tx-km').value;

    if (!type) { toast('Selecione uma opção.', 'error'); return; }
    if (!date) {
      date = new Date().toISOString().substring(0, 10);
      var dateEl = document.getElementById('tx-date');
      if (dateEl) dateEl.value = date;
    }
    // Forçar cálculo se houver expressão pendente
    var amountEl = document.getElementById('tx-amount');
    tryCalculate(amountEl);
    var amount = amountEl.value;
    var amountNum = parseAmountInput_(amount);
    var isCardExpense = (type === 'DESPESA' && (document.getElementById('tx-card-expense') || {}).checked);

    if (!isFinite(amountNum) || amountNum < 0 || (amountNum === 0 && !isCardExpense)) {
      alert(isCardExpense ? 'Informe um valor válido (maior ou igual a zero).' : 'Informe um valor válido.');
      return;
    }

    var btn = document.getElementById('tx-save-btn');
    btn.disabled = true;
    btn.textContent = 'Salvando...';

    var rawNotes = document.getElementById('tx-notas').value;
    var cleanNotes = stripCardMarkersFromNotes_(rawNotes);
    var payload = {
      date: date,
      type: type,
      amount: amountNum,
      description: desc,
      paymentMethod: payment,
      km: km ? parseFloat(km) : '',
      notas: cleanNotes,
      paid: document.getElementById('tx-paid').checked,
      autoDebit: document.getElementById('tx-auto-debit').checked
    };

    var fromWallet = document.getElementById('tx-from-wallet');
    var toWallet = document.getElementById('tx-to-wallet');

    if (type === 'RECEITA') payload.toWalletId = toWallet.value;
    else if (type === 'DESPESA') payload.fromWalletId = fromWallet.value;
    else if (type === 'TRANSFER') {
      payload.fromWalletId = fromWallet.value;
      payload.toWalletId = toWallet.value;
      if (payload.fromWalletId === payload.toWalletId) {
        toast('Origem e Destino devem ser diferentes.', 'error');
        btn.disabled = false; btn.textContent = 'Salvar'; return;
      }
    }

    if (type !== 'TRANSFER') {
      var catId = getSelectedCatId();
      if (!catId) { toast('Selecione uma categoria.', 'error'); btn.disabled = false; btn.textContent = 'Salvar'; return; }
      payload.categoryId = catId;
    } else {
      payload.categoryId = '';
      if (!desc) payload.description = 'Transferência';
    }

    if (isCardExpense) {
      var cardId = (document.getElementById('tx-card-id') || {}).value || '';
      if (!cardId) {
        toast('Selecione o cartão para registrar a despesa.', 'error');
        btn.disabled = false;
        btn.textContent = isEdit ? 'Salvar' : 'Criar';
        return;
      }
      payload.fromWalletId = '';
      payload.paid = false;
      payload.autoDebit = false;
      payload.paymentMethod = 'Crédito';
      payload.km = '';
      payload.notas = (cleanNotes ? (cleanNotes + '\n') : '') + '[CARTAO_ID:' + cardId + ']';
    }

    if (!isEdit && type !== 'TRANSFER') {
      var parcelaCheckbox = document.getElementById('tx-parcela-enabled');
      if (parcelaCheckbox && parcelaCheckbox.checked) {
        var isFixed = document.getElementById('tx-parcela-fixed').checked;
        if (isCardExpense && isFixed) {
          toast('Cartão não permite recorrência infinita. Informe número de parcelas.', 'error');
          btn.disabled = false;
          btn.textContent = isEdit ? 'Salvar' : 'Criar';
          return;
        }
        if (isFixed) {
          payload.numParcelas = -1; // Infinite / Fixed
        } else {
          payload.numParcelas = parseInt(document.getElementById('tx-parcela-num').value);
        }
      }
    }

    if (isEdit) {
      if (APP.currentEditTx && APP.currentEditTx.grupoId) {
        openScopeModal('Editar Recorrência', 'Salvar Alterações', function (scope) {
          payload.scope = scope;
          performUpdate(editId, payload, btn);
        });
        btn.disabled = false;
        btn.textContent = 'Salvar';
      } else {
        performUpdate(editId, payload, btn);
      }
    } else {
      performCreate(payload, btn);
    }
  }

  function performUpdate(id, payload, btn) {
    rpc2('updateTransaction', id, payload, function () {
      toast('Lançamento atualizado!', 'success');
      closeModal();
      refreshCardsBootCache_();
      if (APP.route === 'transactions') {
        applyTxOptimisticUpdate_(id, payload);
        setTimeout(function () { loadTransactions(getActiveRouteToken_()); }, 80);
      } else {
        refreshCurrentView();
      }
    }, function (err) {
      toast(err, 'error');
      btn.disabled = false; btn.textContent = 'Salvar';
    });
  }

  function performCreate(payload, btn) {
    var optimisticId = 'tmp_' + Date.now();
    var optimisticTx = buildOptimisticTxFromPayload_(payload, optimisticId);
    var dashboardSnapshot = snapshotDashboardOptimisticState_();

    if (APP.route === 'transactions' && (!payload.numParcelas || payload.numParcelas <= 1)) {
      applyTxOptimisticCreate_(optimisticTx);
    }
    if (!payload.numParcelas || payload.numParcelas <= 1) {
      applyDashboardTxOptimisticDelta_(optimisticTx, +1);
    }
    closeModal();
    setRealtimeSyncState_(true, 'Salvando lançamento...');

    rpc('createTransaction', payload, function (result) {
      setRealtimeSyncState_(false);
      if (payload.numParcelas && payload.numParcelas > 1) {
        toast('Criadas ' + result.parcelas + ' parcelas!', 'success');
      } else {
        toast('Lançamento criado!', 'success');
      }
      reconcileDashboardAfterTxMutation_();
      if (APP.route === 'transactions') {
        setTimeout(function () { loadTransactions(getActiveRouteToken_()); }, 80);
      } else if (APP.route !== 'dashboard') {
        refreshCurrentView();
      }
    }, function (err) {
      setRealtimeSyncState_(false);
      toast(err, 'error');
      restoreDashboardOptimisticState_(dashboardSnapshot);
      if (APP.route === 'transactions' && APP.currentTransactions && APP.currentTransactions.length) {
        APP.currentTransactions = APP.currentTransactions.filter(function (tx) { return String(tx.id) !== String(optimisticId); });
        if (APP.txViewState && APP.txViewState.lastData) {
          APP.txViewState.lastData.items = APP.currentTransactions.slice();
        }
        rerenderTransactionsFromViewState_();
      }
      if (btn) { btn.disabled = false; btn.textContent = 'Criar'; }
    });
  }

  function openEditTxModal(txId) {
    var localTx = (APP.currentTransactions || []).find(function (t) { return String(t.id) === String(txId); });
    if (localTx) {
      APP.currentEditTx = localTx;
      openTransactionModal(localTx.type, localTx);
      return;
    }
    rpc('listTransactions', {
      month: APP.month, year: APP.year,
      page: 1, pageSize: 999
    }, function (data) {
      var tx = null;
      data.items.forEach(function (t) { if (t.id === txId) tx = t; });
      if (tx) {
        APP.currentEditTx = tx;
        openTransactionModal(tx.type, tx);
      } else {
        toast('Lançamento não encontrado.', 'error');
      }
    });
  }

  function confirmDeleteTx(txId) {
    var tx = null;
    if (APP.currentTransactions) {
      tx = APP.currentTransactions.find(function (t) { return t.id === txId; });
    }

    function applyDeleteOptimistic_(idsToDelete, txList, onRollbackHolder) {
      var txSnap = applyTxOptimisticDelete_(idsToDelete);
      var dashSnap = snapshotDashboardOptimisticState_();
      (txList || []).forEach(function (item) {
        applyDashboardTxOptimisticDelta_(item, -1);
      });
      if (onRollbackHolder) {
        onRollbackHolder.txSnap = txSnap;
        onRollbackHolder.dashSnap = dashSnap;
      }
    }

    if (tx && tx.grupoId) {
      openScopeModal('Excluir Recorrência', 'Excluir', function (scope) {
        var affectedIds = getAffectedTxIdsForScope_(tx, scope);
        var set = {};
        affectedIds.forEach(function (id) { set[String(id)] = true; });
        var affectedTx = (APP.currentTransactions || []).filter(function (item) { return set[String(item.id)]; });
        var rollback = {};
        applyDeleteOptimistic_(affectedIds, affectedTx, rollback);
        setRealtimeSyncState_(true, 'Excluindo lançamento...');

        rpc2('deleteTransaction', txId, scope, function () {
          setRealtimeSyncState_(false);
          toast('Exclusão realizada!', 'success');
          reconcileDashboardAfterTxMutation_();
          if (APP.route === 'transactions') {
            setTimeout(function () { loadTransactions(getActiveRouteToken_()); }, 80);
          } else if (APP.route !== 'dashboard') {
            refreshCurrentView();
          }
        }, function (err) {
          setRealtimeSyncState_(false);
          restoreTxOptimisticDelete_(rollback.txSnap);
          restoreDashboardOptimisticState_(rollback.dashSnap);
          toast(err || 'Erro ao excluir.', 'error');
        });
      });
      return;
    }

    document.getElementById('modal-title').textContent = 'Confirmar Exclusão';
    document.getElementById('modal-body').innerHTML =
      '<p class="confirm-text">Tem certeza que deseja excluir este lançamento? Esta ação não pode ser desfeita.</p>';
    document.getElementById('modal-footer').innerHTML =
      '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-danger" id="confirm-del-btn">Excluir</button>';

    document.getElementById('confirm-del-btn').addEventListener('click', function () {
      this.disabled = true;
      this.textContent = 'Excluindo...';
      var rollback = {};
      if (tx) applyDeleteOptimistic_([txId], [tx], rollback);
      closeModal();
      setRealtimeSyncState_(true, 'Excluindo lançamento...');

      rpc('deleteTransaction', txId, function () {
        setRealtimeSyncState_(false);
        toast('Lançamento excluído!', 'success');
        reconcileDashboardAfterTxMutation_();
        if (APP.route === 'transactions') {
          setTimeout(function () { loadTransactions(getActiveRouteToken_()); }, 80);
        } else if (APP.route !== 'dashboard') {
          refreshCurrentView();
        }
      }, function (err) {
        setRealtimeSyncState_(false);
        restoreTxOptimisticDelete_(rollback.txSnap);
        restoreDashboardOptimisticState_(rollback.dashSnap);
        toast(err || 'Erro ao excluir.', 'error');
        var b = document.getElementById('confirm-del-btn');
        if (b) {
          b.disabled = false;
          b.textContent = 'Excluir';
        }
      });
    });
    openModal();
  }

  function confirmMarkAsPaid(txId) {
    document.getElementById('modal-title').textContent = 'Marcar como Paga';
    document.getElementById('modal-body').innerHTML =
      '<p class="confirm-text">Confirmar pagamento desta parcela?</p>' +
      '<div class="form-group" style="margin-top:12px"><label class="form-label">Data de Pagamento</label>' +
      '<input type="date" class="form-input" id="mark-paid-date" value="' + new Date().toISOString().substring(0, 10) + '"></div>';
    document.getElementById('modal-footer').innerHTML =
      '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="confirm-mark-paid-btn">S Marcar como Paga</button>';

    document.getElementById('confirm-mark-paid-btn').addEventListener('click', function () {
      this.disabled = true;
      this.textContent = 'Marcando...';
      var dataPagamento = document.getElementById('mark-paid-date').value;
      rpc('markInstallmentAsPaid', { id: txId, dataPagamento: dataPagamento }, function () {
        toast('Parcela marcada como paga!', 'success');
        closeModal();
        refreshCurrentView();
      });
    });
    openModal();
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // INSTALLMENTS DASHBOARD
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderInstallmentsDashboard(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var area = document.getElementById('content');

    // Header
    var html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">' +
      '<h2 style="font-size:20px;font-weight:700">Gestão de Parcelas</h2>' +
      '</div>';

    if (!applyRouteSnapshot_('installments', area)) {
      area.innerHTML = html + '<div class="empty-state"><div class="empty-text">Carregando parcelas...</div></div>';
    }

    // Buscar todas as parcelas agrupadas
    rpc('listTransactions', { month: APP.month, year: APP.year, page: 1, pageSize: 1000 }, function (data) {
      if (!isRouteTokenValid_(routeToken)) return;
      // Agrupar parcelas por GrupoId
      var grupos = {};
      var kpiData = {
        pendentesMes: 0,
        totalPendente: 0,
        atrasadas: 0,
        proximaData: null,
        proximaValor: 0
      };

      var hoje = new Date();
      var hojeStr = hoje.toISOString().substring(0, 10);
      var mesAtualStr = hojeStr.substring(0, 7);

      data.items.forEach(function (tx) {
        if (!tx.grupoId) return; // Pular transações únicas

        var gId = tx.grupoId;
        if (!grupos[gId]) {
          grupos[gId] = {
            grupoId: gId,
            descricao: (tx.description || '').replace(/\s*\(\d+\/\d+\)$/, ''),
            categoria: {
              name: tx.categoryName,
              emoji: tx.categoryEmoji,
              color: tx.categoryColor
            },
            tipo: tx.type,
            parcelas: []
          };
        }

        grupos[gId].parcelas.push(tx);

        // Calcular KPIs
        if (tx.statusParcela === 'PENDENTE') {
          var vencMes = tx.dateRaw ? tx.dateRaw.substring(0, 7) : '';
          if (vencMes === mesAtualStr) {
            kpiData.pendentesMes++;
          }
          kpiData.totalPendente += tx.amount;

          if (tx.dateRaw < hojeStr) {
            kpiData.atrasadas++;
          }

          // Próxima parcela
          if (!kpiData.proximaData || tx.dateRaw < kpiData.proximaData) {
            kpiData.proximaData = tx.dateRaw;
            kpiData.proximaValor = tx.amount;
          }
        }
      });

      // Calcular dias até próxima
      var diasProxima = 0;
      if (kpiData.proximaData) {
        var proxData = new Date(kpiData.proximaData + 'T00:00:00');
        diasProxima = Math.ceil((proxData - hoje) / (1000 * 60 * 60 * 24));
      }

      // Renderizar KPIs
      html = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">' +
        '<h2 style="font-size:20px;font-weight:700">Gestão de Parcelas</h2>' +
        '</div>';

      html += '<div class="kpi-grid">';
      html += kpiCard('x9', kpiData.pendentesMes.toString(), 'Pendentes este Mês', 'warning');
      html += kpiCard('x', fmtCurrency(kpiData.totalPendente), 'Total Pendente', 'info');
      html += kpiCard('a️', kpiData.atrasadas.toString(), 'Atrasadas', kpiData.atrasadas > 0 ? 'negative' : 'positive');
      html += kpiCard('PRX', diasProxima > 0 ? 'em ' + diasProxima + ' dias' : kpiData.proximaValor ? 'Hoje' : '-', 'Próxima Parcela', 'accent');
      html += '</div>';

      // Lista de grupos
      var gruposArray = Object.keys(grupos).map(function (k) { return grupos[k]; });

      if (gruposArray.length === 0) {
        html += '<div class="empty-state"><div class="empty-icon">x</div>' +
          '<div class="empty-text">Nenhuma parcela encontrada neste mês</div></div>';
      } else {
        html += '<div class="section-card">';
        html += '<div class="section-title">x` Grupos de Parcelas (' + gruposArray.length + ')</div>';

        gruposArray.forEach(function (grupo) {
          // Calcular estatísticas do grupo
          var pagas = 0, pendentes = 0, atrasadas = 0, canceladas = 0;
          var total = grupo.parcelas.length;
          var valorTotal = 0;
          var proximaParcela = null;

          grupo.parcelas.sort(function (a, b) {
            return (a.numero || 0) - (b.numero || 0);
          });

          grupo.parcelas.forEach(function (p) {
            valorTotal += p.amount;
            if (p.statusParcela === 'PAGA') pagas++;
            else if (p.statusParcela === 'CANCELADA') canceladas++;
            else if (p.statusParcela === 'PENDENTE') {
              pendentes++;
              if (p.dateRaw < hojeStr) atrasadas++;
              if (!proximaParcela) proximaParcela = p;
            }
          });

          var progresso = total > 0 ? Math.round((pagas / total) * 100) : 0;

          // Card do grupo
          html += '<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px">';

          // Header
          html += '<div style="display:flex;align-items:start;gap:12px;margin-bottom:12px">';
          html += '<span style="font-size:24px">' + grupo.categoria.emoji + '</span>';
          html += '<div style="flex:1">';
          html += '<div style="font-weight:600;font-size:14px;margin-bottom:4px">' + grupo.descricao + '</div>';
          html += '<div style="font-size:12px;color:var(--text-secondary)">';
          html += grupo.categoria.name + ' ⬢ ';
          html += total + ' parcelas ⬢ ';
          html += fmtCurrency(valorTotal) + ' total';
          html += '</div>';
          html += '</div>';
          html += '</div>';

          // Barra de progresso
          html += '<div style="margin-bottom:12px">';
          html += '<div style="background:var(--bg-input);height:8px;border-radius:4px;overflow:hidden">';
          html += '<div style="background:var(--success);height:100%;width:' + progresso + '%;transition:width 0.3s"></div>';
          html += '</div>';
          html += '<div style="font-size:11px;color:var(--text-secondary);margin-top:4px">';
          html += pagas + ' de ' + total + ' pagas (' + progresso + '%)';
          html += '</div>';
          html += '</div>';

          // Estatísticas
          html += '<div style="display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap">';
          html += '<span class="payment-badge payment-badge-paga">' + pagas + ' Pagas</span>';
          html += '<span class="payment-badge payment-badge-pendente">' + pendentes + ' Pendentes</span>';
          if (atrasadas > 0) {
            html += '<span class="payment-badge payment-badge-atrasada">' + atrasadas + ' Atrasadas</span>';
          }
          if (canceladas > 0) {
            html += '<span class="payment-badge payment-badge-cancelada">' + canceladas + ' Canceladas</span>';
          }
          html += '</div>';

          // Próxima parcela
          if (proximaParcela) {
            html += '<div style="background:rgba(108,99,255,0.08);padding:10px;border-radius:8px;margin-bottom:12px">';
            html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px">PRXIMA PARCELA:</div>';
            html += '<div style="display:flex;justify-content:space-between;align-items:center">';
            html += '<span style="font-size:13px;font-weight:600">' + proximaParcela.date + '</span>';
            html += '<span style="font-size:14px;font-weight:700;color:var(--accent)">' + fmtCurrency(proximaParcela.amount) + '</span>';
            html += '</div>';
            html += '</div>';
          }

          // Botões de ação
          html += '<div style="display:flex;gap:8px;flex-wrap:wrap">';
          html += '<button class="btn-secondary btn-sm" onclick="viewInstallmentGroup(\'' + grupo.grupoId + '\')">x9 Ver Detalhes</button>';
          if (proximaParcela) {
            html += '<button class="btn-primary btn-sm" onclick="confirmMarkAsPaid(\'' + proximaParcela.id + '\')">S Pagar Próxima</button>';
          }
          html += '</div>';

          html += '</div>';
        });

        html += '</div>';
      }

      if (!isRouteTokenValid_(routeToken)) return;
      area.innerHTML = html;
      setRouteSnapshot_('installments', html);
    }, null, true);
  }

  // Ver detalhes do grupo de parcelas - BANK STYLE UI
  function viewInstallmentGroup(grupoId) {
    console.log('viewInstallmentGroup v2.1 called for', grupoId);
    if (!grupoId) {
      toast('Erro: Grupo de parcelas não identificado.', 'error');
      return;
    }

    rpc('getInstallmentDetails', { grupoId: grupoId }, function (result) {
      // 1. Header simplificado
      document.getElementById('modal-title').innerHTML = '<div style="font-size:18px;font-weight:700">Escolha as parcelas</div><div style="font-size:13px;color:var(--text-secondary);font-weight:400">Marque as que você quer pagar agora</div>';

      var config = result.config;
      var parcelas = result.parcelas;

      var body = '<div style="display:flex;flex-direction:column;height:100%;position:relative">';

      // 2. Select All Checkbox Row
      body += '<div style="padding:16px 0;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;cursor:pointer" onclick="toggleSelectAllWrapper(this)">';
      body += '<input type="checkbox" id="chk-all-installments" style="width:20px;height:20px;accent-color:var(--primary);cursor:pointer;pointer-events:none">';
      body += '<span style="font-size:16px;font-weight:500">Selecionar todas</span>';
      body += '</div>';

      // 3. Scrollable List
      body += '<div style="flex:1;overflow-y:auto;padding-top:8px">';

      parcelas.forEach(function (p) {
        // Formatar Mês (Ex: Mar., Abr.)
        var dateParts = p.date.split('/'); // dd/mm/yyyy
        var monthIndex = parseInt(dateParts[1]) - 1;
        var monthNames = ["Jan.", "Fev.", "Mar.", "Abr.", "Mai.", "Jun.", "Jul.", "Ago.", "Set.", "Out.", "Nov.", "Dez."];
        var monthLabel = monthNames[monthIndex];

        // Verificar se é atual (mês corrente)
        var isCurrent = false;
        var today = new Date();
        if (today.getMonth() === monthIndex && today.getFullYear() == dateParts[2]) isCurrent = true;

        var isPaid = p.status === 'PAGA';

        var rowStyle = 'display:flex;align-items:center;padding:16px 0;border-bottom:1px solid var(--border);gap:16px';
        if (!isPaid && p.status !== 'CANCELADA') rowStyle += ';cursor:pointer';

        // Checkbox lógica
        var chkHtml = '<div style="width:24px;display:flex;justify-content:center;align-items:center">';
        if (isPaid) {
          chkHtml += '<div style="width:20px;height:20px;background:var(--success);border-radius:4px;display:flex;align-items:center;justify-content:center;color:white;font-size:12px">S</div>';
        } else if (p.status === 'CANCELADA') {
          chkHtml += '<div style="color:var(--text-muted);font-size:16px">S</div>';
        } else {
          chkHtml += '<input type="checkbox" class="chk-installment" value="' + p.id + '" data-amount="' + p.valor + '" style="width:20px;height:20px;accent-color:var(--primary);cursor:pointer;pointer-events:none">';
        }
        chkHtml += '</div>';

        // Wrapper click handler
        var clickHandler = (!isPaid && p.status !== 'CANCELADA') ? 'onclick="toggleInstallmentRow(this)"' : '';

        // Conteúdo
        body += '<div style="' + rowStyle + '" ' + clickHandler + '>';
        body += chkHtml;

        // Texto: 1ª Mar. [Atual]
        body += '<div style="flex:1;display:flex;align-items:center;gap:12px">';
        body += '<span style="font-weight:700;font-size:16px">' + p.numero + 'ª</span>';
        body += '<span style="font-size:16px">' + monthLabel + '</span>';

        if (isCurrent && !isPaid) {
          body += '<span style="background:rgba(108,99,255,0.1);color:var(--accent);padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase">Atual</span>';
        }
        if (p.status === 'ATRASADA') {
          body += '<span style="background:rgba(255,82,82,0.1);color:#ff5252;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:700;text-transform:uppercase">Atrasada</span>';
        }
        body += '</div>';

        // Valor
        var valColor = isPaid ? 'color:var(--text-secondary);text-decoration:line-through' : 'color:var(--text-primary);font-weight:600';
        body += '<div style="font-size:16px;' + valColor + '">' + fmtCurrency(p.valor) + '</div>';

        body += '</div>'; // End Row
      });

      body += '</div>'; // End List Container
      body += '</div>';

      document.getElementById('modal-body').innerHTML = body;

      // Footer Flutuante Simulado
      var footerHtml = '<div style="width:100%;display:flex;align-items:center;justify-content:space-between;padding-top:4px">';
      footerHtml += '<div style="display:flex;flex-direction:column">';
      footerHtml += '<span id="bulk-total-display" style="font-size:20px;font-weight:800;color:var(--text-primary)">R$ 0,00</span>';
      footerHtml += '<span style="font-size:12px;color:var(--text-secondary)">Total selecionado</span>';
      footerHtml += '</div>';
      footerHtml += '<button id="btn-bulk-continue" class="btn-primary" style="padding:12px 32px;border-radius:32px;font-weight:600;font-size:15px;box-shadow:0 4px 12px rgba(108,99,255,0.3)" disabled onclick="confirmBulkPay()">Pagar agora</button>';
      footerHtml += '</div>';

      document.getElementById('modal-footer').innerHTML = footerHtml;

      openModal();
    });
  }

  // --- Funções Auxiliares UI ---

  window.toggleSelectAllWrapper = function (div) {
    var chk = div.querySelector('input');
    chk.checked = !chk.checked;
    window.toggleSelectAllInstallments(chk);
  };

  window.toggleInstallmentRow = function (div) {
    var chk = div.querySelector('.chk-installment');
    if (chk) {
      chk.checked = !chk.checked;
      window.updateBulkBar();
    }
  };

  window.toggleSelectAllInstallments = function (el) {
    var checked = el.checked;
    document.querySelectorAll('.chk-installment').forEach(function (chk) {
      chk.checked = checked;
    });
    updateBulkBar();
  };

  window.updateBulkBar = function () {
    var selected = document.querySelectorAll('.chk-installment:checked');
    var count = selected.length;
    var total = 0;
    selected.forEach(function (chk) {
      total += parseFloat(chk.getAttribute('data-amount') || 0);
    });

    document.getElementById('bulk-total-display').textContent = fmtCurrency(total);

    var btn = document.getElementById('btn-bulk-continue');
    if (count > 0) {
      btn.disabled = false;
      btn.style.opacity = '1';
      btn.style.cursor = 'pointer';
    } else {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      btn.style.cursor = 'not-allowed';
    }

    // Atualizar checkbox "Todos"
    var totalCheckboxes = document.querySelectorAll('.chk-installment').length;
    var masterChk = document.getElementById('chk-all-installments');
    if (masterChk) {
      if (totalCheckboxes > 0 && count === totalCheckboxes) {
        masterChk.checked = true;
      } else {
        masterChk.checked = false;
      }
    }
  };

  window.confirmBulkPay = function () {
    var selected = document.querySelectorAll('.chk-installment:checked');
    var ids = Array.from(selected).map(function (chk) { return chk.value; });

    if (ids.length === 0) return;

    var total = 0;
    selected.forEach(function (chk) { total += parseFloat(chk.getAttribute('data-amount') || 0); });

    document.getElementById('modal-title').textContent = 'Confirmar Pagamento em Lote';
    document.getElementById('modal-body').innerHTML =
      '<p class="confirm-text">Deseja confirmar o pagamento de <strong>' + ids.length + ' parcelas</strong>?</p>' +
      '<p class="confirm-text" style="font-size:16px;margin:8px 0">Valor Total: <strong>' + fmtCurrency(total) + '</strong></p>' +
      '<div class="form-group" style="margin-top:12px"><label class="form-label">Data de Pagamento</label>' +
      '<input type="date" class="form-input" id="bulk-pay-date" value="' + new Date().toISOString().substring(0, 10) + '"></div>';

    document.getElementById('modal-footer').innerHTML =
      '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="btn-do-bulk-pay">S Confirmar Pagamento</button>';

    document.getElementById('btn-do-bulk-pay').addEventListener('click', function () {
      this.disabled = true;
      this.textContent = 'Processando...';
      var date = document.getElementById('bulk-pay-date').value;

      rpc('markMultipleAsPaid', { ids: ids, dataPagamento: date }, function (res) {
        toast(res.count + ' parcelas pagas com sucesso!', 'success');
        closeModal();
        refreshCurrentView();
      });
    });
  };


  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // MAINTENANCE RESERVE (WALLET)
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderMaintenanceReserve(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var area = document.getElementById('content');
    if (!applyRouteSnapshot_('maintenance', area)) {
      area.innerHTML = '<div class="empty-state"><div class="empty-text">Carregando reserva...</div></div>';
    }

    // getDashboard já recalcula reservas internamente
    rpc('getDashboard', { month: APP.month, year: APP.year }, function (dash) {
      if (!isRouteTokenValid_(routeToken)) return;
      rpc('getConfig', null, function (config) {
        if (!isRouteTokenValid_(routeToken)) return;
        APP.config = config; // atualizar cache global
        var reserva = dash.reservaManutencao || { balance: 0, predicted: 0, accumulated: 0, usage: 0 };
        var deposits = reserva.predicted || 0; // predicted = deposits reais do mês
        var usage = reserva.usage || 0;
        var balance = reserva.balance || 0;
        var metaRaw = config.META_RESERVA_MANUTENCAO;
        var meta = (metaRaw !== undefined && metaRaw !== '') ? parseFloat(metaRaw) : 500;
        if (isNaN(meta) || meta <= 0) meta = 500;

        var progressPct = meta > 0 ? Math.min(Math.round((balance / meta) * 100), 100) : 0;
        var liquido = deposits - usage;

        //  Hero Card 
        var html = '<div class="wallet-hero">';
        html += '<div class="wallet-hero-label">x:️ Reserva de Manutenção</div>';
        html += '<div class="wallet-hero-balance">' + fmtCurrency(balance) + '</div>';
        html += '<div class="wallet-hero-progress">';
        html += '<div class="wallet-progress-bar"><div class="wallet-progress-fill" style="width:' + progressPct + '%"></div></div>';
        html += '<div class="wallet-progress-label">';
        html += '<span>' + progressPct + '% da meta</span>';
        html += '<span>Meta: ' + fmtCurrency(meta) + '</span>';
        html += '</div>';
        html += '</div>';
        html += '<button class="btn-primary" onclick="openWalletDeposit()" style="margin-top:12px;width:100%">Depositar na Reserva</button>';
        html += '</div>';

        //  KPIs do Dashboard (NOVO) 
        html += '<div class="kpi-grid" style="margin-top:20px">';
        html += kpiCard('x:️', fmtCurrency(balance), 'Saldo Total Reserva', 'accent');
        html += kpiCard('x', fmtCurrency(deposits), 'Depósitos', 'positive');
        html += kpiCard('x', fmtCurrency(usage), 'Manutenção', 'negative');
        html += kpiCard(liquido >= 0 ? 'x' : 'x0', fmtCurrency(liquido), 'Líquido', liquido >= 0 ? 'positive' : 'negative');
        html += '</div>';

        //  Extrato do Mês 
        html += '<div class="wallet-section">';
        html += '<div class="wallet-section-header">';
        html += '<div class="wallet-section-title">x9 Extrato do Mês</div>';
        html += '<div class="wallet-section-badge">' + MONTH_NAMES[APP.month] + '/' + APP.year + '</div>';
        html += '</div>';
        html += '<div id="wallet-timeline-area"><div class="empty-state" style="margin:16px 20px"><div class="empty-text">Carregando extrato...</div></div></div>';
        html += '</div>';

        //  Configuração 
        html += '<div class="wallet-config">';
        html += '<div class="wallet-config-title">a"️ Configuração</div>';
        html += '<div class="wallet-config-row">';
        html += '<div class="form-group"><label class="form-label">Meta da Reserva</label>';
        html += '<input type="number" class="form-input" id="wallet-meta" value="' + meta + '" step="100" min="0"></div>';
        html += '<button class="btn-primary" onclick="saveWalletConfig()" style="margin-bottom:16px;white-space:nowrap">Salvar</button>';
        html += '</div>';

        // Cobertura
        html += '<div class="wallet-coverage">';
        html += '<div class="wallet-coverage-item">';
        html += '<div class="wallet-coverage-value">' + fmtCurrency(balance) + '</div>';
        html += '<div class="wallet-coverage-label">Saldo acumulado</div>';
        html += '</div>';
        html += '<div class="wallet-coverage-item">';
        html += '<div class="wallet-coverage-value" style="color:' + (progressPct >= 100 ? 'var(--success)' : progressPct >= 50 ? 'var(--warning, #f0ad4e)' : 'var(--danger)') + '">';
        html += progressPct >= 100 ? 'Meta atingida!' : progressPct >= 50 ? 'No caminho' : 'Baixa';
        html += '</div>';
        html += '<div class="wallet-coverage-label">Situação da reserva</div>';
        html += '</div>';
        html += '<div class="wallet-coverage-item">';
        html += '<div class="wallet-coverage-value">' + fmtCurrency(Math.max(meta - balance, 0)) + '</div>';
        html += '<div class="wallet-coverage-label">Falta para a meta</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';

        if (!isRouteTokenValid_(routeToken)) return;
        area.innerHTML = html;
        setRouteSnapshot_('maintenance', html);

        //  Carregar extrato (timeline) com transações reais 
        rpc('listTransactions', { month: APP.month, year: APP.year, page: 1, pageSize: 100 }, function (txData) {
          if (!isRouteTokenValid_(routeToken)) return;
          var manutCatId = config.MANUTENCAO_CATEGORY_ID || '';

          // NOVO: Filtrar transferências envolvendo reserva e despesas de manutenção
          var walletItems = txData.items.filter(function (tx) {
            // Transferências para/da reserva
            if (tx.type === 'TRANSFER') {
              return (tx.fromWalletId === 'reserva' || tx.toWalletId === 'reserva');
            }
            // Despesas de manutenção (pagas pela reserva)
            if (tx.type === 'DESPESA' && String(tx.categoryId) === manutCatId) {
              return true;
            }
            return false;
          });

          // Ordenar por data desc
          walletItems.sort(function (a, b) {
            return (b.dateRaw || b.date || '').localeCompare(a.dateRaw || a.date || '');
          });

          var timelineArea = document.getElementById('wallet-timeline-area');
          if (!timelineArea) return;

          var tl = '';

          if (walletItems.length === 0) {
            tl += '<div class="wallet-timeline-empty">';
            tl += '<div class="wallet-timeline-empty-icon">x</div>';
            tl += '<div class="wallet-timeline-empty-text">Nenhuma movimentação neste mês.<br>Use o botão "Depositar" para adicionar à reserva.</div>';
            tl += '</div>';
          } else {
            walletItems.forEach(function (tx) {
              // NOVO: Determinar se é depósito ou saque baseado em transfer
              var isDeposit = (tx.type === 'TRANSFER' && tx.toWalletId === 'reserva') || tx.type === 'RECEITA';
              var isWithdrawal = (tx.type === 'TRANSFER' && tx.fromWalletId === 'reserva');

              var parcelaInfo = '';
              if (tx.numero && tx.total) {
                parcelaInfo = ' (' + tx.numero + '/' + tx.total + ')';
              }
              tl += '<div class="wallet-timeline-item">';

              // Ícone baseado no tipo
              var icon = 'x'; // default: banco/transfer
              if (tx.type === 'DESPESA') icon = 'x'; // manutenção
              else if (isWithdrawal) icon = 'x'; // saque
              else if (isDeposit) icon = 'x'; // depósito

              tl += '<div class="wallet-tl-icon ' + (isDeposit ? 'tl-in' : 'tl-out') + '">' + icon + '</div>';
              tl += '<div class="wallet-tl-info">';

              // Descrição
              var desc = tx.description || '';
              if (!desc) {
                if (isDeposit) desc = 'Depósito na reserva';
                else if (isWithdrawal) desc = 'Retirada da reserva';
                else if (tx.type === 'DESPESA') desc = 'Manutenção';
              }

              tl += '<div class="wallet-tl-desc">' + desc + parcelaInfo + '</div>';
              tl += '<div class="wallet-tl-date">' + tx.date + (tx.paymentMethod ? ' · ' + tx.paymentMethod : '') + '</div>';
              tl += '</div>';
              tl += '<div class="wallet-tl-amount ' + (isDeposit ? 'amount-in' : 'amount-out') + '">' +
                (isDeposit ? '+ ' : '- ') + fmtCurrency(tx.amount) + '</div>';
              tl += '</div>';
            });
          }

          if (!isRouteTokenValid_(routeToken)) return;
          timelineArea.innerHTML = '<ul class="wallet-timeline">' + tl + '</ul>';
          setRouteSnapshot_('maintenance', area.innerHTML);
        }, null, true);
      });
    });
  }

  // Abre modal simplificado para depositar na reserva (transfer\u00eancia)
  function openWalletDeposit() {
    document.getElementById('modal-title').textContent = '\ud83d\udcb0 Depositar na Reserva';

    var body = '<p style="color:var(--text-secondary);margin-bottom:16px">' +
      'Transfer\u00eancia da carteira principal para a reserva de manuten\u00e7\u00e3o.</p>';

    body += '<div class="form-row">' +
      '<div class="form-group"><label class="form-label">Data</label>' +
      '<input type="date" class="form-input" id="transfer-date" value="' + new Date().toISOString().substring(0, 10) + '"></div>' +
      '<div class="form-group"><label class="form-label">Valor (R$)</label>' +
      '<input type="number" class="form-input" id="transfer-amount" step="0.01" min="0.01" placeholder="0,00"></div>' +
      '</div>';

    body += '<div class="form-group"><label class="form-label">Descri\u00e7\u00e3o (opcional)</label>' +
      '<input type="text" class="form-input" id="transfer-desc" placeholder="Ex: Reserva para manuten\u00e7\u00e3o" value="Dep\u00f3sito na reserva"></div>';

    document.getElementById('modal-body').innerHTML = body;

    var footer = '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="transfer-save-btn">Depositar</button>';
    document.getElementById('modal-footer').innerHTML = footer;

    document.getElementById('transfer-save-btn').addEventListener('click', function () {
      var date = document.getElementById('transfer-date').value;
      var amount = document.getElementById('transfer-amount').value;
      var desc = document.getElementById('transfer-desc').value;

      if (!date) { toast('Informe a data.', 'error'); return; }
      if (!amount || parseFloat(amount) <= 0) { toast('Informe um valor válido.', 'error'); return; }

      var btn = document.getElementById('transfer-save-btn');
      btn.disabled = true;
      btn.textContent = 'Depositando...';

      var payload = {
        date: date,
        type: 'TRANSFER',
        fromWalletId: 'principal',
        toWalletId: 'reserva',
        amount: parseFloat(amount),
        description: desc,
        paymentMethod: '',
        km: ''
      };

      rpc('createTransaction', payload, function () {
        toast('Depósito realizado!', 'success');
        closeModal();
        refreshCurrentView();
      }, function (err) {
        toast(err, 'error');
        btn.disabled = false;
        btn.textContent = 'Depositar';
      });
    });

    openModal();
  }

  function saveWalletConfig() {
    var meta = parseFloat(document.getElementById('wallet-meta').value);

    if (isNaN(meta) || meta < 0) { toast('Meta inválida', 'error'); return; }

    rpc('saveConfig', {
      META_RESERVA_MANUTENCAO: meta.toString()
    }, function () {
      toast('Configuração salva!', 'success');
      renderMaintenanceReserve();
    });
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // CATEGORIES
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderCategories(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var content = document.getElementById('content');
    content.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">' +
      '<h2 style="font-size:18px;font-weight:700">x️ Categorias</h2>' +
      '<button class="btn-primary btn-sm" onclick="openCategoryModal()">+ Nova Categoria</button></div>' +
      '<div id="cat-list-area"></div>';

    loadCategoryList(routeToken);
  }

  function loadCategoryList(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var area = document.getElementById('cat-list-area');
    if (!area) return;

    var cached = getCached({ base: 'categories', key: 'all' });
    if (cached && cached.length) {
      renderCategoryList_(cached, area, routeToken);
      rpc('listCategories', { includeInactive: true }, function (cats) {
        if (!isRouteTokenValid_(routeToken)) return;
        APP.categories = cats.filter(function (c) { return c.active; });
        setCached({ base: 'categories', key: 'all' }, cats);
        renderCategoryList_(cats, area, routeToken);
      }, null, true);
      return;
    }

    rpc('listCategories', { includeInactive: true }, function (cats) {
      if (!isRouteTokenValid_(routeToken)) return;
      APP.categories = cats.filter(function (c) { return c.active; });
      setCached({ base: 'categories', key: 'all' }, cats);
      renderCategoryList_(cats, area, routeToken);
    }, null, true);
  }

  function renderCategoryList_(cats, area, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    if (!cats.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-icon">[ ]</div><div class="empty-text">Nenhuma categoria.</div></div>';
      var emptyContent = document.getElementById('content');
      if (emptyContent) setRouteSnapshot_('categories', emptyContent.innerHTML);
      return;
    }

    var html = '';
    cats.forEach(function (c) {
      html += '<div class="cat-list-item' + (c.active ? '' : ' cat-inactive') + '" ' +
        'draggable="true" data-id="' + c.id + '" data-order="' + c.order + '">' +
        '<span class="cat-drag-handle">::</span>' +
        '<span class="cat-color-dot" style="background:' + c.colorHex + '"></span>' +
        '<span style="font-size:18px">' + c.emoji + '</span>' +
        '<span class="cat-item-name">' + c.name + '</span>' +
        '<span class="cat-item-type">' + c.applicableType + '</span>' +
        '<div class="cat-item-actions">' +
        '<button onclick="openCategoryModal(\'' + c.id + '\')" title="Editar">E</button>' +
        '<button onclick="confirmToggleCategoryActive(\'' + c.id + '\',' + !c.active + ',\'' + c.name + '\')" title="' + (c.active ? 'Desativar' : 'Ativar') + '">' +
        (c.active ? 'On' : 'Off') + '</button>' +
        '<button onclick="confirmDeleteCategory(\'' + c.id + '\',\'' + c.name + '\')" title="Deletar" style="color:var(--danger)">X</button>' +
        '</div></div>';
    });

    if (!isRouteTokenValid_(routeToken)) return;
    area.innerHTML = html;
    initDragDrop();
    var content = document.getElementById('content');
    if (content) setRouteSnapshot_('categories', content.innerHTML);
  }

  function openCategoryModal(editId) {
    var isEdit = !!editId;
    var editCat = null;

    if (isEdit) {
      // Find from last loaded list
      rpc('listCategories', { includeInactive: true }, function (cats) {
        cats.forEach(function (c) { if (c.id === editId) editCat = c; });
        renderCatModal(isEdit, editCat);
      });
    } else {
      renderCatModal(false, null);
    }
  }

  function renderCatModal(isEdit, editCat) {
    document.getElementById('modal-title').textContent = isEdit ? 'Editar Categoria' : 'Nova Categoria';

    var colors = ['#FF6B6B', '#FFD93D', '#6BCB77', '#4D96FF', '#845EC2', '#00C9A7', '#C34A36',
      '#A0A0A0', '#2ECC71', '#9B59B6', '#E67E22', '#1ABC9C', '#3498DB', '#E91E63', '#607D8B'];

    // Lista de emojis disponíveis
    var availableEmojis = [
      'x', 'x', ':', 'x️', 'x', 'x:️', 'xa', 'x', 'x', 'x',
      'x}', 'x}', 'x}', 'xa', 'x"', 'x', 'S️', 'x}', 'x"', '"',
      'x:', 'x`', 'x', 'x9', 'x', 'x', 'x}', 'x}', 'x9️', 'x}',
      'x', 'x`', 'x', 'x', 'x', 'x', 'x~', 'x', 'x️', 'x}',
      'xa"', 'xa"', 'xaR', 'x️', 'x:', 'xa', 'a"️', 'x', 'x:️', 'x9'
    ];

    var body = '<div class="form-group"><label class="form-label">Nome</label>' +
      '<input type="text" class="form-input" id="cat-name" maxlength="30" value="' + (editCat ? editCat.name : '') + '"></div>';

    body += '<div class="form-row">' +
      '<div class="form-group"><label class="form-label">Emoji</label>' +
      '<select class="form-select" id="cat-emoji" style="font-size:20px">';

    availableEmojis.forEach(function (emoji) {
      var selected = (editCat && editCat.emoji === emoji) ? ' selected' : (!editCat && emoji === 'x') ? ' selected' : '';
      body += '<option value="' + emoji + '"' + selected + '>' + emoji + '</option>';
    });

    body += '</select></div>' +
      '<div class="form-group"><label class="form-label">Tipo Aplicável</label>' +
      '<select class="form-select" id="cat-type">' +
      '<option value="DESPESA"' + (editCat && editCat.applicableType === 'DESPESA' ? ' selected' : '') + '>Despesa</option>' +
      '<option value="RECEITA"' + (editCat && editCat.applicableType === 'RECEITA' ? ' selected' : '') + '>Receita</option>' +
      '<option value="AMBOS"' + (editCat && editCat.applicableType === 'AMBOS' ? ' selected' : '') + '>Ambos</option>' +
      '</select></div></div>';

    body += '<div class="form-group"><label class="form-label">Cor</label>' +
      '<div class="color-picker-row" id="cat-colors"></div>' +
      '<input type="text" class="form-input" id="cat-color-hex" maxlength="7" placeholder="#RRGGBB" value="' + (editCat ? editCat.colorHex : '#6C63FF') + '" style="margin-top:8px;width:120px">' +
      '</div>';

    document.getElementById('modal-body').innerHTML = body;

    // Render color swatches
    var colorContainer = document.getElementById('cat-colors');
    var currentColor = editCat ? editCat.colorHex : '#6C63FF';
    colors.forEach(function (c) {
      var swatch = document.createElement('div');
      swatch.className = 'color-swatch' + (c.toUpperCase() === currentColor.toUpperCase() ? ' selected' : '');
      swatch.style.background = c;
      swatch.addEventListener('click', function () {
        colorContainer.querySelectorAll('.color-swatch').forEach(function (s) { s.classList.remove('selected'); });
        this.classList.add('selected');
        document.getElementById('cat-color-hex').value = c;
      });
      colorContainer.appendChild(swatch);
    });

    document.getElementById('cat-color-hex').addEventListener('input', function () {
      colorContainer.querySelectorAll('.color-swatch').forEach(function (s) { s.classList.remove('selected'); });
    });

    var footer = '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="cat-save-btn">' + (isEdit ? 'Salvar' : 'Criar') + '</button>';
    document.getElementById('modal-footer').innerHTML = footer;

    document.getElementById('cat-save-btn').addEventListener('click', function () {
      saveCat(isEdit, editCat ? editCat.id : null);
    });

    openModal();
  }

  function saveCat(isEdit, editId) {
    var name = document.getElementById('cat-name').value.trim();
    var emoji = document.getElementById('cat-emoji').value;
    var colorHex = document.getElementById('cat-color-hex').value.trim();
    var applicableType = document.getElementById('cat-type').value;

    if (!name) { toast('Nome é obrigatório.', 'error'); return; }
    if (!colorHex.match(/^#[0-9A-Fa-f]{6}$/)) { toast('Cor inválida. Use #RRGGBB.', 'error'); return; }

    var btn = document.getElementById('cat-save-btn');
    btn.disabled = true;
    btn.textContent = 'Salvando...';

    var payload = { name: name, emoji: emoji || 'x', colorHex: colorHex, applicableType: applicableType };

    if (isEdit) {
      payload.id = editId;
      rpc('updateCategory', payload, function () {
        toast('Categoria atualizada!', 'success');
        closeModal();
        reloadCategories();
      }, function (err) {
        toast(err, 'error');
        btn.disabled = false;
        btn.textContent = 'Salvar';
      });
    } else {
      rpc('createCategory', payload, function () {
        toast('Categoria criada!', 'success');
        closeModal();
        reloadCategories();
      }, function (err) {
        toast(err, 'error');
        btn.disabled = false;
        btn.textContent = 'Criar';
      });
    }
  }

  function confirmToggleCategoryActive(id, active, name) {
    var action = active ? 'ativar' : 'desativar';
    document.getElementById('modal-title').textContent = 'Confirmar ' + (active ? 'Ativação' : 'Desativação');
    document.getElementById('modal-body').innerHTML =
      '<p class="confirm-text">Tem certeza que deseja ' + action + ' a categoria <strong>"' + name + '"</strong>?</p>';
    document.getElementById('modal-footer').innerHTML =
      '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="confirm-toggle-btn">' + (active ? 'Ativar' : 'Desativar') + '</button>';

    document.getElementById('confirm-toggle-btn').addEventListener('click', function () {
      this.disabled = true;
      this.textContent = 'Processando...';
      rpc('updateCategory', { id: id, active: active }, function () {
        toast(active ? 'Categoria ativada!' : 'Categoria desativada!', 'success');
        closeModal();
        reloadCategories();
      });
    });
    openModal();
  }

  function confirmDeleteCategory(id, name) {
    document.getElementById('modal-title').textContent = 'Confirmar Exclusão';
    document.getElementById('modal-body').innerHTML =
      '<p class="confirm-text">Tem certeza que deseja <strong style="color:var(--danger)">DELETAR</strong> a categoria <strong>"' + name + '"</strong>?</p>' +
      '<p class="confirm-text" style="color:var(--warning);font-size:13px;margin-top:8px">Esta ação não pode ser desfeita. As transações existentes não serão afetadas.</p>';
    document.getElementById('modal-footer').innerHTML =
      '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-danger" id="confirm-del-cat-btn">Deletar</button>';

    document.getElementById('confirm-del-cat-btn').addEventListener('click', function () {
      this.disabled = true;
      this.textContent = 'Deletando...';
      rpc('deleteCategory', id, function () {
        toast('Categoria deletada!', 'success');
        closeModal();
        reloadCategories();
      }, function (err) {
        toast(err, 'error');
        closeModal();
      });
    });
    openModal();
  }

  function reloadCategories() {
    rpc('listCategories', { includeInactive: false }, function (cats) {
      APP.categories = cats;
      if (APP.route === 'categories') loadCategoryList();
    });
  }

  //  Drag and Drop 
  function initDragDrop() {
    var items = document.querySelectorAll('.cat-list-item');
    var dragSrc = null;

    items.forEach(function (item) {
      item.addEventListener('dragstart', function (e) {
        dragSrc = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', this.getAttribute('data-id'));
      });

      item.addEventListener('dragover', function (e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        this.classList.add('drag-over');
      });

      item.addEventListener('dragleave', function () {
        this.classList.remove('drag-over');
      });

      item.addEventListener('drop', function (e) {
        e.preventDefault();
        this.classList.remove('drag-over');
        if (dragSrc !== this) {
          var parent = this.parentNode;
          var allItems = Array.from(parent.querySelectorAll('.cat-list-item'));
          var fromIdx = allItems.indexOf(dragSrc);
          var toIdx = allItems.indexOf(this);

          if (fromIdx < toIdx) {
            parent.insertBefore(dragSrc, this.nextSibling);
          } else {
            parent.insertBefore(dragSrc, this);
          }

          // Save new order
          var reordered = [];
          parent.querySelectorAll('.cat-list-item').forEach(function (el, i) {
            reordered.push({ id: el.getAttribute('data-id'), order: i + 1 });
          });
          rpc('reorderCategories', reordered, function () {
            toast('Ordem salva!', 'success');
          });
        }
      });

      item.addEventListener('dragend', function () {
        this.classList.remove('dragging');
        document.querySelectorAll('.cat-list-item').forEach(function (el) {
          el.classList.remove('drag-over');
        });
      });
    });
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // REPORTS
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function renderReports(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var content = document.getElementById('content');
    if (!applyRouteSnapshot_('reports', content)) {
      content.innerHTML = '<div class="section-card">' +
        '<div class="section-title">Consolidado - Ultimos 12 Meses</div>' +
        '<div id="report-area"><div class="empty-state"><div class="empty-text">Carregando relatório...</div></div></div></div>';
    }

    var cached = getCached({ base: 'reports', key: '12m' });
    if (cached) {
      renderReportsTable_(cached, routeToken);
      rpc('getReport12Months', null, function (data) {
        if (!isRouteTokenValid_(routeToken)) return;
        setCached({ base: 'reports', key: '12m' }, data || []);
        renderReportsTable_(data || [], routeToken);
      }, null, true);
      return;
    }

    rpc('getReport12Months', null, function (data) {
      if (!isRouteTokenValid_(routeToken)) return;
      setCached({ base: 'reports', key: '12m' }, data || []);
      renderReportsTable_(data || [], routeToken);
    }, null, true);
  }

  function renderReportsTable_(data, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    var area = document.getElementById('report-area');
    if (!area) return;
    if (!data.length) {
      area.innerHTML = '<div class="empty-state"><div class="empty-text">Sem dados.</div></div>';
      var emptyContent = document.getElementById('content');
      if (emptyContent) setRouteSnapshot_('reports', emptyContent.innerHTML);
      return;
    }

    var html = '<div class="table-wrapper"><table class="report-table"><thead><tr>' +
      '<th>Mes</th><th>Receita</th><th>Despesa</th><th>Lucro</th>' +
      '<th>Combustivel</th><th>Manutencao</th><th>Reserva</th></tr></thead><tbody>';

    data.forEach(function (r) {
      var parts = r.month.split('-');
      var label = MONTH_NAMES[parseInt(parts[1])] + '/' + parts[0].substring(2);
      html += '<tr>' +
        '<td>' + label + '</td>' +
        '<td class="report-positive">' + fmtCurrency(r.receita) + '</td>' +
        '<td class="report-negative">' + fmtCurrency(r.despesa) + '</td>' +
        '<td class="' + (r.lucro >= 0 ? 'report-positive' : 'report-negative') + '">' + fmtCurrency(r.lucro) + '</td>' +
        '<td>' + fmtCurrency(r.combustivel) + '</td>' +
        '<td>' + fmtCurrency(r.manutencao) + '</td>' +
        '<td>' + fmtCurrency(r.reservaBalance) + '</td>' +
        '</tr>';
    });

    var totR = 0, totD = 0, totC = 0, totM = 0;
    data.forEach(function (r) { totR += r.receita; totD += r.despesa; totC += r.combustivel; totM += r.manutencao; });
    html += '<tr style="font-weight:700;border-top:2px solid var(--border)">' +
      '<td>TOTAL</td><td class="report-positive">' + fmtCurrency(totR) + '</td>' +
      '<td class="report-negative">' + fmtCurrency(totD) + '</td>' +
      '<td class="' + (totR - totD >= 0 ? 'report-positive' : 'report-negative') + '">' + fmtCurrency(totR - totD) + '</td>' +
      '<td>' + fmtCurrency(totC) + '</td><td>' + fmtCurrency(totM) + '</td><td>-</td></tr>';

    html += '</tbody></table></div>';
    if (!isRouteTokenValid_(routeToken)) return;
    area.innerHTML = html;
    var content = document.getElementById('content');
    if (content) setRouteSnapshot_('reports', content.innerHTML);
  }

  function renderSettings(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var cachedConfig = getCached({ base: 'config', key: 'global' });
    if (cachedConfig) {
      APP.config = cachedConfig;
      renderSettingsContent_(cachedConfig, routeToken);
      rpc('getConfig', null, function (config) {
        if (!isRouteTokenValid_(routeToken)) return;
        APP.config = config || {};
        setCached({ base: 'config', key: 'global' }, APP.config);
        renderSettingsContent_(APP.config, routeToken);
      }, null, true);
      return;
    }

    rpc('getConfig', null, function (config) {
      if (!isRouteTokenValid_(routeToken)) return;
      APP.config = config || {};
      setCached({ base: 'config', key: 'global' }, APP.config);
      renderSettingsContent_(APP.config, routeToken);
    }, null, true);
  }

  function renderSettingsContent_(config, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    var content = document.getElementById('content');

    var html = '<h2 style="font-size:18px;font-weight:700;margin-bottom:20px">Configuracoes</h2>';

    html += '<div class="section-card settings-section">' +
      '<h4>Aparencia</h4>' +
      '<div class="toggle-wrap" style="margin-bottom:12px">' +
      '<span>Modo Escuro</span>' +
      '<div class="toggle' + (APP.theme === 'dark' ? ' on' : '') + '" id="cfg-theme-toggle"></div></div>' +
      '<div class="form-group"><label class="form-label">Tema Padrao (para novos usuarios)</label>' +
      '<select class="form-select" id="cfg-theme-default" style="width:180px">' +
      '<option value="dark"' + (config.THEME_DEFAULT === 'dark' ? ' selected' : '') + '>Escuro</option>' +
      '<option value="light"' + (config.THEME_DEFAULT === 'light' ? ' selected' : '') + '>Claro</option>' +
      '</select></div></div>';

    html += '<div class="section-card settings-section">' +
      '<h4>Cache</h4>' +
      '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Limpar o cache pode resolver problemas de dados desatualizados.</p>' +
      '<button class="btn-secondary" onclick="doClearCache()">Limpar Cache</button></div>';

    html += '<div class="section-card settings-section">' +
      '<h4>Logos dos Bancos</h4>' +
      '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:8px">Carregar logos do Google Drive (base64).</p>' +
      '<button class="btn-primary" onclick="doLoadLogosBase64()" id="load-logos-base64-btn">Carregar Logos (Base64)</button>' +
      '</div>';

    var currentMonthVal = APP.year + '-' + (APP.month < 10 ? '0' + APP.month : APP.month);
    html += '<div class="section-card settings-section">' +
      '<h4>Exportar Dados</h4>' +
      '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Gera extrato completo do mes selecionado.</p>' +
      '<div class="form-group"><label class="form-label">Periodo</label>' +
      '<input type="month" class="form-input" id="export-month" value="' + currentMonthVal + '"></div>' +
      '<div style="display:flex;gap:10px;margin-top:10px">' +
      '<button class="btn-secondary" onclick="doExportSpreadsheet()" style="flex:1">Planilha Google</button>' +
      '<button class="btn-secondary" onclick="doExportPdf()" style="flex:1">PDF</button>' +
      '</div>' +
      '</div>';

    html += '<div class="section-card settings-section">' +
      '<h4>Manutencao</h4>' +
      '<p style="font-size:13px;color:var(--text-secondary);margin-bottom:12px">Use se notar dados desatualizados ou inconsistentes.</p>' +
      '<button class="btn-danger btn-sm" onclick="forceClearAllCache()" style="width:100%">Limpar Todo o Cache</button>' +
      '</div>';

    html += '<div class="section-card settings-section">' +
      '<h4>Controle de Acesso</h4>' +
      '<div class="form-group"><label class="form-label">Emails Autorizados (separados por virgula, vazio = todos)</label>' +
      '<input type="text" class="form-input" id="cfg-allowlist" placeholder="email1@gmail.com, email2@gmail.com" value="' + (config.ALLOWLIST_EMAILS || '') + '"></div></div>';

    html += '<button class="btn-primary" id="cfg-save-btn" style="width:100%;padding:14px;font-size:15px">Salvar Configuracoes</button>';

    if (!isRouteTokenValid_(routeToken)) return;
    content.innerHTML = html;
    setRouteSnapshot_('settings', html);
    document.getElementById('cfg-theme-toggle').addEventListener('click', function () {
      this.classList.toggle('on');
      toggleTheme();
    });
    document.getElementById('cfg-save-btn').addEventListener('click', saveSettings);
  }

  function saveSettings() {
    var btn = document.getElementById('cfg-save-btn');
    btn.disabled = true;
    btn.textContent = 'Salvando...';

    var configData = {
      // META_RESERVA_MANUTENCAO: removido da UI
      // MANUTENCAO_CATEGORY_ID: removido da UI
      THEME_DEFAULT: document.getElementById('cfg-theme-default').value,
      ALLOWLIST_EMAILS: document.getElementById('cfg-allowlist').value
    };

    rpc('saveConfig', configData, function () {
      toast('Configurações salvas!', 'success');
      btn.disabled = false;
      btn.textContent = 'Salvar Configurações';
      APP.config = Object.assign(APP.config, configData);
    }, function (err) {
      toast(err, 'error');
      btn.disabled = false;
      btn.textContent = 'Salvar Configurações';
    });
  }

  function getExportParams() {
    var val = document.getElementById('export-month').value; // yyyy-mm
    if (!val) return { month: APP.month, year: APP.year };
    var parts = val.split('-');
    return { year: parseInt(parts[0]), month: parseInt(parts[1]) };
  }

  function doExportSpreadsheet() {
    var p = getExportParams();
    toast('Gerando planilha... aguarde.', 'info');
    rpc('exportSpreadsheet', p, function (res) {
      window.open(res.url, '_blank');
      toast('Planilha criada com sucesso!', 'success');
    });
  }

  function doExportPdf() {
    var p = getExportParams();
    toast('Gerando PDF... aguarde.', 'info');
    rpc('exportPdf', p, function (res) {
      if (res.base64) {
        // Download direto
        var a = document.createElement('a');
        a.href = 'data:application/pdf;base64,' + res.base64;
        a.download = res.filename || 'extrato.pdf';
        a.click();
        toast('PDF baixado!', 'success');
      } else if (res.url) {
        window.open(res.url, '_blank');
        toast('Planilha aberta (exportação direta falhou, use Arquivo > Fazer download)', 'warning');
      }
    });
  }

  function doClearCache() {
    clearCached(); // Limpa todo o cache
    toast('Cache limpo com sucesso!', 'success');

    // Recarregar a tela atual para buscar dados atualizados
    setTimeout(function () {
      navigate(APP.route);
    }, 500);
  }

  function doLoadLogosBase64() {
    var btn = document.getElementById('load-logos-base64-btn');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Carregando logos... (pode demorar 30s)';

    rpc('getBankLogosBase64', null, function (logos) {
      btn.disabled = false;
      btn.textContent = 'Carregar Logos (Base64)';

      var count = 0;
      for (var bank in logos) {
        if (logos[bank] && BANK_REPOSITORY[bank]) {
          BANK_REPOSITORY[bank].logo = logos[bank];
          count++;
        }
      }

      // Salvar logos no localStorage para persistência
      try {
        localStorage.setItem('bankLogos', JSON.stringify(logos));
        localStorage.setItem('bankLogosTimestamp', Date.now());
        console.log('S Logos salvas no localStorage');
      } catch (e) {
        console.error('Erro ao salvar logos no localStorage:', e);
      }

      toast('S ' + count + ' logos carregadas e salvas!', 'success');
      console.log('S Logos carregadas:', count);

      // Recarregar tela atual
      setTimeout(function () {
        navigate(APP.route);
      }, 500);

    }, function (err) {
      btn.disabled = false;
      btn.textContent = 'Carregar Logos (Base64)';
      toast('Erro ao carregar logos: ' + err, 'error');
    });
  }

  function loadLogosFromLocalStorage() {
    try {
      var logosJson = localStorage.getItem('bankLogos');
      if (!logosJson) return false;

      var logos = JSON.parse(logosJson);
      var count = 0;

      for (var bank in logos) {
        if (logos[bank] && BANK_REPOSITORY[bank]) {
          BANK_REPOSITORY[bank].logo = logos[bank];
          count++;
        }
      }

      if (count > 0) {
        console.log('S ' + count + ' logos carregadas do localStorage');
        return true;
      }
    } catch (e) {
      console.error('Erro ao carregar logos do localStorage:', e);
    }
    return false;
  }

  function doListBankLogos() {
    var btn = document.getElementById('list-logos-btn');
    if (!btn) return;

    btn.disabled = true;
    btn.textContent = 'Listando...';

    rpc('listBankLogosFiles', null, function (files) {
      btn.disabled = false;
      btn.textContent = 'x9 Listar Arquivos';

      console.log('=== ARQUIVOS NA PASTA DO DRIVE ===');
      console.log('Total de arquivos:', files.length);
      files.forEach(function (f) {
        console.log('- ' + f.name);
        console.log('   ID: ' + f.id);
        console.log('   URL: ' + f.url);
        console.log('');
      });

      toast('S ' + files.length + ' arquivos listados no console', 'info');
    }, function (err) {
      btn.disabled = false;
      btn.textContent = 'x9 Listar Arquivos';
      toast('Erro ao listar arquivos: ' + err, 'error');
    });
  }

  function updateBankLogosUrls(urls) {
    // Atualizar BANK_REPOSITORY com as URLs do Google Drive
    var updated = 0;

    if (urls['nubank']) {
      BANK_REPOSITORY['Nubank'].logo = urls['nubank'];
      updated++;
    }
    if (urls['inter']) {
      BANK_REPOSITORY['Inter'].logo = urls['inter'];
      updated++;
    }
    if (urls['itau']) {
      BANK_REPOSITORY['Itau'].logo = urls['itau'];
      updated++;
    }
    if (urls['bradesco']) {
      BANK_REPOSITORY['Bradesco'].logo = urls['bradesco'];
      updated++;
    }
    if (urls['santander']) {
      BANK_REPOSITORY['Santander'].logo = urls['santander'];
      updated++;
    }
    if (urls['banco-do-brasil']) {
      BANK_REPOSITORY['BB'].logo = urls['banco-do-brasil'];
      updated++;
    }
    if (urls['caixa']) {
      BANK_REPOSITORY['Caixa'].logo = urls['caixa'];
      updated++;
    }
    if (urls['c6-bank']) {
      BANK_REPOSITORY['C6'].logo = urls['c6-bank'];
      updated++;
    }
    if (urls['btg-pactual']) {
      BANK_REPOSITORY['BTG'].logo = urls['btg-pactual'];
      updated++;
    }
    if (urls['mercado-pago']) {
      BANK_REPOSITORY['MercadoPago'].logo = urls['mercado-pago'];
      updated++;
    }
    if (urls['picpay']) {
      BANK_REPOSITORY['PicPay'].logo = urls['picpay'];
      updated++;
    }

    console.log('S ' + updated + ' logos atualizadas no BANK_REPOSITORY');

    // Recarregar a tela de contas se estiver nela
    if (APP.route === 'accounts') {
      setTimeout(function () {
        navigate('accounts');
      }, 500);
    }
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // MODAL HELPERS
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function openModal() {
    document.getElementById('modal-overlay').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.add('hidden');
  }

  function refreshCurrentView() {
    // Ensure fresh data after any write operation
    clearCached(); // Limpar todo o cache browser-side
    navigate(APP.route);
  }

  window.forceClearAllCache = function () {
    showLoading('Limpando cache...');
    rpc('clearAllServerCache', null, function () {
      clearCached(); // Browser-side
      hideLoading();
      toast('Cache limpo com sucesso!', 'success');
      location.reload(); // Recarregar aplicação
    });
  };
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // ACCOUNTS (CONTAS / CARTEIRAS)
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""

    var BANK_REPOSITORY = {
    'Carteira': { name: 'Carteira Fisica', color: '#111827', logo: '\u{1F4B5}', fallback: '\u{1F4B5}', type: 'icon' },
    'Investimentos': { name: 'Investimentos', color: '#0F766E', logo: '\u{1F4C8}', fallback: '\u{1F4C8}', type: 'icon' },
    'Nubank': { name: 'Nubank', color: '#820AD1', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=nubank', fallback: '\u{1F49C}', type: 'img' },
    'Inter': { name: 'Inter', color: '#FF7A00', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=inter', fallback: '\u{1F9E1}', type: 'img' },
    'Itau': { name: 'Itau', color: '#EC7000', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=itau', fallback: '\u{1F536}', type: 'img' },
    'Bradesco': { name: 'Bradesco', color: '#CC092F', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=bradesco', fallback: '\u{2764}\u{FE0F}', type: 'img' },
    'Santander': { name: 'Santander', color: '#EC0000', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=santander', fallback: '\u{1F534}', type: 'img' },
    'BB': { name: 'Banco do Brasil', color: '#F8D117', textColor: '#003399', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=bb', fallback: '\u{1F49B}', type: 'img' },
    'Caixa': { name: 'Caixa', color: '#005CA9', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=caixa', fallback: '\u{1F535}', type: 'img' },
    'C6': { name: 'C6 Bank', color: '#242424', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=c6', fallback: '\u{2B1B}', type: 'img' },
    'BTG': { name: 'BTG Pactual', color: '#00294B', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=btg', fallback: '\u{1F537}', type: 'img' },
    'MercadoPago': { name: 'Mercado Pago', color: '#009EE3', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=mercadopago', fallback: '\u{1F499}', type: 'img' },
    'PicPay': { name: 'PicPay', color: '#11C76F', logo: 'https://script.google.com/macros/s/AKfycbzeE5RO8hWJ6AGqvlGzvWYiCi96rZyfMBnyE0o4KhQg/exec?logo=picpay', fallback: '\u{1F49A}', type: 'img' },
    'Outro': { name: 'Outro Banco', color: '#6C63FF', logo: '\u{1F3E6}', fallback: '\u{1F3E6}', type: 'icon' }
  };

  // Carrega logos do localStorage assim que BANK_REPOSITORY for definido
  loadLogosFromLocalStorage();

  var BANK_KEY_ALIASES = {
    'carteira': 'Carteira',
    'dinheiro': 'Carteira',
    'investimento': 'Investimentos',
    'investimentos': 'Investimentos',
    'reserva': 'Investimentos',
    'nubank': 'Nubank',
    'nu': 'Nubank',
    'inter': 'Inter',
    'itau': 'Itau',
    'ita': 'Itau',
    'bradesco': 'Bradesco',
    'santander': 'Santander',
    'bb': 'BB',
    'bancodobrasil': 'BB',
    'caixa': 'Caixa',
    'caixaeconomicafederal': 'Caixa',
    'c6': 'C6',
    'c6bank': 'C6',
    'btg': 'BTG',
    'btgpactual': 'BTG',
    'mercadopago': 'MercadoPago',
    'mercadopay': 'MercadoPago',
    'picpay': 'PicPay'
  };

  function normalizeBankText_(value) {
    if (!value) return '';
    return String(value)
      .toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .replace(/[^a-z0-9]/g, '');
  }

  function resolveBankKey(instituicao, accountName) {
    if (instituicao && BANK_REPOSITORY[instituicao]) return instituicao;

    var raw = String(instituicao || '');
    if (raw) {
      var lower = raw.toLowerCase();
      var exact = Object.keys(BANK_REPOSITORY).find(function (k) { return k.toLowerCase() === lower; });
      if (exact) return exact;
    }

    var normalizedInst = normalizeBankText_(instituicao);
    if (normalizedInst && BANK_KEY_ALIASES[normalizedInst]) return BANK_KEY_ALIASES[normalizedInst];

    var normalizedName = normalizeBankText_(accountName);
    if (normalizedName) {
      var aliasKeys = Object.keys(BANK_KEY_ALIASES).sort(function (a, b) { return b.length - a.length; });
      var found = aliasKeys.find(function (alias) { return normalizedName.indexOf(alias) !== -1; });
      if (found) return BANK_KEY_ALIASES[found];
    }

    return 'Outro';
  }

  function getBankInfo(instituicao, accountName) {
    var key = resolveBankKey(instituicao, accountName);
    return BANK_REPOSITORY[key] || BANK_REPOSITORY['Outro'];
  }

  function renderAccounts(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    var content = document.getElementById('content');
    content.innerHTML = '<div class="filters-bar" style="justify-content:space-between">' +
      '<div style="font-size:16px;font-weight:700">Minhas Contas</div>' +
      '<button class="btn-primary btn-sm" onclick="openAccountModal()">+ Nova Conta</button>' +
      '</div>' +
      '<div id="accounts-list" class="account-grid"></div>' +
      '<div style="margin-top:32px;border-top:1px solid var(--border);padding-top:20px">' +
      '<div style="font-size:14px;font-weight:600;margin-bottom:12px;color:var(--text-muted)">Contas, Investimentos e Reservas</div>' +
      '<p style="font-size:13px;color:var(--text-secondary)">Gerencie aqui todas as suas fontes de dinheiro. A conta "Investimentos" substitui a antiga Reserva de Manutenção.</p>' +
      '</div>';

    var area = document.getElementById('accounts-list');
    if (area && APP.accountsLastHtml) {
      area.innerHTML = APP.accountsLastHtml;
      loadAccounts(routeToken, { syncOnly: true, renderAfterSync: true });
      return;
    }
    loadAccounts(routeToken, { showPlaceholder: true });
  }

  function renderAccountsPendingState_(area) {
    if (!area) return;
    area.innerHTML = '<div class="empty-state"><div class="empty-text">Carregando contas...</div></div>';
  }

  function syncAccountsFromServer_(routeToken, renderAfterSync) {
    routeToken = routeToken || getActiveRouteToken_();
    rpc('listAccounts', { includeInactive: true }, function (data) {
      APP.accounts = data || [];
      setCached({ base: 'accounts', key: 'list' }, APP.accounts);
      if (!renderAfterSync) return;
      if (!isRouteTokenValid_(routeToken)) return;
      if (APP.route !== 'accounts') return;
      renderAccountList(APP.accounts, routeToken);
    }, function (err) {
      if (!isRouteTokenValid_(routeToken)) return;
      if (APP.route !== 'accounts') return;
      if (APP.accounts && APP.accounts.length) return;
      var area = document.getElementById('accounts-list');
      if (!area) return;
      area.innerHTML = '<div class="empty-state"><div class="empty-text">Erro ao carregar contas: ' + String(err || 'erro desconhecido') + '</div>' +
        '<button class="btn-secondary btn-sm" onclick="loadAccounts(getActiveRouteToken_(), { showPlaceholder: true })" style="margin-top:10px">Tentar novamente</button></div>';
      APP.accountsLastHtml = area.innerHTML;
    }, true);
  }

  function loadAccounts(routeToken, options) {
    routeToken = routeToken || getActiveRouteToken_();
    options = options || {};
    var area = document.getElementById('accounts-list');
    if (!area) return;

    var syncOnly = !!options.syncOnly;
    var renderAfterSync = options.renderAfterSync !== false;
    var showPlaceholder = options.showPlaceholder !== false;

    var cached = getCached({ base: 'accounts', key: 'list' });
    if (cached && cached.length) {
      APP.accounts = cached;
      if (!syncOnly) renderAccountList(cached, routeToken);
      syncAccountsFromServer_(routeToken, renderAfterSync);
      return;
    }

    if (APP.accounts && APP.accounts.length) {
      if (!syncOnly) renderAccountList(APP.accounts, routeToken);
      syncAccountsFromServer_(routeToken, renderAfterSync);
      return;
    }

    if (syncOnly) {
      syncAccountsFromServer_(routeToken, renderAfterSync);
      return;
    }

    if (showPlaceholder && !String(area.innerHTML || '').trim()) {
      renderAccountsPendingState_(area);
    }
    syncAccountsFromServer_(routeToken, renderAfterSync);
  }

  function renderAccountList(accounts, routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    var area = document.getElementById('accounts-list');
    if (!area) return;

    if (!accounts || accounts.length === 0) {
      area.innerHTML = '<div class="empty-state">Nenhuma conta encontrada.</div>';
      APP.accountsLastHtml = area.innerHTML;
      var emptyContent = document.getElementById('content');
      if (emptyContent) setRouteSnapshot_('accounts', emptyContent.innerHTML);
      return;
    }

    // Ordenar por ordem
    accounts.sort(function (a, b) { return (a.ordem || 99) - (b.ordem || 99); });

    var html = '';
    accounts.forEach(function (acc) {
      if (isAccountHidden_(acc.id)) return;
      if (!acc.ativo) return;

      var info = getBankInfo(acc.instituicao, acc.nome);
      var saldoClass = acc.saldoAtual >= 0 ? '' : 'negative'; // Removed 'positive' to use white/theme text mostly

      // Card Background
      var bgStyle = 'background: ' + info.color;
      var textStyle = 'color: #FFF';
      if (info.textColor) textStyle = 'color: ' + info.textColor;

      // Logo Element
      var logoHtml = '';
      if (info.type === 'img') {
        var errorHandler = "this.style.display='none'; this.nextElementSibling.style.display='flex'";
        logoHtml = '<img src="' + info.logo + '" onerror="' + errorHandler + '" style="width:32px;height:32px;border-radius:50%;object-fit:cover;background:#fff">' +
          '<div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:18px;display:none">' + (info.fallback || 'x') + '</div>';
      } else {
        logoHtml = '<div style="width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,0.2);display:flex;align-items:center;justify-content:center;font-size:18px">' + info.logo + '</div>';
      }

      html += '<div class="account-card" onclick="openAccountModal(\'' + acc.id + '\')" style="' + bgStyle + ';' + textStyle + ';border:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);position:relative;overflow:hidden">' +
        // Glossy effect overlay
        '<div style="position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);pointer-events:none"></div>' +

        '<div class="account-card-header" style="position:relative;z-index:1">' +
        '<div style="display:flex;align-items:center;gap:12px">' +
        logoHtml +
        '<div>' +
        '<div class="account-name" style="font-size:15px;font-weight:600;opacity:0.9">' + acc.nome + '</div>' +
        '<div class="account-type" style="font-size:12px;opacity:0.7">' + info.name + '</div>' +
        '</div>' +
        '</div>' +
        '</div>' +

        '<div class="account-balance ' + saldoClass + '" style="position:relative;z-index:1;margin-top:16px;font-size:20px;font-weight:700">' + fmtCurrency(acc.saldoAtual) + '</div>' +
        '</div>';
    });

    if (!html) {
      area.innerHTML = '<div class="empty-state">Nenhuma conta encontrada.</div>';
      APP.accountsLastHtml = area.innerHTML;
      var emptyContent2 = document.getElementById('content');
      if (emptyContent2) setRouteSnapshot_('accounts', emptyContent2.innerHTML);
      return;
    }

    if (!isRouteTokenValid_(routeToken)) return;
    area.innerHTML = html;
    APP.accountsLastHtml = html;
    var content = document.getElementById('content');
    if (content) setRouteSnapshot_('accounts', content.innerHTML);
  }

  function openAccountModal(accId) {
    var isEdit = !!accId;
    var acc = null;
    if (isEdit) {
      acc = APP.accounts.find(function (a) { return a.id === accId; });
      if (!acc) return;
    }

    document.getElementById('modal-title').textContent = isEdit ? 'Editar Conta' : 'Nova Conta';

    var currentInst = resolveBankKey(acc ? acc.instituicao : '', acc ? acc.nome : '');

    var body = '<div class="form-group"><label class="form-label">Nome da Conta</label>' +
      '<input type="text" class="form-input" id="acc-name" value="' + (acc ? acc.nome : '') + '" placeholder="Ex: Principal, Reserva..."></div>';

    body += '<div class="form-group"><label class="form-label">Instituição Financeira</label>' +
      '<div id="bank-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(60px, 1fr));gap:12px;margin-top:8px">';

    // Gerar grid de bancos
    var bankKeys = Object.keys(BANK_REPOSITORY);
    bankKeys.forEach(function (key) {
      var bank = BANK_REPOSITORY[key];
      var isSelected = currentInst === key;
      var borderStyle = isSelected ? 'border:2px solid var(--primary);box-shadow:0 0 0 2px rgba(108,99,255,0.2)' : 'border:1px solid var(--border)';
      var opacity = isSelected ? '1' : '0.7';

      var content = '';
      if (bank.type === 'img') {
        content = '<img src="' + bank.logo + '" onerror="this.style.display=\'none\';this.nextElementSibling.style.display=\'flex\'" style="width:32px;height:32px;border-radius:50%;object-fit:cover;background:#fff">' +
          '<span style="font-size:24px;display:none">' + (bank.fallback || 'x') + '</span>';
      } else {
        content = '<span style="font-size:24px">' + bank.logo + '</span>';
      }

      body += '<div class="bank-option" onclick="selectBank(\'' + key + '\')" data-key="' + key + '" style="cursor:pointer;border-radius:12px;padding:8px;display:flex;flex-direction:column;align-items:center;gap:4px;background:var(--bg-card);transition:all 0.2s;' + borderStyle + ';opacity:' + opacity + '">' +
        content +
        '<span style="font-size:10px;text-align:center;line-height:1.2;color:var(--text-secondary)">' + bank.name + '</span>' +
        '</div>';
    });

    body += '</div><input type="hidden" id="acc-instituicao" value="' + currentInst + '"></div>';

    body += '<div class="form-group"><label class="form-label">Saldo Inicial (R$)</label>' +
      '<input type="number" class="form-input" id="acc-balance" step="0.01" value="' + (acc ? acc.saldoInicial : '0') + '"></div>';

    if (isEdit) {
      body += '<div class="form-group" style="margin-top:20px;padding-top:20px;border-top:1px solid var(--border)">' +
        '<button class="btn-danger btn-sm" onclick="deactivateAccount(\'' + acc.id + '\')">Desativar/Excluir Conta</button>' +
        '</div>';
    }

    document.getElementById('modal-body').innerHTML = body;

    var footer = '<button class="btn-secondary" onclick="closeModal()">Cancelar</button>' +
      '<button class="btn-primary" id="acc-save-btn">' + (isEdit ? 'Salvar Alterações' : 'Criar Conta') + '</button>';
    document.getElementById('modal-footer').innerHTML = footer;

    document.getElementById('acc-save-btn').addEventListener('click', function () {
      saveAccount(isEdit, accId);
    });

    openModal();
  }

  // Tornar global para acesso no onclick
  window.selectBank = function (key) {
    document.getElementById('acc-instituicao').value = key;

    // Atualizar visual
    var options = document.querySelectorAll('.bank-option');
    options.forEach(function (el) {
      if (el.getAttribute('data-key') === key) {
        el.style.border = '2px solid var(--primary)';
        el.style.boxShadow = '0 0 0 2px rgba(108,99,255,0.2)';
        el.style.opacity = '1';
        el.style.transform = 'scale(1.05)';
      } else {
        el.style.border = '1px solid var(--border)';
        el.style.boxShadow = 'none';
        el.style.opacity = '0.7';
        el.style.transform = 'scale(1)';
      }
    });

    // Auto-preencher nome se vazio ou genérico
    var nameInput = document.getElementById('acc-name');
    var currentName = nameInput.value.trim();
    if (!currentName || currentName === 'Nova Conta' || Object.keys(BANK_REPOSITORY).some(function (k) { return BANK_REPOSITORY[k].name === currentName; })) {
      nameInput.value = BANK_REPOSITORY[key].name;
    }
  };

  function renderAccountsIfActive_() {
    if (APP.route !== 'accounts') return;
    var token = getActiveRouteToken_();
    renderAccountList(APP.accounts || [], token);
  }

  function markAccountHidden_(id, ttlMs) {
    if (!id) return;
    if (!APP.accountHiddenIds) APP.accountHiddenIds = {};
    APP.accountHiddenIds[id] = Date.now() + (ttlMs || 45000);
  }

  function unhideAccount_(id) {
    if (!id || !APP.accountHiddenIds) return;
    delete APP.accountHiddenIds[id];
  }

  function isAccountHidden_(id) {
    if (!id || !APP.accountHiddenIds) return false;
    var until = APP.accountHiddenIds[id];
    if (!until) return false;
    if (until <= Date.now()) {
      delete APP.accountHiddenIds[id];
      return false;
    }
    return true;
  }

  function getNextAccountOrder_() {
    var maxOrder = 0;
    (APP.accounts || []).forEach(function (a) {
      if (!a) return;
      if ((a.ordem || 0) > maxOrder) maxOrder = a.ordem || 0;
    });
    return maxOrder + 1;
  }

  function applyLocalCreateAccount_(accountId, payload) {
    if (!APP.accounts || !Array.isArray(APP.accounts)) APP.accounts = [];
    var exists = APP.accounts.find(function (a) { return a.id === accountId; });
    if (exists) return;

    var saldoInicial = parseFloat(payload.saldoInicial);
    if (isNaN(saldoInicial)) saldoInicial = 0;
    unhideAccount_(accountId);

    APP.accounts = APP.accounts.concat([{
      id: accountId,
      nome: payload.nome,
      tipo: payload.tipo || 'Banco',
      instituicao: payload.instituicao || 'Outro',
      saldoInicial: saldoInicial,
      saldoAtual: saldoInicial,
      ativo: true,
      ordem: getNextAccountOrder_()
    }]);

    setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    renderAccountsIfActive_();
  }

  function applyLocalUpdateAccount_(id, payload) {
    if (!APP.accounts || !APP.accounts.length) return;
    var changed = false;
    unhideAccount_(id);
    APP.accounts.forEach(function (acc) {
      if (!acc || acc.id !== id) return;
      changed = true;
      var prevSaldoInicial = parseFloat(acc.saldoInicial) || 0;
      acc.nome = payload.nome !== undefined ? payload.nome : acc.nome;
      acc.tipo = payload.tipo !== undefined ? payload.tipo : acc.tipo;
      acc.instituicao = payload.instituicao !== undefined ? payload.instituicao : acc.instituicao;
      if (payload.saldoInicial !== undefined) {
        var newSaldoInicial = parseFloat(payload.saldoInicial);
        if (isNaN(newSaldoInicial)) newSaldoInicial = 0;
        acc.saldoInicial = newSaldoInicial;
        var saldoAtualNum = parseFloat(acc.saldoAtual) || 0;
        if (Math.abs(saldoAtualNum - prevSaldoInicial) < 0.0001) acc.saldoAtual = newSaldoInicial;
      }
    });
    if (!changed) return;
    setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    renderAccountsIfActive_();
  }

  function applyLocalDeactivateAccount_(id) {
    if (!APP.accounts || !APP.accounts.length) return;
    markAccountHidden_(id, 60000);
    var changed = false;
    APP.accounts.forEach(function (acc) {
      if (!acc || acc.id !== id) return;
      acc.ativo = false;
      changed = true;
    });
    if (!changed) return;
    setCached({ base: 'accounts', key: 'list' }, APP.accounts);
    renderAccountsIfActive_();
  }


  function saveAccount(isEdit, id) {
    var name = document.getElementById('acc-name').value;
    var instituicao = document.getElementById('acc-instituicao').value;
    var initialBalance = document.getElementById('acc-balance').value;

    if (!name) { toast('Nome é obrigatório', 'error'); return; }

    var btn = document.getElementById('acc-save-btn');
    btn.disabled = true;
    btn.textContent = 'Salvando...';

    // Derivar tipo baseado na instituição (regra simples)
    var type = 'Banco';
    if (instituicao === 'Carteira') type = 'Dinheiro';
    if (instituicao === 'Investimentos' || instituicao === 'BTG' || instituicao === 'Rico' || instituicao === 'XP') type = 'Investimentos';

    var payload = {
      nome: name,
      tipo: type,
      instituicao: instituicao,
      saldoInicial: initialBalance
    };

    if (isEdit) {
      payload.id = id;
      rpc('updateAccount', payload, function () {
        applyLocalUpdateAccount_(id, payload);
        toast('Conta atualizada!', 'success');
        closeModal();
        loadAccounts(getActiveRouteToken_(), { syncOnly: true, renderAfterSync: true });
      }, function (err) {
        toast(err, 'error');
        btn.disabled = false;
      });
    } else {
      rpc('createAccount', payload, function (result) {
        var createdId = (result && result.id) ? result.id : '';
        if (createdId) applyLocalCreateAccount_(createdId, payload);
        toast('Conta criada!', 'success');
        closeModal();
        loadAccounts(getActiveRouteToken_(), { syncOnly: true, renderAfterSync: true });
      }, function (err) {
        toast(err, 'error');
        btn.disabled = false;
      });
    }
  }

  function deactivateAccount(id) {
    if (!confirm('Tem certeza que deseja desativar esta conta? Ela não aparecerá mais nas opções de lançamento.')) return;

    rpc('deactivateAccount', id, function () {
      applyLocalDeactivateAccount_(id);
      toast('Conta desativada.', 'success');
      closeModal();
      loadAccounts(getActiveRouteToken_(), { syncOnly: true, renderAfterSync: true });
    });
  }

  // Helper para abrir modal genérico
  function openModal() {
    document.getElementById('modal-overlay').classList.remove('hidden');
  }

  function closeModal() {
    document.getElementById('modal-overlay').classList.add('hidden');
  }

  // Atualizar refreshCurrentView para suportar contas
  function refreshCurrentView() {
    if (APP.route === 'dashboard') {
      clearCached(cacheKey('dashboard'));
      renderDashboard();
    } else if (APP.route === 'transactions') {
      clearCached(cacheKey('transactions'));
      loadTransactions();
    } else if (APP.route === 'accounts') {
      loadAccounts();
    }
  }

  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  // RECURRENCE SCOPE HELPER
  // """""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""""
  function createScopeModal() {
    if (document.getElementById('scope-modal-overlay')) return;

    var div = document.createElement('div');
    div.id = 'scope-modal-overlay';
    div.className = 'modal-overlay hidden';
    div.style.zIndex = '300'; // Above normal modal

    var html = '<div class="modal-container" style="max-width:400px">' +
      '<div class="modal-header">' +
      '<h3 id="scope-modal-title">Editar Recorrência</h3>' +
      '<button class="modal-close" id="scope-modal-close"></button>' +
      '</div>' +
      '<div class="modal-body">' +
      '<p class="confirm-text" style="margin-bottom:16px">Esta transação faz parte de um grupo recorrente. Como deseja aplicar a alteração?</p>' +
      '<div class="scope-options">' +
      '<label class="scope-option">' +
      '<input type="radio" name="scope-selection" value="THIS" checked>' +
      '<div><div class="scope-title">Apenas esta</div><div class="scope-desc">Alterar somente este lançamento.</div></div>' +
      '</label>' +
      '<label class="scope-option">' +
      '<input type="radio" name="scope-selection" value="FOLLOWING">' +
      '<div><div class="scope-title">Esta e futuras</div><div class="scope-desc">Alterar esta e todas as próximas.</div></div>' +
      '</label>' +
      '<label class="scope-option">' +
      '<input type="radio" name="scope-selection" value="ALL">' +
      '<div><div class="scope-title">Todas</div><div class="scope-desc">Alterar todas do grupo.</div></div>' +
      '</label>' +
      '</div>' +
      '</div>' +
      '<div class="modal-footer">' +
      '<button class="btn-secondary" id="scope-btn-cancel">Cancelar</button>' +
      '<button class="btn-primary" id="scope-btn-confirm">Confirmar</button>' +
      '</div>' +
      '</div>';

    div.innerHTML = html;
    document.body.appendChild(div);

    // Events
    document.getElementById('scope-modal-close').addEventListener('click', closeScopeModal);
    document.getElementById('scope-btn-cancel').addEventListener('click', closeScopeModal);
    // Overlay click
    div.addEventListener('click', function (e) {
      if (e.target === div) closeScopeModal();
    });
  }

  function openScopeModal(title, actionLabel, onConfirm) {
    createScopeModal();

    document.getElementById('scope-modal-title').textContent = title || 'Recorrência';
    document.getElementById('scope-btn-confirm').textContent = actionLabel || 'Confirmar';

    // Reset selection to THIS
    var radios = document.getElementsByName('scope-selection');
    for (var i = 0; i < radios.length; i++) {
      if (radios[i].value === 'THIS') radios[i].checked = true;
    }

    var ov = document.getElementById('scope-modal-overlay');
    ov.classList.remove('hidden');

    // Handle Confirm
    var btn = document.getElementById('scope-btn-confirm');
    // Remove old listeners involves cloning or managing references. 
    // Easier: replace node to clear listeners
    var newBtn = btn.cloneNode(true);
    btn.parentNode.replaceChild(newBtn, btn);

    newBtn.addEventListener('click', function () {
      var selected = 'THIS';
      var radios = document.getElementsByName('scope-selection');
      for (var i = 0; i < radios.length; i++) {
        if (radios[i].checked) selected = radios[i].value;
      }
      closeScopeModal();
      if (onConfirm) onConfirm(selected);
    });
  }

  function closeScopeModal() {
    var ov = document.getElementById('scope-modal-overlay');
    if (ov) ov.classList.add('hidden');
  }

  // ============================================================
  // CART"ES DE CR0DITO  Integração na SPA existente
  // ============================================================

  // Flag: módulo de cartões já foi inicializado (evita duplo-boot)
  var _cartoesModuleReady = false;
  var _cartoesBootstrapped = false;
  function _cartoesRemoveLegacyCss_() {
    var legacy = document.getElementById('cartoes-css');
    if (legacy && legacy.parentNode) legacy.parentNode.removeChild(legacy);
  }

  function renderCartoes(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!isRouteTokenValid_(routeToken)) return;
    var content = document.getElementById('content');
    if (!content) return;

    // Remove CSS legado global da versão iframe (evita "encolher" o app inteiro)
    _cartoesRemoveLegacyCss_();

    // Garante API global do módulo antes de montar handlers inline (onclick="CartApp...")
    if (typeof CartApp === 'undefined') {
      _cartoesBootstrapped = false;
      _cartoesDefineCartApp();
    }

    // Em cartões, manter navegação de mês visível para referência/pagamento mensal.
    var topbarCenter = document.querySelector('.topbar-center');
    var btnAddTx     = document.getElementById('btn-add-tx');
    if (topbarCenter) topbarCenter.style.visibility = '';
    if (btnAddTx)     btnAddTx.style.display = 'none';

    // Se o módulo já está montado (voltou de detalhe / re-clicou na nav)
    // só re-renderiza a lista com os dados já em _store
    if (_cartoesModuleReady && typeof CartApp !== 'undefined') {
      if (!document.getElementById('cartoes-root')) {
        _cartoesModuleReady = false; // força reconstrução se o DOM foi reciclado
      } else {
        CartApp.showView();
        CartApp.refresh(); // sync silencioso em background
        return;
      }
    }

    // Se a rota mudou enquanto preparava render, aborta
    if (!isRouteTokenValid_(routeToken)) return;

    // Monta o container + shell HTML sempre (garante IDs no DOM)
    content.innerHTML = '<div id="cartoes-root"></div>' +
      '<style>@keyframes cartSkel{0%,100%{opacity:.6}50%{opacity:.25}}</style>';

    _cartoesInjectModule(routeToken); // constrói o HTML interno e seta _cartoesModuleReady = true
  }

  function _cartoesInjectModule(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!_isRouteCartoes()) return;

    var root = document.getElementById('cartoes-root');
    if (!root) return;
    root.style.color = 'var(--text)';
    root.style.setProperty('--text-primary', 'var(--text)');
    root.style.setProperty('--text-muted', 'var(--text-secondary)');
    root.style.setProperty('--bg-secondary', 'var(--bg-card)');
    root.style.setProperty('--card-bg', 'var(--bg-card)');
    root.style.setProperty('--input-bg', 'var(--bg-input)');
    root.style.setProperty('--border-color', 'var(--border)');

    // Estrutura do módulo embutida diretamente (sem iframe, sem redirect)
    root.innerHTML =
      // Header interno da tela de cartões
      '<div class="filters-bar" style="justify-content:space-between;margin-bottom:12px">' +
        '<div class="section-title" style="margin:0">Cartões de Crédito</div>' +
        '<div style="display:flex;gap:8px;align-items:center">' +
          '<span style="font-size:.78rem;color:var(--text-secondary)">Ref.: ' + fmtMonthLabel(APP.month, APP.year) + '</span>' +
          '<button class="btn-primary btn-sm" onclick="CartApp.openAddCard()">+ Novo cartão</button>' +
        '</div>' +
      '</div>' +
      '<div class="section-card">' +

      // Debug bar (oculto)
      '<div id="cart-debug-bar" style="display:none;background:#0f1117;color:#68D391;font:11px monospace;padding:4px 12px;border-radius:6px;margin-bottom:8px"></div>' +

      // Filtros + busca
      '<div id="cart-filter-bar" class="filters-bar" style="margin-bottom:16px">' +
        '<div style="flex:1;min-width:200px;position:relative;display:flex;align-items:center">' +
          '<svg style="position:absolute;left:10px;color:#8892a0;pointer-events:none" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>' +
          '<input type="search" class="filter-input" id="cart-search" placeholder="Buscar cartão..." style="width:100%;padding-left:34px" oninput="CartApp.onSearch(this.value)">' +
        '</div>' +
        '<div style="display:flex;gap:8px;align-items:center">' +
          '<div style="display:flex;background:rgba(255,255,255,.06);border-radius:10px;padding:3px;gap:2px">' +
            '<button id="cart-tab-ativos" onclick="CartApp.filterStatus(\'ativos\')" style="padding:6px 14px;border:none;border-radius:8px;background:rgba(91,95,239,.9);color:white;font:inherit;font-size:0.82rem;font-weight:700;cursor:pointer">Ativos <span id="cart-badge-ativos" style="background:rgba(255,255,255,.25);border-radius:99px;padding:1px 6px;font-size:0.7rem">0</span></button>' +
            '<button id="cart-tab-arq" onclick="CartApp.filterStatus(\'arquivados\')" style="padding:6px 14px;border:none;border-radius:8px;background:transparent;color:#8892a0;font:inherit;font-size:0.82rem;font-weight:600;cursor:pointer">Arquivados <span id="cart-badge-arq" style="background:rgba(255,255,255,.1);border-radius:99px;padding:1px 6px;font-size:0.7rem">0</span></button>' +
          '</div>' +
          '<select id="cart-sort" onchange="CartApp.onSort(this.value)" style="padding:8px 10px;background:var(--input-bg,#2a2e3d);border:1.5px solid var(--border-color,#3a3f50);border-radius:10px;color:var(--text-primary,#e8eaf0);font:inherit;font-size:0.82rem;cursor:pointer;outline:none">' +
            '<option value="pct_desc">% Uso (desc)</option>' +
            '<option value="venc_asc">Vencimento (asc)</option>' +
            '<option value="nome_asc">Nome A-Z</option>' +
          '</select>' +
        '</div>' +
      '</div>' +

      // KPI bar (totais)
      '<div id="cart-kpi-row" class="kpi-grid" style="display:none;margin-bottom:16px"></div>' +

      // Grid de cards
      '<div id="cart-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:16px"></div>' +

      // Estado vazio
      '<div id="cart-empty" style="display:none;flex-direction:column;align-items:center;justify-content:center;gap:12px;padding:50px 20px;text-align:center">' +
        '<div style="width:70px;height:70px;background:rgba(255,255,255,.06);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:2rem">CC</div>' +
        '<h3 id="cart-empty-title" style="margin:0;font-size:1rem;color:var(--text-primary,#e8eaf0)">Nenhum cartão encontrado</h3>' +
        '<p id="cart-empty-desc" style="margin:0;font-size:0.87rem;color:#8892a0">Adicione seu primeiro cartão clicando em "+ Novo cartão".</p>' +
      '</div>' +

      // Modal e toast internos (usa os do app global)
      '</div>';

    _cartoesModuleReady = true;
    _cartoesBootAgent(routeToken);
  }

  function _cartoesBootAgent(routeToken) {
    routeToken = routeToken || getActiveRouteToken_();
    if (!_isRouteCartoes()) return;
    if (routeToken && !isRouteTokenValid_(routeToken)) return;

    // Inicializa o CartApp se ainda não foi
    if (typeof CartApp === 'undefined') {
      _cartoesBootstrapped = false;
      _cartoesDefineCartApp();
    }
    if (!_cartoesBootstrapped) {
      _cartoesBootstrapped = true;
      // Se temos dados pré-carregados no boot do app, renderiza imediatamente (0ms latência)
      if (APP.cartoesBootData && APP.cartoesBootData.cartoes) {
        CartApp.bootFromCache(APP.cartoesBootData);
      } else {
        CartApp.boot();
      }
    } else if (typeof CartApp !== 'undefined' && CartApp._store_hasData && CartApp._store_hasData()) {
      // goBack ou re-navigate: já tem dados em memória   renderiza na hora, sincroniza depois
      CartApp.showView();
      CartApp.refresh(); // sync silencioso em background
    } else {
      CartApp.showView();
      CartApp.refresh();
    }
  }

  function _isRouteCartoes() {
    return APP.route === 'cartoes';
  }

  // Restaura topbar quando sai da rota cartões
  // Chamado diretamente pelo navigate() do app (sem override frágil de setTimeout)
  function _cartoesRestoreTopbar() {
    var tc = document.querySelector('.topbar-center');
    var ba = document.getElementById('btn-add-tx');
    if (tc) tc.style.visibility = '';
    if (ba) ba.style.display = '';
    _cartoesRemoveLegacyCss_();
  }


  // ============================================================
  // CartApp  controlador do módulo de cartões (embutido)
  // ============================================================
  function _cartoesDefineCartApp() {

    var _store = {
      cartoes: [], etag: null,
      filterStatus: 'ativos', searchQuery: '', sortBy: 'pct_desc',
      debugMode: false, cartaoDetalhe: null, faturas: [], faturaVigente: null, detalheCache: {},
      faturaMesMap: {}, faturaMesKey: ''
    };

    var _pollTimer = null;
    var _pollInterval = 20000;
    var _pollBackoffMultiplier = 1;
    var _pollMaxInterval = 120000;
    var _pollFailCount = 0;
    var _searchTimer = null;
    var _MESES_CURTO = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];

    // ---- utilitários ----
    function _brl(v) {
      return (parseFloat(v)||0).toLocaleString('pt-BR', {style:'currency',currency:'BRL'});
    }
    function _esc(s) {
      return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }
    function _dark(hex, amt) {
      amt = amt||30;
      var r=Math.max(0,parseInt(hex.slice(1,3),16)-amt);
      var g=Math.max(0,parseInt(hex.slice(3,5),16)-amt);
      var b=Math.max(0,parseInt(hex.slice(5,7),16)-amt);
      return '#'+[r,g,b].map(function(x){return x.toString(16).padStart(2,'0');}).join('');
    }
    function _pctCls(p) { return p>=80?'danger':p>=50?'warn':'ok'; }
    function _bandSvg(b) {
      b = String(b||'').toLowerCase();
      if (b==='master') return '<svg width="36" height="22" viewBox="0 0 36 22"><circle cx="13" cy="11" r="10" fill="#EB001B" opacity=".9"/><circle cx="23" cy="11" r="10" fill="#F79E1B" opacity=".9"/><path d="M18 3.5a10 10 0 0 1 0 15A10 10 0 0 1 18 3.5z" fill="#FF5F00" opacity=".9"/></svg>';
      if (b==='visa') return '<svg width="44" height="14" viewBox="0 0 44 14"><text x="0" y="12" font-family="Arial" font-size="14" font-weight="800" fill="white" letter-spacing="1">VISA</text></svg>';
      if (b==='amex') return '<svg width="36" height="20" viewBox="0 0 36 20"><rect width="36" height="20" rx="3" fill="rgba(255,255,255,.2)"/><text x="5" y="14" font-family="Arial" font-size="10" font-weight="800" fill="white">AMEX</text></svg>';
      if (b==='elo')  return '<svg width="36" height="20" viewBox="0 0 36 20"><rect width="36" height="20" rx="3" fill="rgba(255,255,255,.2)"/><text x="8" y="14" font-family="Arial" font-size="11" font-weight="800" fill="#FFD700">elo</text></svg>';
      return '<svg width="32" height="20" viewBox="0 0 32 20"><rect width="32" height="20" rx="3" fill="rgba(255,255,255,.15)"/><circle cx="12" cy="10" r="6" fill="rgba(255,255,255,.25)"/><circle cx="20" cy="10" r="6" fill="rgba(255,255,255,.15)"/></svg>';
    }
    function _hoje() {
      var d=new Date(); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    }
    function _mesAno(m,a) { return _MESES_CURTO[(parseInt(m)||1)-1]+'/'+a; }
    function _refFaturaAtualByCard_(card) {
      var now = new Date();
      var y = now.getFullYear();
      var m = now.getMonth() + 1;
      var d = now.getDate();
      var fechamento = parseInt((card && card.dia_fechamento) || 1, 10) || 1;
      var refMes = (d > fechamento) ? (m + 1) : m;
      var refAno = y;
      if (refMes > 12) { refMes = 1; refAno += 1; }
      return { ano: refAno, mes: refMes };
    }
    function _valorFaturaVigente(cartaoId, ano, mes) {
      if (_store.faturaVigente && String(_store.faturaVigente.id_cartao || '') === String(cartaoId)) {
        var vv = parseFloat(_store.faturaVigente.valor || _store.faturaVigente.valor_mes || 0) || 0;
        if (vv > 0) return vv;
      }
      var targetYear = parseInt(ano) || APP.year;
      var targetMonth = parseInt(mes) || APP.month;
      var faturas = _store.faturas || [];
      for (var i = 0; i < faturas.length; i++) {
        var f = faturas[i];
        if (String(f.id_cartao) !== String(cartaoId)) continue;
        if (parseInt(f.ano_ref, 10) !== targetYear) continue;
        if (parseInt(f.mes_ref, 10) !== targetMonth) continue;
        var vf = parseFloat(f.valor_mes || f.valor || 0) || 0;
        if (vf > 0) return vf;
      }
      var vm = parseFloat((_store.faturaMesMap || {})[String(cartaoId)] || 0) || 0;
      if (vm > 0) return vm;
      var card = (_store.cartaoDetalhe && String(_store.cartaoDetalhe.id || '') === String(cartaoId))
        ? _store.cartaoDetalhe
        : (_store.cartoes || []).find(function(c){ return String(c.id || '') === String(cartaoId); });
      if (card) return parseFloat(card.limite_usado || 0) || 0;
      return 0;
    }

    function _syncAfterCardPayment(cardId, totalPago) {
      var pago = parseFloat(totalPago) || 0;
      if (cardId && pago > 0) {
        var c = _store.cartoes.find(function (it) { return String(it.id) === String(cardId); });
        if (c) {
          var used = Math.max(0, (parseFloat(c.limite_usado) || 0) - pago);
          c.limite_usado = used;
          c.limite_disponivel = Math.max(0, (parseFloat(c.limite_total) || 0) - used);
          c.pct_uso = (parseFloat(c.limite_total) || 0) > 0 ? Math.round((used / parseFloat(c.limite_total)) * 100) : 0;
        }
      }
      _renderList();
      if (typeof refreshCardsBootCache_ === 'function') refreshCardsBootCache_();
      clearCached('dashboard');
      clearCached('reports');
      clearCached('installmentsDash');
      clearCached('transactions');
      // Pré-carrega dashboard atualizado para evitar atrasos na home.
      setTimeout(function () {
        rpc('getDashboard', { month: APP.month, year: APP.year }, function () {}, null, true);
      }, 120);
    }

    function _waitPaymentSync_(cardId, expectedUsedMax, done) {
      var attempts = 0;
      var maxAttempts = 8;
      var targetMax = parseFloat(expectedUsedMax);
      if (isNaN(targetMax)) targetMax = null;

      function check() {
        attempts++;
        _rpc('bootstrap', null).then(function(res) {
          if (!res.ok || !res.data || !res.data.cartoes) {
            if (attempts < maxAttempts) return setTimeout(check, 280);
            if (done) done(false);
            return;
          }
          _store.cartoes = res.data.cartoes || [];
          APP.cartoesBootData = res.data;
          _renderList();
          var ok = true;
          if (cardId && targetMax !== null) {
            var c = _store.cartoes.find(function(it){ return String(it.id) === String(cardId); });
            if (c) ok = (parseFloat(c.limite_usado) || 0) <= (targetMax + 0.01);
          }
          if (ok || attempts >= maxAttempts) {
            if (done) done(ok);
            return;
          }
          setTimeout(check, 280);
        });
      }
      check();
    }

    function _faturaMesKey_() {
      return String(APP.year) + '-' + String(APP.month).padStart(2, '0');
    }

    function _loadFaturaMesMap_(onDone) {
      var key = _faturaMesKey_();
      if (_store.faturaMesKey === key && _store.faturaMesMap && Object.keys(_store.faturaMesMap).length) {
        if (onDone) onDone();
        return;
      }
      _rpc('getCartoesFaturaMes', [APP.year, APP.month]).then(function(res) {
        var map = {};
        var mapFull = {};
        if (res && res.ok && res.data && Array.isArray(res.data.itens)) {
          res.data.itens.forEach(function(it) {
            var cid = String(it.id_cartao || '');
            map[cid] = parseFloat(it.valor_mes) || 0;
            mapFull[cid] = {
              valor_mes: parseFloat(it.valor_mes) || 0,
              valor_total: parseFloat(it.valor_total) || 0,
              valor_pago: parseFloat(it.valor_pago) || 0,
              status: String(it.status || 'Aberta')
            };
          });
        }
        _store.faturaMesMap = map;
        _store.faturaMesMapFull = mapFull;
        _store.faturaMesKey = key;
        if (onDone) onDone();
      });
    }

    // ---- API calls (usa o rpc() global do app para cache + auth + dedup) ----
    function _rpc(fn, args) {
      return new Promise(function(resolve) {
        var callArgs = Array.isArray(args) ? args.slice() : (args === null || args === undefined ? [] : [args]);
        var sessionToken = (typeof getAuthSessionToken === 'function') ? getAuthSessionToken() : '';

        function normalizeResponse_(raw) {
          var parsed = raw;
          if (typeof parsed === 'string') {
            try {
              parsed = JSON.parse(parsed);
            } catch (e) {
              return { ok: false, error: { code: 'PARSE', message: 'Resposta invalida do servidor' } };
            }
          }
          if (parsed && typeof parsed === 'object' && Object.prototype.hasOwnProperty.call(parsed, 'ok')) {
            return parsed;
          }
          return { ok: true, data: parsed };
        }

        function invalidateIfNeeded_() {
          if (typeof invalidateCachesForRpc_ !== 'function') return;
          if (!RPC_INVALIDATE_MAP || !RPC_INVALIDATE_MAP[fn]) return;
          invalidateCachesForRpc_(fn);
          if (RPC_INVALIDATE_MAP[fn].indexOf('cartoes') !== -1) {
            // Evita "piscar" o dashboard sem cartões: mantém cache vivo e atualiza em background.
            setTimeout(function () {
              if (typeof rpc !== 'function') return;
              rpc('listCartoes', 'ativos', function (res) {
                var cards = extractCardsList_(res);
                APP.cartoesBootData = APP.cartoesBootData || {};
                APP.cartoesBootData.cartoes = cards;
              }, null, true);
            }, 0);
          }
        }

        var runner = google.script.run
          .withSuccessHandler(function(raw) {
            var res = normalizeResponse_(raw);
            if (res.ok) invalidateIfNeeded_();
            resolve(res);
          })
          .withFailureHandler(function(e) {
            resolve({
              ok: false,
              error: { code: 'TRANSPORT', message: e && e.message ? e.message : String(e || 'Erro de comunicacao') }
            });
          });

        if (sessionToken) {
          var authArgs = [fn].concat(callArgs);
          authArgs.push(sessionToken);
          runner.authRpc.apply(runner, authArgs);
          return;
        }

        if (!callArgs.length) runner[fn]();
        else if (callArgs.length === 1) runner[fn](callArgs[0]);
        else if (callArgs.length === 2) runner[fn](callArgs[0], callArgs[1]);
        else if (callArgs.length === 3) runner[fn](callArgs[0], callArgs[1], callArgs[2]);
        else runner[fn].apply(runner, callArgs);
      });
    }

    // ---- Toast (usa o do app global) ----
    function _toast(msg, type) {
      type = type||'info';
      var tc = document.getElementById('toast-container');
      if (!tc) return;
      var colors = {success:'#065f46',error:'#7f1d1d',warn:'#78350f',info:'#1e3a5f'};
      var el = document.createElement('div');
      el.style.cssText = 'display:flex;align-items:center;gap:10px;padding:12px 16px;background:'+
        (colors[type]||colors.info)+';color:white;border-radius:12px;font-size:.87rem;font-weight:500;'+
        'box-shadow:0 8px 24px rgba(0,0,0,.4);animation:toastIn .25s ease;margin-top:6px;min-width:220px';
      el.textContent = msg;
      tc.appendChild(el);
      setTimeout(function(){ el.style.opacity='0'; el.style.transition='opacity .25s'; setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); },300); }, 3200);
    }

    // ---- Modal (usa modal global do app) ----
    function _openModal(html) {
      var mb = document.getElementById('modal-body');
      var mt = document.getElementById('modal-title');
      var mf = document.getElementById('modal-footer');
      var ov = document.getElementById('modal-overlay');
      if (!mb||!ov) return;
      if (mt) mt.textContent = '';
      if (mf) mf.innerHTML = '';
      mb.innerHTML = html;
      ov.classList.remove('hidden');
    }
    function _closeModal() {
      var ov = document.getElementById('modal-overlay');
      if (ov) ov.classList.add('hidden');
    }

    // ---- Snapshot helper ----
    function _saveSnapshot() {
      var root = document.getElementById('cartoes-root');
      if (root && typeof setRouteSnapshot_ === 'function') {
        setRouteSnapshot_('cartoes', root.innerHTML);
      }
    }

    // ---- Render ----
    function _renderList() {
      var grid  = document.getElementById('cart-grid');
      var empty = document.getElementById('cart-empty');
      if (!grid) return;

      // filtrar + ordenar
      var q    = (_store.searchQuery||'').toLowerCase().trim();
      var list = _store.cartoes.filter(function(c) {
        var statusOk = _store.filterStatus==='arquivados' ? !c.ativo : c.ativo;
        if (!statusOk) return false;
        if (q) return (c.nome+' '+c.emissor+' '+c.bandeira).toLowerCase().indexOf(q)>=0;
        return true;
      });
      list.sort(function(a,b) {
        if (_store.sortBy==='pct_desc')  return b.pct_uso-a.pct_uso;
        if (_store.sortBy==='venc_asc')  return String(a.prox_vencimento).localeCompare(String(b.prox_vencimento));
        if (_store.sortBy==='nome_asc')  return String(a.nome).localeCompare(String(b.nome),'pt-BR');
        return 0;
      });

      // badges
      var bA = document.getElementById('cart-badge-ativos');
      var bR = document.getElementById('cart-badge-arq');
      var totA = _store.cartoes.filter(function(c){return c.ativo;}).length;
      var totR = _store.cartoes.filter(function(c){return !c.ativo;}).length;
      if (bA) bA.textContent = totA;
      if (bR) bR.textContent = totR;

      // KPI bar
      var kpiRow = document.getElementById('cart-kpi-row');
      var ativos = _store.cartoes.filter(function(c){return c.ativo;});
      if (kpiRow && ativos.length) {
        var tT=ativos.reduce(function(s,c){return s+(c.limite_total||0);},0);
        var tU=ativos.reduce(function(s,c){return s+(c.limite_usado||0);},0);
        var tD=ativos.reduce(function(s,c){return s+(c.limite_disponivel||0);},0);
        kpiRow.style.display='flex';
        kpiRow.innerHTML=[
          {l:'Limite total',v:_brl(tT),c:'#e8eaf0'},
          {l:'Utilizado',v:_brl(tU),c:'#f87171'},
          {l:'Disponível',v:_brl(tD),c:'#34d399'}
        ].map(function(k){
          return '<div style="flex:1;min-width:100px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px">'
            +'<div style="font-size:.72rem;color:#8892a0;font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px">'+k.l+'</div>'
            +'<div style="font-size:1rem;font-weight:800;color:'+k.c+'">'+k.v+'</div>'
            +'</div>';
        }).join('');
      } else if (kpiRow) { kpiRow.style.display='none'; }

      if (!list.length) {
        grid.innerHTML='';
        if (empty) {
          empty.style.display='flex';
          var et=document.getElementById('cart-empty-title');
          var ed=document.getElementById('cart-empty-desc');
          if (et) et.textContent = q?'Nenhum resultado para "'+q+'"':_store.filterStatus==='arquivados'?'Nenhum cartão arquivado':'Nenhum cartão ativo';
          if (ed) ed.textContent = q?'Tente outro termo.':_store.filterStatus==='arquivados'?'Cartões arquivados aparecerão aqui.':'Clique em "+ Novo cartão" para começar.';
        }
        return;
      }
      if (empty) empty.style.display='none';

      var frag = document.createDocumentFragment();
      list.forEach(function(c) {
        var el = document.createElement('div');
        el.innerHTML = _cardHtml(c);
        frag.appendChild(el.firstElementChild);
      });
      grid.innerHTML='';
      grid.appendChild(frag);
      // Salva snapshot para exibição instantânea na próxima visita
      setTimeout(_saveSnapshot, 300);
    }

    function _cardHtml(c) {
      var cor     = c.cor||'#5B5FEF';
      var corD    = _dark(cor,35);
      var pctCls  = _pctCls(c.pct_uso);
      var ult4D   = c.ult4 ? ('⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢ '+c.ult4) : '⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢';
      var isAtivo = c.ativo;

      // Barra de progresso colorida
      var barColor = pctCls==='ok'?'#34d399':pctCls==='warn'?'#fbbf24':'#f87171';

      // Alertas
      var alerts='';
      if (c.alerta_uso) alerts+='<div style="display:flex;align-items:center;gap:5px;font-size:.75rem;font-weight:600;color:#fbbf24;background:rgba(251,191,36,.1);padding:4px 8px;border-radius:99px">Uso alto: '+c.pct_uso+'%</div>';
      if (c.alerta_vencimento) alerts+='<div style="display:flex;align-items:center;gap:5px;font-size:.75rem;font-weight:600;color:#f87171;background:rgba(248,113,113,.1);padding:4px 8px;border-radius:99px">Vence em '+c.dias_para_vencimento+' dia(s)</div>';

      return '<div onclick="CartApp.openDetalhe(\''+_esc(c.id)+'\')" tabindex="0" '+
        'style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,'+((c.alerta_uso||c.alerta_vencimento)?'.2':'.07')+')'
        +';border-radius:18px;overflow:hidden;cursor:pointer;transition:transform .18s,box-shadow .18s;position:relative"'+
        ' onmouseenter="this.style.transform=\'translateY(-3px)\';this.style.boxShadow=\'0 10px 30px rgba(0,0,0,.4)\'"'+
        ' onmouseleave="this.style.transform=\'\';this.style.boxShadow=\'\'"'+
        (!isAtivo?' class="cart-archived"':'')+'>' +

        // Visual do cartão
        '<div style="height:105px;background:linear-gradient(135deg,'+cor+','+corD+');padding:14px 16px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden">' +
          '<div style="position:absolute;top:-25px;right:-25px;width:140px;height:140px;background:rgba(255,255,255,.07);border-radius:50%"></div>' +
          '<div style="display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1">'+
            '<div style="width:28px;height:22px;background:rgba(255,215,0,.85);border-radius:3px;display:flex;align-items:center;justify-content:center"><svg width="22" height="16" viewBox="0 0 22 16"><line x1="0" y1="5" x2="22" y2="5" stroke="#B8860B" stroke-width=".8"/><line x1="0" y1="11" x2="22" y2="11" stroke="#B8860B" stroke-width=".8"/><line x1="8" y1="0" x2="8" y2="16" stroke="#B8860B" stroke-width=".8"/><line x1="14" y1="0" x2="14" y2="16" stroke="#B8860B" stroke-width=".8"/></svg></div>'+
            '<div>'+_bandSvg(c.bandeira)+'</div>'+
          '</div>'+
          '<div style="position:relative;z-index:1">'+
            '<div style="font-size:.72rem;color:rgba(255,255,255,.8);letter-spacing:.1em;margin-bottom:2px">'+_esc(ult4D)+'</div>'+
            '<div style="display:flex;justify-content:space-between">'+
              '<span style="font-size:.78rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:.08em">'+_esc(c.nome)+'</span>'+
              '<span style="font-size:.7rem;color:rgba(255,255,255,.7)">'+_esc(c.emissor||'')+'</span>'+
            '</div>'+
          '</div>'+
        '</div>' +

        // Corpo
        '<div style="padding:12px 14px">' +
          // Ações
          '<div style="display:flex;justify-content:flex-end;gap:6px;margin-bottom:10px" onclick="event.stopPropagation()">'+
            '<button onclick="CartApp.openEditCard(\''+_esc(c.id)+'\')" title="Editar" style="width:30px;height:30px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#8892a0;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center">&#9998;</button>'+
            '<button onclick="CartApp.openPagarFaturaAtual(\''+_esc(c.id)+'\')" title="Pagar fatura atual" style="width:30px;height:30px;border:1px solid rgba(52,211,153,.35);background:rgba(14,164,122,.14);color:#34d399;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center">P</button>'+
            '<button onclick="CartApp.toggleArchive(\''+_esc(c.id)+'\','+(!isAtivo)+')" title="'+(isAtivo?'Arquivar':'Reativar')+'" style="width:30px;height:30px;border:1px solid rgba(255,255,255,.15);background:transparent;color:'+(isAtivo?'#fbbf24':'#34d399')+';border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center">'+(isAtivo?'&#9889;':'&#10003;')+'</button>'+
            '<button onclick="CartApp.deleteCard(\''+_esc(c.id)+'\')" title="Excluir cartão e dados relacionados" style="width:30px;height:30px;border:1px solid rgba(248,113,113,.45);background:rgba(248,113,113,.12);color:#f87171;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center">&#128465;</button>'+
          '</div>'+

          // Barra de uso
          '<div style="margin-bottom:10px">'+
            '<div style="display:flex;justify-content:space-between;font-size:.8rem;margin-bottom:5px">'+
              '<span style="color:#8892a0">Usado: '+_brl(c.limite_usado)+'</span>'+
              '<span style="font-weight:700;color:'+barColor+'">'+c.pct_uso+'%</span>'+
            '</div>'+
            '<div style="height:7px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden">'+
              '<div style="height:100%;width:'+c.pct_uso+'%;background:'+barColor+';border-radius:99px;transition:width .6s ease"></div>'+
            '</div>'+
            '<div style="display:flex;justify-content:space-between;font-size:.73rem;color:#8892a0;margin-top:4px">'+
              '<span>Disp: '+_brl(c.limite_disponivel)+'</span>'+
              '<span>Total: '+_brl(c.limite_total)+'</span>'+
            '</div>'+
          '</div>'+

          // Fatura do mês filtrado (parcial-aware)
          (function(){
            var fmf = (_store.faturaMesMapFull && _store.faturaMesMapFull[String(c.id)]) || null;
            var fmVal = _store.faturaMesMap[String(c.id)] || 0;
            var fmStatus = fmf ? String(fmf.status || 'Aberta').toLowerCase() : '';
            var fmIsParcial = (fmStatus === 'parcial');
            var fmIsPago = (fmStatus === 'paga' || fmStatus === 'pago');
            var fmBg = fmIsParcial ? 'rgba(251,191,36,.1)' : fmIsPago ? 'rgba(52,211,153,.1)' : 'rgba(14,164,122,.08)';
            var fmBorder = fmIsParcial ? 'rgba(251,191,36,.3)' : fmIsPago ? 'rgba(52,211,153,.3)' : 'rgba(52,211,153,.22)';
            var fmColor = fmIsParcial ? '#fbbf24' : fmIsPago ? '#34d399' : '#34d399';
            var fmExtra = '';
            if (fmIsParcial && fmf) {
              var pct = fmf.valor_total > 0 ? Math.round((fmf.valor_pago / fmf.valor_total) * 100) : 0;
              fmExtra =
                '<div style="margin-top:5px;font-size:.7rem;color:#8892a0;display:flex;justify-content:space-between">'+
                  '<span>Pago: <b style="color:#34d399">'+_brl(fmf.valor_pago)+'</b></span>'+
                  '<span>Total: '+_brl(fmf.valor_total)+'</span>'+
                '</div>'+
                '<div style="margin-top:4px;height:5px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden">'+
                  '<div style="height:100%;width:'+pct+'%;background:#fbbf24;border-radius:99px;transition:width .4s ease"></div>'+
                '</div>';
            } else if (fmIsPago && fmf) {
              fmExtra =
                '<div style="margin-top:4px;font-size:.68rem;color:#34d399;font-weight:600;text-align:right">✓ Paga</div>';
            }
            return '<div style="margin-bottom:10px;background:'+fmBg+';border:1px solid '+fmBorder+';border-radius:9px;padding:7px 8px">'+
              '<div style="display:flex;justify-content:space-between;align-items:center;gap:8px">'+
                '<span style="font-size:.68rem;color:'+fmColor+';font-weight:700;text-transform:uppercase;letter-spacing:.04em">Fatura '+_esc(_mesAno(APP.month, APP.year))+'</span>'+
                '<span style="font-size:.82rem;color:#e8eaf0;font-weight:800">'+_brl(fmVal)+'</span>'+
              '</div>'+
              fmExtra+
            '</div>';
          })()+

          // Datas
          '<div style="display:flex;gap:5px">'+
            ['<div style="flex:1;background:rgba(255,255,255,.06);border-radius:8px;padding:5px 7px"><div style="font-size:.63rem;color:#8892a0;text-transform:uppercase;letter-spacing:.04em;font-weight:600">Vencimento</div><div style="font-size:.79rem;font-weight:700;color:'+(c.alerta_vencimento?'#f87171':'#e8eaf0')+'">'+_esc(c.prox_vencimento)+'</div></div>',
             '<div style="flex:1;background:rgba(255,255,255,.06);border-radius:8px;padding:5px 7px"><div style="font-size:.63rem;color:#8892a0;text-transform:uppercase;letter-spacing:.04em;font-weight:600">Fechamento</div><div style="font-size:.79rem;font-weight:700;color:#e8eaf0">'+_esc(c.prox_fechamento)+'</div></div>',
             '<div style="flex:1;background:rgba(14,164,122,.1);border-radius:8px;padding:5px 7px"><div style="font-size:.63rem;color:#34d399;text-transform:uppercase;letter-spacing:.04em;font-weight:600">Melhor dia</div><div style="font-size:.79rem;font-weight:700;color:#34d399">Dia '+c.melhor_dia_compra+'</div></div>'
            ].join('')+
          '</div>'+

          // Alertas
          (alerts?'<div style="display:flex;flex-direction:column;gap:4px;margin-top:8px">'+alerts+'</div>':'')+
        '</div>'+

        // Overlay sync
        '<div id="cart-sync-'+_esc(c.id)+'" style="display:none;position:absolute;inset:0;background:rgba(0,0,0,.5);border-radius:18px;align-items:center;justify-content:center"><div style="width:26px;height:26px;border:3px solid rgba(91,95,239,.3);border-top-color:#5B5FEF;border-radius:50%;animation:cartSpin .7s linear infinite"></div></div>'+
        '<style>@keyframes cartSpin{to{transform:rotate(360deg)}}</style>'+
        '</div>';
    }

    // ---- Detalhe view ----
    function _renderDetalhe(cartao, faturas, kpis) {
      var cor  = cartao.cor||'#5B5FEF';
      var corD = _dark(cor,35);
      var isAtivo = cartao.ativo;
      var pctCls = _pctCls(cartao.pct_uso);
      var barColor = pctCls==='ok'?'#34d399':pctCls==='warn'?'#fbbf24':'#f87171';
      var ult4Full = cartao.ult4?('⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢ '+cartao.ult4):'⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢ ⬢⬢⬢⬢';
      var refVigMes = (_store.faturaVigente && parseInt(_store.faturaVigente.mes_ref, 10)) || APP.month;
      var refVigAno = (_store.faturaVigente && parseInt(_store.faturaVigente.ano_ref, 10)) || APP.year;
      var valorVigenteAtual = _valorFaturaVigente(cartao.id, refVigAno, refVigMes);

      // Alertas
      var alerH='';
      if (cartao.alerta_uso) alerH+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(251,191,36,.1);border:1px solid rgba(251,191,36,.25);border-radius:10px;color:#fbbf24;font-size:.85rem;font-weight:600;margin-bottom:8px">Uso acima de 80% - considere pagar parte da fatura</div>';
      if (cartao.alerta_vencimento) alerH+='<div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:10px;color:#f87171;font-size:.85rem;font-weight:600;margin-bottom:8px">Vencimento em <strong>'+cartao.dias_para_vencimento+' dia(s)</strong> - '+_esc(cartao.prox_vencimento)+'</div>';

      var fatH='';
      if (!faturas||!faturas.length) {
        fatH='<div style="text-align:center;padding:24px;color:#8892a0;font-size:.87rem">Nenhuma fatura disponível para este cartão.</div>';
      } else {
        fatH=faturas.map(function(f){
          var sL=String(f.status||'aberta').toLowerCase();
          var isPaid = (sL === 'paga' || sL === 'pago' || sL === 'paid');
          var isParcial = (sL === 'parcial');
          var sC = isPaid ? '#34d399' : isParcial ? '#fbbf24' : sL==='fechada' ? '#fbbf24' : '#60a5fa';
          var valorMes = parseFloat(f.valor_mes || 0);
          var valorTotal = parseFloat(f.valor_total || 0);
          var valorPago = parseFloat(f.valor_pago || 0);
          var valorAcumulado = parseFloat(f.valor_acumulado || f.valor || 0);
          var valorPendente = isPaid ? 0 : (valorMes > 0 ? valorMes : Math.max(0, valorTotal - valorPago));

          // Valor principal: pendente se em aberto/parcial, total se pago
          var valorExibicao = isPaid
            ? (valorTotal > 0 ? valorTotal : (valorPago > 0 ? valorPago : parseFloat(f.valor || 0)))
            : (valorPendente > 0 ? valorPendente : valorAcumulado);

          // Info de pagamento parcial com barra de progresso
          var parcialInfo = '';
          if ((isParcial || (!isPaid && valorPago > 0)) && valorTotal > 0) {
            var pctPago = Math.min(100, Math.round((valorPago / valorTotal) * 100));
            parcialInfo = '<div style="margin-top:4px">'
              +'<div style="font-size:.7rem;color:#fbbf24;font-weight:600;margin-bottom:2px">Pago: '+_brl(valorPago)+' de '+_brl(valorTotal)+' ('+pctPago+'%)</div>'
              +'<div style="height:5px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;width:100%">'
              +'<div style="height:100%;width:'+pctPago+'%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px;transition:width .4s"></div>'
              +'</div>'
              +'<div style="font-size:.68rem;color:#f87171;margin-top:2px;font-weight:600">Pendente: '+_brl(valorPendente)+'</div>'
              +'</div>';
          } else if (isPaid && valorPago > 0) {
            parcialInfo = '<div style="font-size:.7rem;color:#34d399;margin-top:2px">Pago: '+_brl(valorPago)+'</div>';
          } else if (!isPaid && valorTotal > 0 && valorPago <= 0) {
            parcialInfo = '<div style="font-size:.72rem;color:#8892a0;margin-top:2px">Total: '+_brl(valorTotal)+'</div>';
          }

          var statusLabel = isParcial ? 'Parcial' : _esc(f.status);
          var actionPay = isPaid
            ? '<span style="font-size:.72rem;color:#34d399;margin-top:4px">\u2713 ' + _esc(f.dt_pagamento) + '</span>'
            : '<button onclick="CartApp.openPagarFatura(\'' + _esc(f.id_fatura) + '\')" style="margin-top:6px;padding:6px 10px;background:linear-gradient(135deg,#0EA47A,#0d7a5b);border:none;color:white;border-radius:8px;font:inherit;font-size:.75rem;font-weight:700;cursor:pointer">'+(isParcial ? 'Pagar restante' : 'Pagar')+'</button>';
          var actionDelete = '<button onclick="CartApp.deleteFaturaById(\'' + _esc(f.id_fatura) + '\')" style="margin-top:6px;padding:6px 10px;background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.45);color:#fca5a5;border-radius:8px;font:inherit;font-size:.75rem;font-weight:700;cursor:pointer">Excluir</button>';
          return '<div style="display:flex;justify-content:space-between;align-items:flex-start;padding:10px 12px;border:1px solid rgba(255,255,255,.08);border-radius:10px;margin-bottom:7px;transition:background .15s'+(isParcial?';border-left:3px solid #fbbf24':'')+'" onmouseenter="this.style.background=\'rgba(255,255,255,.04)\'" onmouseleave="this.style.background=\'\'">'
            +'<div style="flex:1;min-width:0"><div style="font-weight:700;font-size:.88rem;color:#e8eaf0">'+_esc(_mesAno(f.mes_ref,f.ano_ref))+'</div>'
            +'<div style="font-size:.73rem;color:#8892a0;margin-top:1px">'+_esc(f.dt_inicio)+' \u2192 '+_esc(f.dt_fim)+'</div>'
            +'<div style="font-size:.73rem;color:#8892a0">Vence: '+_esc(f.dt_vencimento)+'</div></div>'
            +'<div style="text-align:right;min-width:130px"><div style="font-weight:800;font-size:.95rem;color:'+(isParcial?'#fbbf24':'#e8eaf0')+'">'+_brl(valorExibicao)+'</div>'
            +parcialInfo
            +'<div style="font-size:.7rem;font-weight:700;padding:2px 7px;border-radius:99px;background:'+sC+'22;color:'+sC+';text-transform:uppercase;letter-spacing:.04em;display:inline-block;margin-top:2px">'+statusLabel+'</div>'
            +'<div style="display:flex;gap:6px;justify-content:flex-end;align-items:center;flex-wrap:wrap">' + actionPay + actionDelete + '</div>'
            +'</div></div>';
        }).join('');
      }

      var html =
        // Botão voltar
        '<button onclick="CartApp.goBack()" style="display:flex;align-items:center;gap:7px;border:none;background:transparent;color:#8892a0;font:inherit;font-size:.87rem;font-weight:600;cursor:pointer;margin-bottom:16px;padding:0">'+
          '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg> Voltar'+
        '</button>'+

        // Hero card
        '<div style="background:linear-gradient(135deg,'+cor+','+corD+');border-radius:20px;padding:22px;margin-bottom:18px;position:relative;overflow:hidden">'+
          '<div style="position:absolute;top:-50px;right:-50px;width:220px;height:220px;background:rgba(255,255,255,.06);border-radius:50%"></div>'+
          '<div style="position:relative;z-index:1">'+
            '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">'+
              '<div style="width:32px;height:24px;background:rgba(255,215,0,.85);border-radius:3px"></div>'+
              _bandSvg(cartao.bandeira)+
            '</div>'+
            '<div style="font-size:1.05rem;font-weight:700;color:rgba(255,255,255,.9);letter-spacing:.12em;font-family:monospace;margin-bottom:10px">'+_esc(ult4Full)+'</div>'+
            '<div style="display:flex;justify-content:space-between"><span style="font-size:.88rem;font-weight:800;color:#fff;text-transform:uppercase;letter-spacing:.08em">'+_esc(cartao.nome)+'</span><span style="font-size:.75rem;color:rgba(255,255,255,.7)">'+_esc(cartao.emissor||'')+'</span></div>'+
          '</div>'+
        '</div>'+

        // KPIs
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">'+
          [
            {l:'Limite Total',v:_brl(cartao.limite_total),c:'#e8eaf0',bg:'rgba(255,255,255,.05)'},
            {l:'Utilizado',v:_brl(cartao.limite_usado),c:'#f87171',bg:'rgba(248,113,113,.06)'},
            {l:'Disponível',v:_brl(cartao.limite_disponivel),c:'#34d399',bg:'rgba(52,211,153,.06)'}
          ].map(function(k){
            return '<div style="background:'+k.bg+';border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:12px 14px">'+
              '<div style="font-size:.68rem;color:#8892a0;font-weight:600;text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px">'+k.l+'</div>'+
              '<div style="font-size:.95rem;font-weight:800;color:'+k.c+'">'+k.v+'</div>'+
              '</div>';
          }).join('')+
        '</div>'+

        // Barra progresso
        '<div style="margin-bottom:16px">'+
          '<div style="height:9px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;margin-bottom:5px">'+
            '<div style="height:100%;width:'+cartao.pct_uso+'%;background:'+barColor+';border-radius:99px;transition:width .6s"></div>'+
          '</div>'+
          '<div style="text-align:right;font-size:.77rem;color:#8892a0">'+cartao.pct_uso+'% utilizado</div>'+
        '</div>'+

        // Alertas
        alerH+
        (function(){
          var vigTotal = _store.faturaVigente ? (parseFloat(_store.faturaVigente.valor_total || 0) || 0) : 0;
          var vigPago = _store.faturaVigente ? (parseFloat(_store.faturaVigente.valor_pago || 0) || 0) : 0;
          var vigIsParcial = _store.faturaVigente && String(_store.faturaVigente.status || '').toLowerCase() === 'parcial';
          var vigPendente = valorVigenteAtual;
          var vigBorderColor = vigIsParcial ? 'rgba(251,191,36,.35)' : 'rgba(52,211,153,.35)';
          var vigBgColor = vigIsParcial ? 'rgba(251,191,36,.08)' : 'rgba(14,164,122,.08)';
          var vigParcialHtml = '';
          if ((vigIsParcial || vigPago > 0) && vigTotal > 0) {
            var pctV = Math.min(100, Math.round((vigPago / vigTotal) * 100));
            vigParcialHtml = '<div style="margin-top:6px">'
              +'<div style="font-size:.72rem;color:#fbbf24;font-weight:600">Pago: '+_brl(vigPago)+' de '+_brl(vigTotal)+' ('+pctV+'%)</div>'
              +'<div style="height:5px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;margin-top:3px">'
              +'<div style="height:100%;width:'+pctV+'%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px"></div>'
              +'</div>'
              +'<div style="font-size:.7rem;color:#f87171;font-weight:600;margin-top:2px">Pendente: '+_brl(vigPendente)+'</div>'
              +'</div>';
          }
          return '<div style="display:flex;justify-content:space-between;align-items:center;gap:10px;background:'+vigBgColor+';border:1px solid '+vigBorderColor+';border-radius:12px;padding:12px 14px;margin-bottom:14px'+(vigIsParcial?';border-left:3px solid #fbbf24':'')+'">'+
            '<div>'+
              '<div style="font-size:.72rem;color:'+(vigIsParcial?'#fbbf24':'#34d399')+';font-weight:700;text-transform:uppercase;letter-spacing:.05em">Fatura atual'+(vigIsParcial?' (parcial)':'')+' </div>'+
              '<div style="font-size:.9rem;font-weight:800;color:'+(vigIsParcial?'#fbbf24':'#e8eaf0')+'">'+_brl(vigPendente)+'</div>'+
              '<div style="font-size:.72rem;color:#8892a0">Fechamento: '+_esc(cartao.prox_fechamento || '')+'</div>'+
              vigParcialHtml+
            '</div>'+
            '<button onclick="CartApp.openPagarFaturaAtual(\'' + _esc(cartao.id) + '\')" style="padding:8px 14px;background:linear-gradient(135deg,#0EA47A,#0d7a5b);border:none;color:white;border-radius:9px;font:inherit;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap">'+(vigIsParcial?'Pagar pendente':'Pagar fatura')+'</button>'+
          '</div>';
        })()+

        // Datas
        '<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:16px">'+
          '<div style="font-size:.9rem;font-weight:700;color:#e8eaf0;margin-bottom:12px">Datas importantes</div>'+
          [
            {icon:'x',l:'Próx. Fechamento',v:cartao.prox_fechamento,c:'#e8eaf0',sub:''},
            {icon:'⏰',l:'Próx. Vencimento',v:cartao.prox_vencimento,c:cartao.alerta_vencimento?'#f87171':'#e8eaf0',sub:'em '+cartao.dias_para_vencimento+' dia(s)'},
            {icon:'x:',l:'Melhor dia de compra',v:'Todo dia '+cartao.melhor_dia_compra,c:'#34d399',sub:'Logo após o fechamento'}
          ].map(function(d){
            return '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;background:rgba(255,255,255,.03);border-radius:9px;margin-bottom:6px">'+
              '<span style="font-size:1.2rem">'+d.icon+'</span>'+
              '<div><div style="font-size:.72rem;color:#8892a0;font-weight:600;text-transform:uppercase;letter-spacing:.04em">'+d.l+'</div>'+
              '<div style="font-size:.9rem;font-weight:700;color:'+d.c+'">'+_esc(d.v)+'</div>'+
              (d.sub?'<div style="font-size:.7rem;color:#8892a0">'+d.sub+'</div>':'')+
              '</div></div>';
          }).join('')+
        '</div>'+

        // Faturas
        '<div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:16px;margin-bottom:16px">'+
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">'+
            '<span style="font-size:.9rem;font-weight:700;color:#e8eaf0">Faturas</span>'+
            '<button onclick="CartApp.deletePaidFaturasHistory(\''+_esc(cartao.id)+'\')" style="display:flex;align-items:center;gap:5px;padding:6px 12px;background:rgba(248,113,113,.14);border:1px solid rgba(248,113,113,.45);color:#fca5a5;border-radius:8px;font:inherit;font-size:.8rem;font-weight:700;cursor:pointer">Limpar pagas</button>'+
          '</div>'+
          fatH+
        '</div>'+

        // Ações finais
        '<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:24px">'+
          '<button onclick="CartApp.openEditCard(\''+_esc(cartao.id)+'\')" style="flex:1;padding:10px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#e8eaf0;border-radius:10px;font:inherit;font-size:.87rem;font-weight:600;cursor:pointer;min-width:120px">Editar</button>'+
          '<button onclick="CartApp.toggleArchive(\''+_esc(cartao.id)+'\','+(!isAtivo)+')" style="flex:1;padding:10px;border:1px solid rgba('+(isAtivo?'248,113,113':'52,211,153')+',.4);background:transparent;color:'+(isAtivo?'#f87171':'#34d399')+';border-radius:10px;font:inherit;font-size:.87rem;font-weight:600;cursor:pointer;min-width:120px">'+(isAtivo?'Arquivar':'Reativar')+'</button>'+
          '<button onclick="CartApp.deleteCard(\''+_esc(cartao.id)+'\')" style="flex:1;padding:10px;border:1px solid rgba(248,113,113,.4);background:rgba(248,113,113,.08);color:#f87171;border-radius:10px;font:inherit;font-size:.87rem;font-weight:600;cursor:pointer;min-width:120px">Excluir</button>'+
        '</div>';

      var root = document.getElementById('cartoes-root');
      if (root) root.innerHTML = html;
    }

    // ---- Modal form cartão ----
    function _modalCartao(c) {
      c = c||{};
      var cors = ['#5B5FEF','#820AD1','#FF7A00','#0EA47A','#E53E3E','#1A73E8','#2D3748'];
      var corAtual = c.cor||'#5B5FEF';
      var swatches = cors.map(function(cor){
        return '<button type="button" onclick="document.getElementById(\'fcCorInp\').value=\''+cor+'\';document.querySelectorAll(\'.cart-swatch\').forEach(function(s){s.style.outline=\'none\'});this.style.outline=\'2px solid white\'" '
          +'style="width:28px;height:28px;border-radius:50%;background:'+cor+';border:none;cursor:pointer;outline:'+(corAtual===cor?'2px solid white':'none')+'"></button>';
      }).join('');

      var html='<div style="padding:4px 0">'
        +'<input type="hidden" id="fcIdInp" value="'+_esc(c.id||'')+'">'
        +'<input type="hidden" id="fcVerInp" value="'+(c.version||1)+'">'
        +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">'
        +_fi('Nome *','text','fcNomeInp',c.nome||'','Ex: Nubank',true)
        +_fi('Emissor *','text','fcEmissorInp',c.emissor||'','Ex: Banco Inter',true)
        +_fiSel('Bandeira *','fcBandInp',c.bandeira||'',[['','Selecione...'],['Visa','Visa'],['Master','Mastercard'],['Amex','Amex'],['Elo','Elo'],['Outro','Outro']],true)
        +_fi('Últimos 4 dígitos','text','fcUlt4Inp',c.ult4||'','1234',false,'maxlength="4"')
        +_fi('Limite total (R$) *','number','fcLimTInp',c.limite_total||'','5000',true,'min="0" step="0.01"')
        +_fi('Limite usado (R$)','number','fcLimUInp',c.limite_usado||'','0',false,'min="0" step="0.01"')
        +_fi('Dia fechamento *','number','fcDiaFInp',c.dia_fechamento||'','10',true,'min="1" max="31"')
        +_fi('Dia vencimento *','number','fcDiaVInp',c.dia_vencimento||'','17',true,'min="1" max="31"')
        +'<div style="grid-column:1/-1"><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:6px">Cor do cartão</label>'
        +'<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">'
        +swatches
        +'<label style="cursor:pointer"><input type="color" id="fcCorCustom" value="'+corAtual+'" onchange="document.getElementById(\'fcCorInp\').value=this.value" style="width:28px;height:28px;border:none;border-radius:50%;cursor:pointer;background:none;padding:0"><span style="font-size:.75rem;color:#8892a0;margin-left:4px">Outra</span></label>'
        +'</div><input type="hidden" id="fcCorInp" value="'+corAtual+'"></div>'
        +'<div style="grid-column:1/-1;padding:8px 12px;background:rgba(14,164,122,.1);border:1px solid rgba(14,164,122,.2);border-radius:8px;font-size:.83rem;color:#34d399">Melhor dia de compra: <strong id="cartMelhorDia">dia '+(c.dia_fechamento>= 28?1:(c.dia_fechamento?c.dia_fechamento+1:''))+'</strong></div>'
        +'</div>'
        +'<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08)">'
        +'<button type="button" onclick="CartApp.closeModal()" style="padding:9px 18px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#8892a0;border-radius:9px;font:inherit;font-size:.87rem;cursor:pointer">Cancelar</button>'
        +'<button type="button" onclick="CartApp.submitCartao()" id="cartSaveBtn" style="padding:9px 20px;background:linear-gradient(135deg,#5B5FEF,#4449D0);color:white;border:none;border-radius:9px;font:inherit;font-size:.87rem;font-weight:700;cursor:pointer">'+(c.id?'Salvar':'Adicionar')+'</button>'
        +'</div></div>';

      var mt = document.getElementById('modal-title');
      if (mt) mt.textContent = c.id ? 'Editar cartão' : 'Novo cartão';
      _openModal(html);

      // Preview melhor dia dinâmico
      setTimeout(function(){
        var dF = document.getElementById('fcDiaFInp');
        if (dF) dF.addEventListener('input', function(){
          var v=parseInt(this.value)||0;
          var md=document.getElementById('cartMelhorDia');
          if (md&&v>=1&&v<=31) md.textContent='dia '+(v>=28?1:v+1);
        });
      }, 100);
    }

    // Helpers para campos do form
    function _fi(label, type, id, val, ph, req, extra) {
      extra=extra||'';
      return '<div><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">'+label+'</label>'
        +'<input type="'+type+'" id="'+id+'" value="'+_esc(val)+'" placeholder="'+_esc(ph)+'" '+(req?'required':'')+' '+extra
        +' style="width:100%;padding:9px 11px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box">'
        +'</div>';
    }
    function _fiSel(label, id, val, opts, req) {
      return '<div><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">'+label+'</label>'
        +'<select id="'+id+'" '+(req?'required':'')+' style="width:100%;padding:9px 11px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box">'
        +opts.map(function(o){ return '<option value="'+_esc(o[0])+'"'+(val===o[0]?' selected':'')+'>'+_esc(o[1])+'</option>'; }).join('')
        +'</select></div>';
    }

    // ---- Pública: CartApp ----
    window.CartApp = {

      // Renderiza imediatamente com dados pré-carregados no boot do app (zero latência)
      bootFromCache: function(bootData) {
        _store.cartoes = bootData.cartoes || [];
        _store.etag    = bootData.etag || null;
        _loadFaturaMesMap_(function() { _renderList(); });
        _pollStart();
        // Atualiza em background silenciosamente
        _rpc('syncCartoes', [_store.etag]).then(function(res) {
          if (!res.ok || !res.data || res.data.unchanged) return;
          if (res.data.cartoes) {
            _store.cartoes = res.data.cartoes;
            _store.etag    = res.data.etag;
            APP.cartoesBootData = res.data;
            _loadFaturaMesMap_(function() { _renderList(); });
          }
        });
      },

      boot: function() {
        _rpc('bootstrap', null).then(function(res){
          if (!res.ok) { _toast('Erro ao carregar cartões: '+(res.error&&res.error.message),'error'); return; }
          _store.cartoes = res.data.cartoes||[];
          _store.etag    = res.data.etag;
          APP.cartoesBootData = res.data; // armazena para próximo boot
          _loadFaturaMesMap_(function() { _renderList(); });
          _pollStart();
        });
      },

      refresh: function() {
        _rpc('syncCartoes', [_store.etag]).then(function(res){
          if (!res.ok) { _pollFailCount++; return; }
          if (res.data && res.data.unchanged) { _pollFailCount = 0; return; }
          if (res.data && res.data.cartoes) {
            _store.cartoes = res.data.cartoes;
            _store.etag    = res.data.etag;
            APP.cartoesBootData = res.data; // mantém cache fresco
            _pollFailCount = 0;
            _loadFaturaMesMap_(function() { _renderList(); });
          }
        });
      },

      showView: function() {
        // Re-renderiza a view de lista (ao voltar para a rota)
        if (_store.cartaoDetalhe) {
          _renderDetalhe(_store.cartaoDetalhe, _store.faturas, null);
        } else {
          _loadFaturaMesMap_(function() { _renderList(); });
        }
      },

      goBack: function() {
        _store.cartaoDetalhe = null;
        _store.faturas = [];
        _store.faturaVigente = null;
        // Rebuild shell e re-renderiza a lista com dados já em memória
        _cartoesModuleReady = false;
        _cartoesInjectModule(APP.routeToken || 0);
        // _cartoesInjectModule seta _cartoesModuleReady=true e chama _cartoesBootAgent
        // que vai chamar CartApp.refresh() (dados já em _store, só atualiza ETag se mudou)
      },

      openDetalhe: function(id) {
        var cartao = _store.cartoes.find(function(c){return c.id===id;});
        if (!cartao) return;
        _store.cartaoDetalhe = cartao;
        var cached = _store.detalheCache[String(id)] || null;
        if (cached) {
          _store.faturas = cached.faturas || [];
          _store.faturaVigente = cached.fatura_vigente || null;
          _renderDetalhe(cartao, _store.faturas, cached.kpis || null);
        } else {
          _store.faturas = [];
          _store.faturaVigente = null;
          _renderDetalhe(cartao, [], null);
        }
        _rpc('getCartaoDetalhe',[id]).then(function(res){
          if (!res.ok) { _toast('Erro ao carregar detalhe','error'); return; }
          _store.cartaoDetalhe = res.data.cartao;
          _store.faturas       = res.data.faturas||[];
          _store.faturaVigente = res.data.fatura_vigente || null;
          _store.detalheCache[String(id)] = {
            cartao: res.data.cartao || null,
            faturas: res.data.faturas || [],
            fatura_vigente: res.data.fatura_vigente || null,
            kpis: res.data.kpis || null
          };
          _renderDetalhe(res.data.cartao, res.data.faturas, res.data.kpis);
        });
      },

      openAddCard:  function()  { _modalCartao(null); },
      openEditCard: function(id){ var c=_store.cartoes.find(function(c){return c.id===id;})||_store.cartaoDetalhe; _modalCartao(c); },
      closeModal:   function()  { _closeModal(); },

      submitCartao: function() {
        var id  = (document.getElementById('fcIdInp')||{}).value||'';
        var ver = parseInt((document.getElementById('fcVerInp')||{}).value)||1;
        var nome    = ((document.getElementById('fcNomeInp')||{}).value||'').trim();
        var emissor = ((document.getElementById('fcEmissorInp')||{}).value||'').trim();
        var banda   = (document.getElementById('fcBandInp')||{}).value||'';
        var ult4    = ((document.getElementById('fcUlt4Inp')||{}).value||'').replace(/\D/g,'').slice(-4);
        var limT    = parseFloat((document.getElementById('fcLimTInp')||{}).value)||0;
        var limU    = parseFloat((document.getElementById('fcLimUInp')||{}).value)||0;
        var diaF    = parseInt((document.getElementById('fcDiaFInp')||{}).value)||0;
        var diaV    = parseInt((document.getElementById('fcDiaVInp')||{}).value)||0;
        var cor     = (document.getElementById('fcCorInp')||{}).value||'#5B5FEF';

        if (!nome)          { _toast('Nome obrigatório','error'); return; }
        if (!emissor)       { _toast('Emissor obrigatório','error'); return; }
        if (!banda)         { _toast('Selecione a bandeira','error'); return; }
        if (limT<=0)        { _toast('Limite total deve ser > 0','error'); return; }
        if (diaF<1||diaF>31){ _toast('Dia de fechamento inválido','error'); return; }
        if (diaV<1||diaV>31){ _toast('Dia de vencimento inválido','error'); return; }

        var payload = {id:id,version:ver,nome:nome,emissor:emissor,bandeira:banda,
                       ult4:ult4,cor:cor,limite_total:limT,limite_usado:limU,
                       dia_fechamento:diaF,dia_vencimento:diaV};

        // Optimistic
        var optimistic = Object.assign({},payload,{
          id:id||('tmp_'+Date.now()),ativo:true,pct_uso:limT>0?Math.round((limU/limT)*100):0,
          limite_disponivel:Math.max(0,limT-limU),prox_fechamento:'⬦',prox_vencimento:'⬦',
          melhor_dia_compra:diaF>=28?1:diaF+1,alerta_uso:false,alerta_vencimento:false,dias_para_vencimento:99
        });
        var idx=_store.cartoes.findIndex(function(c){return c.id===id;});
        if(idx>=0) _store.cartoes[idx]=optimistic; else _store.cartoes.unshift(optimistic);
        _renderList();
        _closeModal();
        _toast(id?'Atualizando...':'Adicionando...','info');

        var btn=document.getElementById('cartSaveBtn');
        if(btn){btn.disabled=true;btn.textContent='Salvando...';}

        _rpc('saveCartao',[JSON.stringify(payload)]).then(function(res){
          if(!res.ok){
            if(res.error&&res.error.code==='CONFLICT'){
              if(res.error.details&&res.error.details.serverData){var sd=res.error.details.serverData;var ix=_store.cartoes.findIndex(function(c){return c.id===sd.id;});if(ix>=0)_store.cartoes[ix]=sd;else _store.cartoes.unshift(sd);}
              _renderList();
              _toast('Conflito: dados do servidor carregados.','warn');
            } else {
              if(!id){_store.cartoes=_store.cartoes.filter(function(c){return c.id!==optimistic.id;});}
              _renderList();
              _toast('Erro: '+(res.error&&res.error.message),'error');
            }
            return;
          }
          var ix=_store.cartoes.findIndex(function(c){return c.id===optimistic.id||c.id===res.data.id;});
          if(ix>=0) _store.cartoes[ix]=res.data; else _store.cartoes.unshift(res.data);
          _renderList();
          _toast(id?'Cartão atualizado!':'Cartão adicionado!','success');
        });
      },

      toggleArchive: function(id, novoAtivo) {
        novoAtivo = novoAtivo===true||novoAtivo==='true';
        var cartao=_store.cartoes.find(function(c){return c.id===id;})||_store.cartaoDetalhe;
        if(!cartao) return;
        var prev=Object.assign({},cartao);
        var ix=_store.cartoes.findIndex(function(c){return c.id===id;});
        var novo=Object.assign({},cartao,{ativo:novoAtivo});
        if(ix>=0) _store.cartoes[ix]=novo;

        if (_store.cartaoDetalhe&&_store.cartaoDetalhe.id===id) {
          _store.cartaoDetalhe=null; _store.faturas=[];
          _cartoesModuleReady=false; _cartoesBootAgent(0);
        } else { _renderList(); }

        _rpc('archiveCartao',[id,novoAtivo]).then(function(res){
          if(!res.ok){
            var ix2=_store.cartoes.findIndex(function(c){return c.id===id;});
            if(ix2>=0)_store.cartoes[ix2]=prev;
            _renderList();
            _toast('Erro: '+(res.error&&res.error.message),'error'); return;
          }
          var ix3=_store.cartoes.findIndex(function(c){return c.id===id;});
          if(ix3>=0)_store.cartoes[ix3]=res.data;
          _renderList();
          _toast(novoAtivo?'Cartão reativado!':'Cartão arquivado!','success');
        });
      },

      deleteCard: function(id) {
        var cartao = _store.cartoes.find(function(c){return c.id===id;}) || _store.cartaoDetalhe;
        if (!cartao) return;
        var nome = String(cartao.nome || 'este cartão');
        var ok = confirm('Excluir "' + nome + '" e TODOS os dados relacionados (faturas e lançamentos)? Essa ação é irreversível.');
        if (!ok) return;

        var backup = {
          cartoes: (_store.cartoes || []).slice(),
          cartaoDetalhe: _store.cartaoDetalhe ? Object.assign({}, _store.cartaoDetalhe) : null,
          faturas: (_store.faturas || []).slice(),
          faturaVigente: _store.faturaVigente ? Object.assign({}, _store.faturaVigente) : null
        };

        _store.cartoes = (_store.cartoes || []).filter(function(c){ return String(c.id) !== String(id); });
        delete _store.detalheCache[String(id)];
        if (_store.faturaMesMap) delete _store.faturaMesMap[String(id)];
        if (_store.cartaoDetalhe && String(_store.cartaoDetalhe.id) === String(id)) {
          _store.cartaoDetalhe = null;
          _store.faturas = [];
          _store.faturaVigente = null;
          _renderList();
        } else {
          _renderList();
        }

        _rpc('deleteCartaoCascade', [id]).then(function(res) {
          if (!res.ok) {
            _store.cartoes = backup.cartoes;
            _store.cartaoDetalhe = backup.cartaoDetalhe;
            _store.faturas = backup.faturas;
            _store.faturaVigente = backup.faturaVigente;
            _renderList();
            _toast('Erro ao excluir: ' + (res.error && res.error.message), 'error');
            return;
          }
          var rmF = (res.data && res.data.removed_faturas) || 0;
          var rmL = (res.data && res.data.removed_lancamentos) || 0;
          _toast('Cartão excluído. Faturas: ' + rmF + ' | Lançamentos: ' + rmL, 'success');
          if (_store.cartaoDetalhe === null) {
            _cartoesModuleReady = false;
            _cartoesInjectModule(APP.routeToken || 0);
          } else {
            _renderList();
          }
        });
      },

      deletePaidFaturasHistory: function(cartaoId) {
        if (!cartaoId) return;
        var ok = confirm('Excluir histórico de faturas pagas deste cartão? Essa ação não pode ser desfeita.');
        if (!ok) return;
        _rpc('deletePaidFaturasHistory', [cartaoId]).then(function(res) {
          if (!res.ok) {
            _toast('Erro ao limpar: ' + (res.error && res.error.message), 'error');
            return;
          }
          var qtd = (res.data && res.data.removed) || 0;
          _toast('Histórico limpo. Faturas removidas: ' + qtd, 'success');
          if (_store.cartaoDetalhe && String(_store.cartaoDetalhe.id) === String(cartaoId)) {
            _rpc('getCartaoDetalhe',[cartaoId]).then(function(r){
              if (r && r.ok) {
                _store.cartaoDetalhe = r.data.cartao;
                _store.faturas = r.data.faturas || [];
                _store.faturaVigente = r.data.fatura_vigente || null;
                _renderDetalhe(r.data.cartao, r.data.faturas, r.data.kpis);
              }
            });
          } else {
            CartApp.refresh();
          }
        });
      },

      deleteFaturaById: function(faturaId) {
        if (!faturaId) return;
        var ok = confirm('Excluir esta fatura individualmente? Essa ação não pode ser desfeita.');
        if (!ok) return;
        _rpc('deleteFaturaById', [faturaId]).then(function(res) {
          if (!res.ok) {
            _toast('Erro ao excluir fatura: ' + (res.error && res.error.message), 'error');
            return;
          }
          _toast('Fatura excluída com sucesso.', 'success');
          if (_store.cartaoDetalhe && _store.cartaoDetalhe.id) {
            _rpc('getCartaoDetalhe', [_store.cartaoDetalhe.id]).then(function(r) {
              if (r && r.ok) {
                _store.cartaoDetalhe = r.data.cartao;
                _store.faturas = r.data.faturas || [];
                _store.faturaVigente = r.data.fatura_vigente || null;
                _renderDetalhe(r.data.cartao, r.data.faturas, r.data.kpis);
              }
            });
          } else {
            CartApp.refresh();
          }
        });
      },

      openPagarFatura: function(faturaId) {
        var hoje=_hoje();
        var fat=(_store.faturas||[]).find(function(f){return f.id_fatura===faturaId;})||null;
        var valorTotal = fat ? (parseFloat(fat.valor_total || 0) || 0) : 0;
        var valorPago = fat ? (parseFloat(fat.valor_pago || 0) || 0) : 0;
        var valorPendente = fat ? (parseFloat(fat.valor_mes || fat.valor || 0) || 0) : 0;
        if (valorPendente <= 0 && valorTotal > 0) valorPendente = Math.max(0, valorTotal - valorPago);
        var isParcial = fat && String(fat.status||'').toLowerCase() === 'parcial';
        var refLabel = fat ? _mesAno(fat.mes_ref, fat.ano_ref) : '';
        var cardId = fat ? String(fat.id_cartao || '') : '';
        var anoRef = fat ? (parseInt(fat.ano_ref, 10) || APP.year) : APP.year;
        var mesRef = fat ? (parseInt(fat.mes_ref, 10) || APP.month) : APP.month;
        var accountOptions = (typeof renderAccountOptions === 'function') ? renderAccountOptions('') : '';
        if (!accountOptions) accountOptions = '<option value="">Sem contas ativas</option>';

        // Info de pagamento parcial
        var parcialBanner = '';
        if (isParcial || valorPago > 0) {
          var pctPago = valorTotal > 0 ? Math.min(100, Math.round((valorPago / valorTotal) * 100)) : 0;
          parcialBanner = '<div style="margin-bottom:10px;padding:10px 12px;border-radius:10px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.35)">'
            +'<div style="font-size:.72rem;color:#fbbf24;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Pagamento parcial</div>'
            +'<div style="font-size:.85rem;color:#e8eaf0;margin-top:4px">Total da fatura: <strong>'+_brl(valorTotal)+'</strong></div>'
            +'<div style="font-size:.85rem;color:#34d399">Ja pago: <strong>'+_brl(valorPago)+'</strong> ('+pctPago+'%)</div>'
            +'<div style="font-size:.85rem;color:#f87171;font-weight:700">Pendente: <strong>'+_brl(valorPendente)+'</strong></div>'
            +'<div style="height:6px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;margin-top:6px">'
            +'<div style="height:100%;width:'+pctPago+'%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px"></div>'
            +'</div></div>';
        }

        var html='<div style="padding:4px 0">'
          +'<input type="hidden" id="pfId" value="'+_esc(faturaId)+'">'
          +'<input type="hidden" id="pfCardId" value="'+_esc(cardId)+'">'
          +'<input type="hidden" id="pfAnoRef" value="'+_esc(anoRef)+'">'
          +'<input type="hidden" id="pfMesRef" value="'+_esc(mesRef)+'">'
          +(fat
            ? ('<div style="margin-bottom:10px;padding:10px 12px;border-radius:10px;background:rgba(14,164,122,.08);border:1px solid rgba(52,211,153,.35)">'
              +'<div style="font-size:.72rem;color:#34d399;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Fatura selecionada</div>'
              +'<div style="font-size:.92rem;font-weight:800;color:#e8eaf0">'+_esc(refLabel)+' \u2022 '+_brl(valorPendente)+'</div>'
              +'<div style="font-size:.72rem;color:#8892a0">'+(isParcial ? 'Valor pendente deste mes' : 'Valor em aberto')+'</div>'
              +'</div>')
            : '')
          +parcialBanner
          +'<div><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Valor a pagar (aceita parcial)</label>'
          +'<input type="text" id="pfAmount" value="'+_esc(String(valorPendente).replace('.',','))+'" placeholder="0,00" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box"></div>'
          +'<div style="margin-top:10px"><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Data do pagamento</label>'
          +'<input type="date" id="pfDt" value="'+hoje+'" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box"></div>'
          +'<div style="margin-top:10px"><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Conta para pagar a fatura</label>'
          +'<select id="pfAccount" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box">'
          +accountOptions
          +'</select></div>'
          +'<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08)">'
          +'<button onclick="CartApp.closeModal()" style="padding:9px 18px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#8892a0;border-radius:9px;font:inherit;cursor:pointer">Cancelar</button>'
          +'<button onclick="CartApp.submitPagarFatura()" style="padding:9px 20px;background:linear-gradient(135deg,#0EA47A,#0d7a5b);color:white;border:none;border-radius:9px;font:inherit;font-weight:700;cursor:pointer">Confirmar pagamento</button>'
          +'</div></div>';
        var mt=document.getElementById('modal-title'); if(mt) mt.textContent=isParcial ? 'Pagar valor pendente' : 'Pagar fatura';
        _openModal(html);
      },

      openPagarFaturaAtual: function(cartaoId) {
        var hoje=_hoje();
        var cartao = _store.cartoes.find(function(c){return c.id===cartaoId;}) || _store.cartaoDetalhe || null;
        var vig = (_store.faturaVigente && String(_store.faturaVigente.id_cartao || '') === String(cartaoId)) ? _store.faturaVigente : null;
        var refLocal = _refFaturaAtualByCard_(cartao);
        var refAno = vig ? (parseInt(vig.ano_ref, 10) || refLocal.ano) : refLocal.ano;
        var refMes = vig ? (parseInt(vig.mes_ref, 10) || refLocal.mes) : refLocal.mes;
        var valorRef = cartao ? _valorFaturaVigente(cartao.id, refAno, refMes) : 0;
        // Info de pagamento parcial da fatura vigente
        var vigValorTotal = vig ? (parseFloat(vig.valor_total || 0) || 0) : 0;
        var vigValorPago = vig ? (parseFloat(vig.valor_pago || 0) || 0) : 0;
        var vigPendente = Math.max(0, valorRef);
        var vigIsParcial = vig && String(vig.status || '').toLowerCase() === 'parcial';
        var accountOptions = (typeof renderAccountOptions === 'function') ? renderAccountOptions('') : '';
        if (!accountOptions) accountOptions = '<option value="">Sem contas ativas</option>';

        // Banner de pagamento parcial
        var parcialBanner = '';
        if ((vigIsParcial || vigValorPago > 0) && vigValorTotal > 0) {
          var pctPago = Math.min(100, Math.round((vigValorPago / vigValorTotal) * 100));
          parcialBanner = '<div style="margin-bottom:10px;padding:10px 12px;border-radius:10px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.35)">'
            +'<div style="font-size:.72rem;color:#fbbf24;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Pagamento parcial em andamento</div>'
            +'<div style="font-size:.85rem;color:#e8eaf0;margin-top:4px">Total: <strong>'+_brl(vigValorTotal)+'</strong></div>'
            +'<div style="font-size:.85rem;color:#34d399">Ja pago: <strong>'+_brl(vigValorPago)+'</strong> ('+pctPago+'%)</div>'
            +'<div style="font-size:.85rem;color:#f87171;font-weight:700">Pendente: <strong>'+_brl(vigPendente)+'</strong></div>'
            +'<div style="height:6px;background:rgba(255,255,255,.1);border-radius:99px;overflow:hidden;margin-top:6px">'
            +'<div style="height:100%;width:'+pctPago+'%;background:linear-gradient(90deg,#fbbf24,#f59e0b);border-radius:99px"></div>'
            +'</div></div>';
        }

        var html='<div style="padding:4px 0">'
          +'<input type="hidden" id="pfCurrentCardId" value="'+_esc(cartaoId)+'">'
          +'<input type="hidden" id="pfCurrentAnoRef" value="'+_esc(refAno)+'">'
          +'<input type="hidden" id="pfCurrentMesRef" value="'+_esc(refMes)+'">'
          +'<div style="margin-bottom:10px;padding:10px 12px;border-radius:10px;background:rgba(14,164,122,.08);border:1px solid rgba(52,211,153,.35)">'
          +'<div style="font-size:.72rem;color:#34d399;font-weight:700;text-transform:uppercase;letter-spacing:.05em">Fatura atual</div>'
          +'<div style="font-size:.92rem;font-weight:800;color:#e8eaf0">Fatura atual \u2022 '+_brl(vigPendente)+'</div>'
          +'<div style="font-size:.72rem;color:#8892a0">Fechamento: '+_esc((cartao && cartao.prox_fechamento) || '')+'</div>'
          +'<div style="font-size:.72rem;color:#8892a0">Pagamento do valor vigente deste ciclo (aceita parcial)</div>'
          +'</div>'
          +parcialBanner
          +'<div><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Valor a pagar (aceita parcial)</label>'
          +'<input type="text" id="pfCurrentAmount" value="'+_esc(String(vigPendente).replace('.',','))+'" placeholder="0,00" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box"></div>'
          +'<div style="margin-top:10px"><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Data do pagamento</label>'
          +'<input type="date" id="pfCurrentDt" value="'+hoje+'" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box"></div>'
          +'<div style="margin-top:10px"><label style="font-size:.8rem;font-weight:600;color:#e8eaf0;display:block;margin-bottom:5px">Conta para pagar a fatura</label>'
          +'<select id="pfCurrentAccount" style="width:100%;padding:9px;background:#2a2e3d;border:1.5px solid #3a3f50;border-radius:9px;color:#e8eaf0;font:inherit;font-size:.87rem;outline:none;box-sizing:border-box">'
          +accountOptions
          +'</select></div>'
          +'<div style="display:flex;justify-content:flex-end;gap:10px;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,.08)">'
          +'<button onclick="CartApp.closeModal()" style="padding:9px 18px;border:1px solid rgba(255,255,255,.15);background:transparent;color:#8892a0;border-radius:9px;font:inherit;cursor:pointer">Cancelar</button>'
          +'<button onclick="CartApp.submitPagarFaturaAtual()" style="padding:9px 20px;background:linear-gradient(135deg,#0EA47A,#0d7a5b);color:white;border:none;border-radius:9px;font:inherit;font-weight:700;cursor:pointer">Confirmar pagamento</button>'
          +'</div></div>';
        var mt=document.getElementById('modal-title'); if(mt) mt.textContent=vigIsParcial ? 'Pagar valor pendente' : 'Pagar fatura atual';
        _openModal(html);
      },

      submitPagarFaturaAtual: function() {
        var cardId=((document.getElementById('pfCurrentCardId')||{}).value||'');
        var anoRef=parseInt(((document.getElementById('pfCurrentAnoRef')||{}).value)||APP.year);
        var mesRef=parseInt(((document.getElementById('pfCurrentMesRef')||{}).value)||APP.month);
        var amountRaw=((document.getElementById('pfCurrentAmount')||{}).value||'').trim();
        var amountPay = (typeof parseAmountInput_ === 'function') ? parseAmountInput_(amountRaw) : parseFloat(amountRaw);
        var dt=(document.getElementById('pfCurrentDt')||{}).value||_hoje();
        var accountId=((document.getElementById('pfCurrentAccount')||{}).value||'');
        var btn = document.querySelector('#modal-body button[onclick="CartApp.submitPagarFaturaAtual()"]');
        if(!cardId) return;
        if(!accountId){ _toast('Selecione a conta que vai pagar a fatura.','warn'); return; }
        if (!isFinite(amountPay) || amountPay <= 0) { _toast('Informe um valor válido para pagamento.', 'warn'); return; }
        if (btn) { btn.disabled = true; btn.textContent = 'Confirmando...'; }
        showLoading();
        var finished = false;
        function finishLoading_(keepButtonDisabled) {
          if (finished) return;
          finished = true;
          hideLoading();
          if (btn && !keepButtonDisabled) { btn.disabled = false; btn.textContent = 'Confirmar'; }
        }
        var loadingGuard = setTimeout(function() {
          finishLoading_(false);
          _toast('Processamento demorou mais que o esperado. Atualize a tela para conferir o status.', 'warn');
        }, 12000);
        var cardBefore = _store.cartoes.find(function(c){ return String(c.id) === String(cardId); }) || _store.cartaoDetalhe || null;
        var usedBefore = cardBefore ? (parseFloat(cardBefore.limite_usado) || 0) : 0;
        var expectedUsed = usedBefore;
        _rpc('pagarFaturaAtualSaldo',[cardId,dt,accountId,anoRef,mesRef,amountPay]).then(function(res){
          clearTimeout(loadingGuard);
          if(!res.ok){
            finishLoading_(false);
            _toast('Erro: '+(res.error&&res.error.message),'error'); return;
          }
          var totalPagoAtual = (res.data && res.data.total_pago) || 0;
          if (totalPagoAtual <= 0) {
            finishLoading_(false);
            _toast((res.data && res.data.message) || 'Fatura vigente sem valor para pagamento.', 'warn');
            return;
          }
          var valorEmAbertoAtual = (res.data && res.data.valor_em_aberto) || 0;
          _syncAfterCardPayment(cardId, totalPagoAtual);
          var expectedAfter = cardBefore ? Math.max(0, usedBefore - totalPagoAtual) : expectedUsed;
          _waitPaymentSync_(cardId, expectedAfter, function() {
            finishLoading_(true);
            _closeModal();
            var msgExtraAtual = valorEmAbertoAtual > 0.01 ? ' | Pendente: ' + _brl(valorEmAbertoAtual) : '';
            _toast('Pagamento registrado! ' + _brl(totalPagoAtual) + msgExtraAtual, valorEmAbertoAtual > 0.01 ? 'warn' : 'success');
            if(_store.cartaoDetalhe && _store.cartaoDetalhe.id){
              _rpc('getCartaoDetalhe',[_store.cartaoDetalhe.id]).then(function(r){
                if(r.ok){
                  _store.cartaoDetalhe=r.data.cartao;
                  _store.faturas=r.data.faturas||[];
                  _store.faturaVigente=r.data.fatura_vigente||null;
                  _renderDetalhe(r.data.cartao,r.data.faturas,r.data.kpis);
                }
              });
            } else {
              CartApp.refresh();
            }
          });
        });
      },

      submitPagarFatura: function() {
        var id=((document.getElementById('pfId')||{}).value||'');
        var cardId=((document.getElementById('pfCardId')||{}).value||'');
        var anoRef=parseInt(((document.getElementById('pfAnoRef')||{}).value)||APP.year);
        var mesRef=parseInt(((document.getElementById('pfMesRef')||{}).value)||APP.month);
        var amountRaw=((document.getElementById('pfAmount')||{}).value||'').trim();
        var amountPay = (typeof parseAmountInput_ === 'function') ? parseAmountInput_(amountRaw) : parseFloat(amountRaw.replace(',','.'));
        var dt=(document.getElementById('pfDt')||{}).value||_hoje();
        var accountId=((document.getElementById('pfAccount')||{}).value||'');
        var btn = document.querySelector('#modal-body button[onclick="CartApp.submitPagarFatura()"]');
        if(!id && !cardId) return;
        if(!accountId){ _toast('Selecione a conta que vai pagar a fatura.','warn'); return; }
        if (!isFinite(amountPay) || amountPay <= 0) { _toast('Informe um valor valido para pagamento.', 'warn'); return; }
        if (btn) { btn.disabled = true; btn.textContent = 'Confirmando...'; }
        showLoading();
        var finished = false;
        function finishLoading_(keepButtonDisabled) {
          if (finished) return;
          finished = true;
          hideLoading();
          if (btn && !keepButtonDisabled) { btn.disabled = false; btn.textContent = 'Confirmar pagamento'; }
        }
        var loadingGuard = setTimeout(function() {
          finishLoading_(false);
          _toast('Processamento demorou mais que o esperado. Atualize a tela para conferir o status.', 'warn');
        }, 12000);
        // Se nao tem cardId, tenta extrair da fatura no store
        if (!cardId) {
          var fatSel = (_store.faturas || []).find(function (f) { return f.id_fatura === id; });
          if (fatSel) cardId = String(fatSel.id_cartao || '');
        }
        var cardBefore = _store.cartoes.find(function(c){ return String(c.id) === String(cardId); }) || _store.cartaoDetalhe || null;
        var usedBefore = cardBefore ? (parseFloat(cardBefore.limite_usado) || 0) : 0;
        // Usa pagarFaturaAtualSaldo para suportar pagamento parcial
        _rpc('pagarFaturaAtualSaldo',[cardId,dt,accountId,anoRef,mesRef,amountPay]).then(function(res){
          clearTimeout(loadingGuard);
          if(!res.ok){
            finishLoading_(false);
            _toast('Erro: '+(res.error&&res.error.message),'error'); return;
          }
          var totalPagoAtual = (res.data && res.data.total_pago) || 0;
          var valorEmAberto = (res.data && res.data.valor_em_aberto) || 0;
          if (totalPagoAtual <= 0) {
            finishLoading_(false);
            _toast((res.data && res.data.message) || 'Fatura sem valor para pagamento.', 'warn');
            return;
          }
          _syncAfterCardPayment(cardId, totalPagoAtual);
          var expectedAfter = cardBefore ? Math.max(0, usedBefore - totalPagoAtual) : usedBefore;
          _waitPaymentSync_(cardId, expectedAfter, function() {
            finishLoading_(true);
            _closeModal();
            var msgExtra = valorEmAberto > 0.01 ? ' | Pendente: ' + _brl(valorEmAberto) : '';
            _toast('Pagamento registrado! ' + _brl(totalPagoAtual) + msgExtra, valorEmAberto > 0.01 ? 'warn' : 'success');
            if(_store.cartaoDetalhe && _store.cartaoDetalhe.id){
              _rpc('getCartaoDetalhe',[_store.cartaoDetalhe.id]).then(function(r){
                if(r.ok){
                  _store.cartaoDetalhe=r.data.cartao;
                  _store.faturas=r.data.faturas||[];
                  _store.faturaVigente=r.data.fatura_vigente||null;
                  _renderDetalhe(r.data.cartao,r.data.faturas,r.data.kpis);
                }
              });
            } else {
              CartApp.refresh();
            }
          });
        });
      },

      onSearch: function(q) {
        clearTimeout(_searchTimer);
        _searchTimer=setTimeout(function(){ _store.searchQuery=q; _renderList(); },250);
      },

      filterStatus: function(s) {
        _store.filterStatus=s;
        var tA=document.getElementById('cart-tab-ativos');
        var tR=document.getElementById('cart-tab-arq');
        if(tA){tA.style.background=s==='ativos'?'rgba(91,95,239,.9)':'transparent';tA.style.color=s==='ativos'?'white':'#8892a0';}
        if(tR){tR.style.background=s==='arquivados'?'rgba(91,95,239,.9)':'transparent';tR.style.color=s==='arquivados'?'white':'#8892a0';}
        _renderList();
      },

      onSort: function(v) { _store.sortBy=v; _renderList(); },

      // Permite verificar externamente se há dados em memória
      _store_hasData: function() { return _store.cartoes && _store.cartoes.length > 0; }
    };

    // Polling com backoff exponencial: começa em 20s, sobe até 2min em caso de falhas,
    // volta ao normal quando a conexão se restabelece.
    function _pollStart() {
      clearTimeout(_pollTimer);
      _pollFailCount = 0;
      _pollBackoffMultiplier = 1;

      // Ao retornar do background (aba ativa novamente), atualiza imediatamente
      document.addEventListener('visibilitychange', function() {
        if (!document.hidden && _isRouteCartoes()) {
          clearTimeout(_pollTimer);
          CartApp.refresh();
          _schedulePoll();
        }
      });

      _schedulePoll();
    }

    function _schedulePoll() {
      clearTimeout(_pollTimer);
      // Backoff: 20s base, dobra a cada falha até 120s
      var interval = Math.min(_pollInterval * _pollBackoffMultiplier, _pollMaxInterval);
      _pollTimer = setTimeout(function() {
        if (!_isRouteCartoes()) return; // parou de ser a rota ativa
        if (document.hidden) {
          _schedulePoll(); // reagenda sem fazer request
          return;
        }
        CartApp.refresh();
        // Ajusta backoff
        if (_pollFailCount > 0) {
          _pollBackoffMultiplier = Math.min(_pollBackoffMultiplier * 2, 6); // máx 6x = 120s
        } else {
          _pollBackoffMultiplier = 1; // volta ao normal
        }
        _schedulePoll();
      }, interval);
    }
  } // fim _cartoesDefineCartApp

</script>
